<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>sqlalchemy.orm.decl_api - Docs</title>
    <link rel="index" title="Index" href="../../../genindex.html" /><link rel="search" title="Search" href="../../../search.html" />
  <script>
    const isDarkTheme = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
    const sessionTheme = sessionStorage['_theme']
    if (sessionTheme) {
      document.documentElement.classList.add(sessionTheme)
    } else if (isDarkTheme) {
      document.documentElement.classList.add('dark')
    }
  </script><link rel="shortcut icon" href="../../../_static/logo.png"/><link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=aecf457f" />
    <link rel="stylesheet" type="text/css" href="../../../_static/shibuya.css?v=2981b36d" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
    <link media="print" rel="stylesheet" type="text/css" href="../../../_static/print.css?v=ee381b95" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/custom.css?v=8df29b6b" />
    <style>
:root {
  --sy-f-sys:-apple-system, BlinkMacSystemFont, Segoe UI, Oxygen, Ubuntu, Droid Sans, Helvetica Neue;--sy-f-cjk:PingFang SC, Hiragino Sans GB, Droid Sans Fallback, Microsoft YaHei;--sy-f-heading:var(--sy-f-sys), var(--sy-f-cjk), sans-serif;--sy-f-text:var(--sy-f-sys), var(--sy-f-cjk), sans-serif;--sy-f-mono:Menlo, Monaco, Consolas, "Courier New", monospace;--sy-c-divider:rgba(var(--sy-rc-text), 0.1);--sy-c-divider-weak:rgba(var(--sy-rc-text), 0.05);--sy-c-border:rgba(var(--sy-rc-text), 0.14);--sy-s-banner-height:0rem;--sy-s-navbar-height:56px;--sy-s-offset-top:calc(var(--sy-s-navbar-height) + var(--sy-s-banner-height));--sy-c-link:rgb(var(--sy-rc-theme));--sy-c-link-weak:rgba(var(--sy-rc-theme), 0.86);
  --sy-rc-theme:245, 0, 87;--sy-rc-bg:255, 255, 255;--sy-rc-invert:245, 0, 87;--sy-rc-text:245, 0, 87;--sy-c-bg:#fff;--sy-c-bg-weak:0, 0, 0;--sy-c-text:#000000;--sy-c-text-weak:#f50057;--sy-c-heading:#f50057;--sy-c-bold:#f50057;--sy-c-foot-text:#000000;--sy-c-foot-bg:#fafafa;--sy-c-foot-divider:#f50057;
}
@media (prefers-color-scheme: light) {
  :root {
    --sy-rc-theme:245, 0, 87;--sy-rc-bg:255, 255, 255;--sy-rc-invert:245, 0, 87;--sy-rc-text:245, 0, 87;--sy-c-bg:#fff;--sy-c-bg-weak:0, 0, 0;--sy-c-text:#000000;--sy-c-text-weak:#f50057;--sy-c-heading:#f50057;--sy-c-bold:#f50057;--sy-c-foot-text:#000000;--sy-c-foot-bg:#fafafa;--sy-c-foot-divider:#f50057;
  }
}
@media (prefers-color-scheme: dark) {
  :root {
    --sy-rc-theme:245, 0, 87;--sy-rc-bg:0, 0, 0;--sy-rc-invert:245, 0, 87;--sy-rc-text:245, 0, 87;--sy-c-bg:#f50057;--sy-c-bg-weak:#000000;--sy-c-text:#ebdddd;--sy-c-text-weak:#f50057;--sy-c-heading:#f50057;--sy-c-bold:#f50057;--sy-c-foot-text:#ebdddd;--sy-c-foot-bg:#000000;--sy-c-foot-divider:#f50057;
  }
}
html.light {
  --sy-rc-theme:245, 0, 87;--sy-rc-bg:255, 255, 255;--sy-rc-invert:245, 0, 87;--sy-rc-text:245, 0, 87;--sy-c-bg:#fff;--sy-c-bg-weak:0, 0, 0;--sy-c-text:#000000;--sy-c-text-weak:#f50057;--sy-c-heading:#f50057;--sy-c-bold:#f50057;--sy-c-foot-text:#000000;--sy-c-foot-bg:#fafafa;--sy-c-foot-divider:#f50057;
}
html.dark {
  --sy-rc-theme:245, 0, 87;--sy-rc-bg:0, 0, 0;--sy-rc-invert:245, 0, 87;--sy-rc-text:245, 0, 87;--sy-c-bg:#f50057;--sy-c-bg-weak:#000000;--sy-c-text:#ebdddd;--sy-c-text-weak:#f50057;--sy-c-heading:#f50057;--sy-c-bold:#f50057;--sy-c-foot-text:#ebdddd;--sy-c-foot-bg:#000000;--sy-c-foot-divider:#f50057;
}
</style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --sy-f-heading: Inter, var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
}
</style>
    <meta property="og:type" content="website"/><meta property="og:title" content="sqlalchemy.orm.decl_api"/>
<meta name="twitter:card" content="summary"/></head>
<body><div class="document"><div class="announcement">
    <div class="announcement-inner">
      <p>This documentation is currently under development.</p>
      <button class="announcement-close" aria-label="Close announcement">
        <i class="i-icon close"></i>
      </button>
    </div>
  </div><div class="sy-head">
  <div class="sy-head-blur"></div>
  <div class="sy-head-inner sy-container mx-auto">
    <a class="sy-head-brand mr-4" href="/">
      <img class="light-logo" src="../../../_static/logo.png" alt="advanced_alchemy" height="28" />
      <img class="dark-logo" src="../../../_static/logo.png" alt="advanced_alchemy" height="28" />
      <strong>advanced_alchemy</strong>
    </a>
    <div class="sy-head-links" id="NavLinks">
      <nav class="sy-head-nav">

<ul><li class="link">
          <a href="https://advanced-alchemy.jolt.rs"><span>Home</span><i class="i-icon external-link"></i></a>
        </li><li class="link">
          <a href="https://docs.advanced-alchemy.jolt.rs"><span>Docs</span><i class="i-icon external-link"></i></a>
        </li><li class="link">
          <a href="https://github.com/jolt-org/advanced-alchemy"><span>Code</span><i class="i-icon external-link"></i></a>
        </li></ul></nav>
      <div class="sy-head-extra flex items-center print:hidden"><form class="searchbox flex items-center" action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <kbd>/</kbd>
</form>
        
        
        <div class="sy-head-social flex items-center">
            <a class="flex items-center" href="https://github.com/jolt-org/advanced-alchemy" aria-label="GitHub">
              <i class="i-icon github"></i>
            </a>
        </div>
      </div>
    </div>
    <div class="sy-head-actions flex items-center shrink-0 print:hidden">
      <button class="js-theme theme-switch flex items-center" data-aria-light="Switch to dark mode" data-aria-dark="Switch to light mode">
        <i class="i-icon theme-icon"></i>
      </button>
      <button class="md:hidden flex items-center js-menu" aria-label="Menu" type="button" aria-controls="NavLinks" aria-expanded="false">
        <div class="hamburger">
          <span class="hamburger_1"></span>
          <span class="hamburger_2 -translate-x-2"></span>
          <span class="hamburger_3 -translate-x-1"></span>
        </div>
      </button>
    </div>
  </div>
</div>
<div class="sy-page sy-container flex mx-auto">
  <aside id="lside" class="sy-lside md:w-72 md:shrink-0 print:hidden">
    <div class="sy-lside-inner md:sticky">
      <div class="sy-scrollbar p-6">
        <div class="globaltoc" data-expand-depth="0"><p class="caption" role="heading"><span class="caption-text">Advanced Alchemy Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../usage/index.html">Usage</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/placeholder.html">Placeholder</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/index.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/base.html">base</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/exceptions.html">exceptions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/filters.html">filters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/operations.html">operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/repository.html">repositories</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/types.html">types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/alembic/index.html">alembic</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/alembic/commands.html">commands</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/alembic/templates/asyncio/index.html">asyncio</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../reference/alembic/templates/asyncio/alembic-ini.html">alembic.ini</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../reference/alembic/templates/asyncio/env.html">env</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../reference/alembic/templates/asyncio/script-py.html">script.py</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/alembic/templates/sync/index.html">sync</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../reference/alembic/templates/sync/alembic-ini.html">alembic.ini</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../reference/alembic/templates/sync/env.html">env</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../reference/alembic/templates/sync/script-py.html">script.py</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/config/index.html">config</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/config/asyncio.html">asyncio</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/config/common.html">common</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/config/engine.html">engine</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/config/sync.html">sync</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/config/types.html">types</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/extensions/index.html">extensions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/extensions/litestar/index.html">litestar</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../reference/extensions/litestar/alembic.html">alembic</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../reference/extensions/litestar/cli.html">cli</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../reference/extensions/litestar/dto.html">dto</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../reference/extensions/litestar/plugins/index.html">plugins</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../reference/extensions/litestar/plugins/serialization.html">serialization</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../reference/extensions/litestar/plugins/init/plugin.html">plugin</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../reference/extensions/litestar/plugins/init/config/asyncio.html">asyncio</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../reference/extensions/litestar/plugins/init/config/common.html">common</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../reference/extensions/litestar/plugins/init/config/engine.html">engine</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../reference/extensions/litestar/plugins/init/config/sync.html">sync</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../reference/extensions/litestar/plugins/init/config/types.html">types</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/extensions/sanic.html">sanic</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/extensions/starlette.html">starlette</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contribution-guide.html">Contribution guide</a></li>
</ul>

        </div>
      </div>
      
    </div>
  </aside>
  <div class="lside-overlay js-menu" role="button" aria-label="Close left sidebar" aria-controls="lside" aria-expanded="false"></div>
  <aside id="rside" class="sy-rside pb-3 w-64 shrink-0 order-last">
    <button class="rside-close js-menu xl:hidden" aria-label="Close Table of Contents" type="button" aria-controls="rside" aria-expanded="false">
      <i class="i-icon close"></i>
    </button>
    <div class="sy-scrollbar sy-rside-inner px-6 xl:top-16 xl:sticky xl:pl-0 pt-6 pb-4"><a class="js-repo-stats repo-stats flex items-center" href="https://github.com/jolt-org/advanced-alchemy"
  data-type="github" data-user="jolt-org" data-repo="advanced-alchemy">
  <span class="w-8 flex items-center justify-around shrink-0 text-2xl">
    <i class="i-icon github"></i>
  </span>
  <span class="flex-grow px-2">
    <span>jolt-org/advanced-alchemy</span>
    <span class="flex text-sm repo-stats-count">
      <span class="flex items-center pr-3">
        <i class="i-icon star"></i>
        <strong class="js-repo-stars ml-1">0</strong>
      </span>
      <span class="flex items-center">
        <i class="i-icon git-fork"></i>
        <strong class="js-repo-forks ml-1">0</strong>
      </span>
    </span>
  </span>
</a><div id="ethical-ad-placement" data-ea-publisher="readthedocs"></div>
    </div>
  </aside>
  <div class="rside-overlay js-menu" role="button" aria-label="Close Table of Contents" aria-controls="rside" aria-expanded="false"></div>
  <main class="sy-main w-full max-sm:max-w-full print:pt-6">
    <div class="sy-breadcrumbs" role="navigation">
  <div class="sy-breadcrumbs-inner flex items-center">
    <div class="md:hidden mr-3">
      <button class="js-menu" aria-label="Menu" type="button" aria-controls="lside" aria-expanded="false">
        <i class="i-icon menu"></i>
      </button>
    </div>
    <ul class="flex-1">
      
      
      <li><a href="../../../index.html">advanced_alchemy</a><span>/</span></li>
      
      <li><a href="../../index.html">Module code</a><span>/</span></li>
      
      <li><strong>sqlalchemy.orm.decl_api</strong></li>
      
      
    </ul>
    <div class="xl:hidden ml-1">
      <button class="js-menu" aria-label="Show table of contents" type="button" aria-controls="rside"
        aria-expanded="false">
        <i class="i-icon outdent"></i>
      </button>
    </div>
  </div>
</div>
    <div class="flex flex-col break-words justify-between">
      <div class="min-w-0 max-w-6xl px-6 pb-6 pt-8 xl:px-12">
        <article class="yue" role="main">
          <h1>Source code for sqlalchemy.orm.decl_api</h1><div class="highlight"><pre>
<span></span><span id="1-1"><span class="c1"># orm/declarative/api.py</span>
</span><span id="1-2"><span class="c1"># Copyright (C) 2005-2023 the SQLAlchemy authors and contributors</span>
</span><span id="1-3"><span class="c1"># &lt;see AUTHORS file&gt;</span>
</span><span id="1-4"><span class="c1">#</span>
</span><span id="1-5"><span class="c1"># This module is part of SQLAlchemy and is released under</span>
</span><span id="1-6"><span class="c1"># the MIT License: https://www.opensource.org/licenses/mit-license.php</span>
</span><span id="1-7">
</span><span id="1-8"><span class="sd">&quot;&quot;&quot;Public API functions and helpers for declarative.&quot;&quot;&quot;</span>
</span><span id="1-9">
</span><span id="1-10"><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
</span><span id="1-11">
</span><span id="1-12"><span class="kn">import</span> <span class="nn">itertools</span>
</span><span id="1-13"><span class="kn">import</span> <span class="nn">re</span>
</span><span id="1-14"><span class="kn">import</span> <span class="nn">typing</span>
</span><span id="1-15"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
</span><span id="1-16"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span>
</span><span id="1-17"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">cast</span>
</span><span id="1-18"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">ClassVar</span>
</span><span id="1-19"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span>
</span><span id="1-20"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">FrozenSet</span>
</span><span id="1-21"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Generic</span>
</span><span id="1-22"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Iterable</span>
</span><span id="1-23"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Iterator</span>
</span><span id="1-24"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Mapping</span>
</span><span id="1-25"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
</span><span id="1-26"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">overload</span>
</span><span id="1-27"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Set</span>
</span><span id="1-28"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span>
</span><span id="1-29"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Type</span>
</span><span id="1-30"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span>
</span><span id="1-31"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TypeVar</span>
</span><span id="1-32"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span>
</span><span id="1-33"><span class="kn">import</span> <span class="nn">weakref</span>
</span><span id="1-34">
</span><span id="1-35"><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">attributes</span>
</span><span id="1-36"><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">clsregistry</span>
</span><span id="1-37"><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">instrumentation</span>
</span><span id="1-38"><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">interfaces</span>
</span><span id="1-39"><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">mapperlib</span>
</span><span id="1-40"><span class="kn">from</span> <span class="nn">._orm_constructors</span> <span class="kn">import</span> <span class="n">composite</span>
</span><span id="1-41"><span class="kn">from</span> <span class="nn">._orm_constructors</span> <span class="kn">import</span> <span class="n">deferred</span>
</span><span id="1-42"><span class="kn">from</span> <span class="nn">._orm_constructors</span> <span class="kn">import</span> <span class="n">mapped_column</span>
</span><span id="1-43"><span class="kn">from</span> <span class="nn">._orm_constructors</span> <span class="kn">import</span> <span class="n">relationship</span>
</span><span id="1-44"><span class="kn">from</span> <span class="nn">._orm_constructors</span> <span class="kn">import</span> <span class="n">synonym</span>
</span><span id="1-45"><span class="kn">from</span> <span class="nn">.attributes</span> <span class="kn">import</span> <span class="n">InstrumentedAttribute</span>
</span><span id="1-46"><span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="n">_inspect_mapped_class</span>
</span><span id="1-47"><span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="n">_is_mapped_class</span>
</span><span id="1-48"><span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="n">Mapped</span>
</span><span id="1-49"><span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="n">ORMDescriptor</span>
</span><span id="1-50"><span class="kn">from</span> <span class="nn">.decl_base</span> <span class="kn">import</span> <span class="n">_add_attribute</span>
</span><span id="1-51"><span class="kn">from</span> <span class="nn">.decl_base</span> <span class="kn">import</span> <span class="n">_as_declarative</span>
</span><span id="1-52"><span class="kn">from</span> <span class="nn">.decl_base</span> <span class="kn">import</span> <span class="n">_ClassScanMapperConfig</span>
</span><span id="1-53"><span class="kn">from</span> <span class="nn">.decl_base</span> <span class="kn">import</span> <span class="n">_declarative_constructor</span>
</span><span id="1-54"><span class="kn">from</span> <span class="nn">.decl_base</span> <span class="kn">import</span> <span class="n">_DeferredMapperConfig</span>
</span><span id="1-55"><span class="kn">from</span> <span class="nn">.decl_base</span> <span class="kn">import</span> <span class="n">_del_attribute</span>
</span><span id="1-56"><span class="kn">from</span> <span class="nn">.decl_base</span> <span class="kn">import</span> <span class="n">_mapper</span>
</span><span id="1-57"><span class="kn">from</span> <span class="nn">.descriptor_props</span> <span class="kn">import</span> <span class="n">Composite</span>
</span><span id="1-58"><span class="kn">from</span> <span class="nn">.descriptor_props</span> <span class="kn">import</span> <span class="n">Synonym</span>
</span><span id="1-59"><span class="kn">from</span> <span class="nn">.descriptor_props</span> <span class="kn">import</span> <span class="n">Synonym</span> <span class="k">as</span> <span class="n">_orm_synonym</span>
</span><span id="1-60"><span class="kn">from</span> <span class="nn">.mapper</span> <span class="kn">import</span> <span class="n">Mapper</span>
</span><span id="1-61"><span class="kn">from</span> <span class="nn">.properties</span> <span class="kn">import</span> <span class="n">MappedColumn</span>
</span><span id="1-62"><span class="kn">from</span> <span class="nn">.relationships</span> <span class="kn">import</span> <span class="n">RelationshipProperty</span>
</span><span id="1-63"><span class="kn">from</span> <span class="nn">.state</span> <span class="kn">import</span> <span class="n">InstanceState</span>
</span><span id="1-64"><span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">exc</span>
</span><span id="1-65"><span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">inspection</span>
</span><span id="1-66"><span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">util</span>
</span><span id="1-67"><span class="kn">from</span> <span class="nn">..sql</span> <span class="kn">import</span> <span class="n">sqltypes</span>
</span><span id="1-68"><span class="kn">from</span> <span class="nn">..sql.base</span> <span class="kn">import</span> <span class="n">_NoArg</span>
</span><span id="1-69"><span class="kn">from</span> <span class="nn">..sql.elements</span> <span class="kn">import</span> <span class="n">SQLCoreOperations</span>
</span><span id="1-70"><span class="kn">from</span> <span class="nn">..sql.schema</span> <span class="kn">import</span> <span class="n">MetaData</span>
</span><span id="1-71"><span class="kn">from</span> <span class="nn">..sql.selectable</span> <span class="kn">import</span> <span class="n">FromClause</span>
</span><span id="1-72"><span class="kn">from</span> <span class="nn">..util</span> <span class="kn">import</span> <span class="n">hybridmethod</span>
</span><span id="1-73"><span class="kn">from</span> <span class="nn">..util</span> <span class="kn">import</span> <span class="n">hybridproperty</span>
</span><span id="1-74"><span class="kn">from</span> <span class="nn">..util</span> <span class="kn">import</span> <span class="n">typing</span> <span class="k">as</span> <span class="n">compat_typing</span>
</span><span id="1-75"><span class="kn">from</span> <span class="nn">..util.typing</span> <span class="kn">import</span> <span class="n">CallableReference</span>
</span><span id="1-76"><span class="kn">from</span> <span class="nn">..util.typing</span> <span class="kn">import</span> <span class="n">flatten_newtype</span>
</span><span id="1-77"><span class="kn">from</span> <span class="nn">..util.typing</span> <span class="kn">import</span> <span class="n">is_generic</span>
</span><span id="1-78"><span class="kn">from</span> <span class="nn">..util.typing</span> <span class="kn">import</span> <span class="n">is_literal</span>
</span><span id="1-79"><span class="kn">from</span> <span class="nn">..util.typing</span> <span class="kn">import</span> <span class="n">is_newtype</span>
</span><span id="1-80"><span class="kn">from</span> <span class="nn">..util.typing</span> <span class="kn">import</span> <span class="n">Literal</span>
</span><span id="1-81"><span class="kn">from</span> <span class="nn">..util.typing</span> <span class="kn">import</span> <span class="n">Self</span>
</span><span id="1-82">
</span><span id="1-83"><span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span id="1-84">    <span class="kn">from</span> <span class="nn">._typing</span> <span class="kn">import</span> <span class="n">_O</span>
</span><span id="1-85">    <span class="kn">from</span> <span class="nn">._typing</span> <span class="kn">import</span> <span class="n">_RegistryType</span>
</span><span id="1-86">    <span class="kn">from</span> <span class="nn">.decl_base</span> <span class="kn">import</span> <span class="n">_DataclassArguments</span>
</span><span id="1-87">    <span class="kn">from</span> <span class="nn">.instrumentation</span> <span class="kn">import</span> <span class="n">ClassManager</span>
</span><span id="1-88">    <span class="kn">from</span> <span class="nn">.interfaces</span> <span class="kn">import</span> <span class="n">MapperProperty</span>
</span><span id="1-89">    <span class="kn">from</span> <span class="nn">.state</span> <span class="kn">import</span> <span class="n">InstanceState</span>  <span class="c1"># noqa</span>
</span><span id="1-90">    <span class="kn">from</span> <span class="nn">..sql._typing</span> <span class="kn">import</span> <span class="n">_TypeEngineArgument</span>
</span><span id="1-91">    <span class="kn">from</span> <span class="nn">..sql.type_api</span> <span class="kn">import</span> <span class="n">_MatchedOnType</span>
</span><span id="1-92">
</span><span id="1-93"><span class="n">_T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;_T&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">Any</span><span class="p">)</span>
</span><span id="1-94">
</span><span id="1-95"><span class="n">_TT</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;_TT&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">Any</span><span class="p">)</span>
</span><span id="1-96">
</span><span id="1-97"><span class="c1"># it&#39;s not clear how to have Annotated, Union objects etc. as keys here</span>
</span><span id="1-98"><span class="c1"># from a typing perspective so just leave it open ended for now</span>
</span><span id="1-99"><span class="n">_TypeAnnotationMapType</span> <span class="o">=</span> <span class="n">Mapping</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="s2">&quot;_TypeEngineArgument[Any]&quot;</span><span class="p">]</span>
</span><span id="1-100"><span class="n">_MutableTypeAnnotationMapType</span> <span class="o">=</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="s2">&quot;_TypeEngineArgument[Any]&quot;</span><span class="p">]</span>
</span><span id="1-101">
</span><span id="1-102"><span class="n">_DeclaredAttrDecorated</span> <span class="o">=</span> <span class="n">Callable</span><span class="p">[</span>
</span><span id="1-103">    <span class="o">...</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Mapped</span><span class="p">[</span><span class="n">_T</span><span class="p">],</span> <span class="n">ORMDescriptor</span><span class="p">[</span><span class="n">_T</span><span class="p">],</span> <span class="n">SQLCoreOperations</span><span class="p">[</span><span class="n">_T</span><span class="p">]]</span>
</span><span id="1-104"><span class="p">]</span>
</span><span id="1-105">
</span><span id="1-106">
</span><span id="1-107"><span class="k">def</span> <span class="nf">has_inherited_table</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="1-108"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Given a class, return True if any of the classes it inherits from has a</span>
</span><span id="1-109"><span class="sd">    mapped table, otherwise return False.</span>
</span><span id="1-110">
</span><span id="1-111"><span class="sd">    This is used in declarative mixins to build attributes that behave</span>
</span><span id="1-112"><span class="sd">    differently for the base class vs. a subclass in an inheritance</span>
</span><span id="1-113"><span class="sd">    hierarchy.</span>
</span><span id="1-114">
</span><span id="1-115"><span class="sd">    .. seealso::</span>
</span><span id="1-116">
</span><span id="1-117"><span class="sd">        :ref:`decl_mixin_inheritance`</span>
</span><span id="1-118">
</span><span id="1-119"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-120">    <span class="k">for</span> <span class="n">class_</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
</span><span id="1-121">        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">class_</span><span class="p">,</span> <span class="s2">&quot;__table__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-122">            <span class="k">return</span> <span class="kc">True</span>
</span><span id="1-123">    <span class="k">return</span> <span class="kc">False</span>
</span><span id="1-124">
</span><span id="1-125">
</span><span id="1-126"><span class="k">class</span> <span class="nc">_DynamicAttributesType</span><span class="p">(</span><span class="nb">type</span><span class="p">):</span>
</span><span id="1-127">    <span class="k">def</span> <span class="fm">__setattr__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-128">        <span class="k">if</span> <span class="s2">&quot;__mapper__&quot;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
</span><span id="1-129">            <span class="n">_add_attribute</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span id="1-130">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-131">            <span class="nb">type</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span id="1-132">
</span><span id="1-133">    <span class="k">def</span> <span class="fm">__delattr__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-134">        <span class="k">if</span> <span class="s2">&quot;__mapper__&quot;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
</span><span id="1-135">            <span class="n">_del_attribute</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
</span><span id="1-136">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-137">            <span class="nb">type</span><span class="o">.</span><span class="fm">__delattr__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
</span><span id="1-138">
</span><span id="1-139">
</span><span id="1-140"><span class="k">class</span> <span class="nc">DeclarativeAttributeIntercept</span><span class="p">(</span>
</span><span id="1-141">    <span class="n">_DynamicAttributesType</span><span class="p">,</span>
</span><span id="1-142">    <span class="c1"># Inspectable is used only by the mypy plugin</span>
</span><span id="1-143">    <span class="n">inspection</span><span class="o">.</span><span class="n">Inspectable</span><span class="p">[</span><span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
</span><span id="1-144"><span class="p">):</span>
</span><span id="1-145"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Metaclass that may be used in conjunction with the</span>
</span><span id="1-146"><span class="sd">    :class:`_orm.DeclarativeBase` class to support addition of class</span>
</span><span id="1-147"><span class="sd">    attributes dynamically.</span>
</span><span id="1-148">
</span><span id="1-149"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-150">
</span><span id="1-151">
</span><span id="1-152"><span class="nd">@compat_typing</span><span class="o">.</span><span class="n">dataclass_transform</span><span class="p">(</span>
</span><span id="1-153">    <span class="n">field_specifiers</span><span class="o">=</span><span class="p">(</span>
</span><span id="1-154">        <span class="n">MappedColumn</span><span class="p">,</span>
</span><span id="1-155">        <span class="n">RelationshipProperty</span><span class="p">,</span>
</span><span id="1-156">        <span class="n">Composite</span><span class="p">,</span>
</span><span id="1-157">        <span class="n">Synonym</span><span class="p">,</span>
</span><span id="1-158">        <span class="n">mapped_column</span><span class="p">,</span>
</span><span id="1-159">        <span class="n">relationship</span><span class="p">,</span>
</span><span id="1-160">        <span class="n">composite</span><span class="p">,</span>
</span><span id="1-161">        <span class="n">synonym</span><span class="p">,</span>
</span><span id="1-162">        <span class="n">deferred</span><span class="p">,</span>
</span><span id="1-163">    <span class="p">),</span>
</span><span id="1-164"><span class="p">)</span>
</span><span id="1-165"><span class="k">class</span> <span class="nc">DCTransformDeclarative</span><span class="p">(</span><span class="n">DeclarativeAttributeIntercept</span><span class="p">):</span>
</span><span id="1-166"><span class="w">    </span><span class="sd">&quot;&quot;&quot;metaclass that includes @dataclass_transforms&quot;&quot;&quot;</span>
</span><span id="1-167">
</span><span id="1-168">
</span><span id="1-169"><span class="k">class</span> <span class="nc">DeclarativeMeta</span><span class="p">(</span><span class="n">DeclarativeAttributeIntercept</span><span class="p">):</span>
</span><span id="1-170">    <span class="n">metadata</span><span class="p">:</span> <span class="n">MetaData</span>
</span><span id="1-171">    <span class="n">registry</span><span class="p">:</span> <span class="n">RegistryType</span>
</span><span id="1-172">
</span><span id="1-173">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="1-174">        <span class="bp">cls</span><span class="p">,</span> <span class="n">classname</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">bases</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">dict_</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span>
</span><span id="1-175">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-176">        <span class="c1"># use cls.__dict__, which can be modified by an</span>
</span><span id="1-177">        <span class="c1"># __init_subclass__() method (#7900)</span>
</span><span id="1-178">        <span class="n">dict_</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span>
</span><span id="1-179">
</span><span id="1-180">        <span class="c1"># early-consume registry from the initial declarative base,</span>
</span><span id="1-181">        <span class="c1"># assign privately to not conflict with subclass attributes named</span>
</span><span id="1-182">        <span class="c1"># &quot;registry&quot;</span>
</span><span id="1-183">        <span class="n">reg</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;_sa_registry&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="1-184">        <span class="k">if</span> <span class="n">reg</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-185">            <span class="n">reg</span> <span class="o">=</span> <span class="n">dict_</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;registry&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="1-186">            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">registry</span><span class="p">):</span>
</span><span id="1-187">                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span id="1-188">                    <span class="s2">&quot;Declarative base class has no &#39;registry&#39; attribute, &quot;</span>
</span><span id="1-189">                    <span class="s2">&quot;or registry is not a sqlalchemy.orm.registry() object&quot;</span>
</span><span id="1-190">                <span class="p">)</span>
</span><span id="1-191">            <span class="k">else</span><span class="p">:</span>
</span><span id="1-192">                <span class="bp">cls</span><span class="o">.</span><span class="n">_sa_registry</span> <span class="o">=</span> <span class="n">reg</span>
</span><span id="1-193">
</span><span id="1-194">        <span class="k">if</span> <span class="ow">not</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;__abstract__&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="1-195">            <span class="n">_as_declarative</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">dict_</span><span class="p">)</span>
</span><span id="1-196">        <span class="nb">type</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">classname</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">dict_</span><span class="p">)</span>
</span><span id="1-197">
</span><span id="1-198">
</span><span id="1-199"><span class="k">def</span> <span class="nf">synonym_for</span><span class="p">(</span>
</span><span id="1-200">    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">map_column</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-201"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">]],</span> <span class="n">Synonym</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
</span><span id="1-202"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Decorator that produces an :func:`_orm.synonym`</span>
</span><span id="1-203"><span class="sd">    attribute in conjunction with a Python descriptor.</span>
</span><span id="1-204">
</span><span id="1-205"><span class="sd">    The function being decorated is passed to :func:`_orm.synonym` as the</span>
</span><span id="1-206"><span class="sd">    :paramref:`.orm.synonym.descriptor` parameter::</span>
</span><span id="1-207">
</span><span id="1-208"><span class="sd">        class MyClass(Base):</span>
</span><span id="1-209"><span class="sd">            __tablename__ = &#39;my_table&#39;</span>
</span><span id="1-210">
</span><span id="1-211"><span class="sd">            id = Column(Integer, primary_key=True)</span>
</span><span id="1-212"><span class="sd">            _job_status = Column(&quot;job_status&quot;, String(50))</span>
</span><span id="1-213">
</span><span id="1-214"><span class="sd">            @synonym_for(&quot;job_status&quot;)</span>
</span><span id="1-215"><span class="sd">            @property</span>
</span><span id="1-216"><span class="sd">            def job_status(self):</span>
</span><span id="1-217"><span class="sd">                return &quot;Status: %s&quot; % self._job_status</span>
</span><span id="1-218">
</span><span id="1-219"><span class="sd">    The :ref:`hybrid properties &lt;mapper_hybrids&gt;` feature of SQLAlchemy</span>
</span><span id="1-220"><span class="sd">    is typically preferred instead of synonyms, which is a more legacy</span>
</span><span id="1-221"><span class="sd">    feature.</span>
</span><span id="1-222">
</span><span id="1-223"><span class="sd">    .. seealso::</span>
</span><span id="1-224">
</span><span id="1-225"><span class="sd">        :ref:`synonyms` - Overview of synonyms</span>
</span><span id="1-226">
</span><span id="1-227"><span class="sd">        :func:`_orm.synonym` - the mapper-level function</span>
</span><span id="1-228">
</span><span id="1-229"><span class="sd">        :ref:`mapper_hybrids` - The Hybrid Attribute extension provides an</span>
</span><span id="1-230"><span class="sd">        updated approach to augmenting attribute behavior more flexibly than</span>
</span><span id="1-231"><span class="sd">        can be achieved with synonyms.</span>
</span><span id="1-232">
</span><span id="1-233"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-234">
</span><span id="1-235">    <span class="k">def</span> <span class="nf">decorate</span><span class="p">(</span><span class="n">fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Synonym</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span id="1-236">        <span class="k">return</span> <span class="n">_orm_synonym</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">map_column</span><span class="o">=</span><span class="n">map_column</span><span class="p">,</span> <span class="n">descriptor</span><span class="o">=</span><span class="n">fn</span><span class="p">)</span>
</span><span id="1-237">
</span><span id="1-238">    <span class="k">return</span> <span class="n">decorate</span>
</span><span id="1-239">
</span><span id="1-240">
</span><span id="1-241"><span class="k">class</span> <span class="nc">_declared_attr_common</span><span class="p">:</span>
</span><span id="1-242">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="1-243">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-244">        <span class="n">fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span>
</span><span id="1-245">        <span class="n">cascading</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="1-246">        <span class="n">quiet</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="1-247">    <span class="p">):</span>
</span><span id="1-248">        <span class="c1"># suppport</span>
</span><span id="1-249">        <span class="c1"># @declared_attr</span>
</span><span id="1-250">        <span class="c1"># @classmethod</span>
</span><span id="1-251">        <span class="c1"># def foo(cls) -&gt; Mapped[thing]:</span>
</span><span id="1-252">        <span class="c1">#    ...</span>
</span><span id="1-253">        <span class="c1"># which seems to help typing tools interpret the fn as a classmethod</span>
</span><span id="1-254">        <span class="c1"># for situations where needed</span>
</span><span id="1-255">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="nb">classmethod</span><span class="p">):</span>
</span><span id="1-256">            <span class="n">fn</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="vm">__func__</span>  <span class="c1"># type: ignore</span>
</span><span id="1-257">
</span><span id="1-258">        <span class="bp">self</span><span class="o">.</span><span class="n">fget</span> <span class="o">=</span> <span class="n">fn</span>
</span><span id="1-259">        <span class="bp">self</span><span class="o">.</span><span class="n">_cascading</span> <span class="o">=</span> <span class="n">cascading</span>
</span><span id="1-260">        <span class="bp">self</span><span class="o">.</span><span class="n">_quiet</span> <span class="o">=</span> <span class="n">quiet</span>
</span><span id="1-261">        <span class="bp">self</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">fn</span><span class="o">.</span><span class="vm">__doc__</span>
</span><span id="1-262">
</span><span id="1-263">    <span class="k">def</span> <span class="nf">_collect_return_annotation</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
</span><span id="1-264">        <span class="k">return</span> <span class="n">util</span><span class="o">.</span><span class="n">get_annotations</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fget</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;return&quot;</span><span class="p">)</span>
</span><span id="1-265">
</span><span id="1-266">    <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">object</span><span class="p">],</span> <span class="n">owner</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span id="1-267">        <span class="c1"># the declared_attr needs to make use of a cache that exists</span>
</span><span id="1-268">        <span class="c1"># for the span of the declarative scan_attributes() phase.</span>
</span><span id="1-269">        <span class="c1"># to achieve this we look at the class manager that&#39;s configured.</span>
</span><span id="1-270">
</span><span id="1-271">        <span class="c1"># note this method should not be called outside of the declarative</span>
</span><span id="1-272">        <span class="c1"># setup phase</span>
</span><span id="1-273">
</span><span id="1-274">        <span class="bp">cls</span> <span class="o">=</span> <span class="n">owner</span>
</span><span id="1-275">        <span class="n">manager</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">opt_manager_of_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
</span><span id="1-276">        <span class="k">if</span> <span class="n">manager</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-277">            <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^__.+__$&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fget</span><span class="o">.</span><span class="vm">__name__</span><span class="p">):</span>
</span><span id="1-278">                <span class="c1"># if there is no manager at all, then this class hasn&#39;t been</span>
</span><span id="1-279">                <span class="c1"># run through declarative or mapper() at all, emit a warning.</span>
</span><span id="1-280">                <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span id="1-281">                    <span class="s2">&quot;Unmanaged access of declarative attribute </span><span class="si">%s</span><span class="s2"> from &quot;</span>
</span><span id="1-282">                    <span class="s2">&quot;non-mapped class </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fget</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
</span><span id="1-283">                <span class="p">)</span>
</span><span id="1-284">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fget</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
</span><span id="1-285">        <span class="k">elif</span> <span class="n">manager</span><span class="o">.</span><span class="n">is_mapped</span><span class="p">:</span>
</span><span id="1-286">            <span class="c1"># the class is mapped, which means we&#39;re outside of the declarative</span>
</span><span id="1-287">            <span class="c1"># scan setup, just run the function.</span>
</span><span id="1-288">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">fget</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
</span><span id="1-289">
</span><span id="1-290">        <span class="c1"># here, we are inside of the declarative scan.  use the registry</span>
</span><span id="1-291">        <span class="c1"># that is tracking the values of these attributes.</span>
</span><span id="1-292">        <span class="n">declarative_scan</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">declarative_scan</span><span class="p">()</span>
</span><span id="1-293">
</span><span id="1-294">        <span class="c1"># assert that we are in fact in the declarative scan</span>
</span><span id="1-295">        <span class="k">assert</span> <span class="n">declarative_scan</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="1-296">
</span><span id="1-297">        <span class="n">reg</span> <span class="o">=</span> <span class="n">declarative_scan</span><span class="o">.</span><span class="n">declared_attr_reg</span>
</span><span id="1-298">
</span><span id="1-299">        <span class="k">if</span> <span class="bp">self</span> <span class="ow">in</span> <span class="n">reg</span><span class="p">:</span>
</span><span id="1-300">            <span class="k">return</span> <span class="n">reg</span><span class="p">[</span><span class="bp">self</span><span class="p">]</span>  <span class="c1"># type: ignore</span>
</span><span id="1-301">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-302">            <span class="n">reg</span><span class="p">[</span><span class="bp">self</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fget</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
</span><span id="1-303">            <span class="k">return</span> <span class="n">obj</span>  <span class="c1"># type: ignore</span>
</span><span id="1-304">
</span><span id="1-305">
</span><span id="1-306"><span class="k">class</span> <span class="nc">_declared_directive</span><span class="p">(</span><span class="n">_declared_attr_common</span><span class="p">,</span> <span class="n">Generic</span><span class="p">[</span><span class="n">_T</span><span class="p">]):</span>
</span><span id="1-307">    <span class="c1"># see mapping_api.rst for docstring</span>
</span><span id="1-308">
</span><span id="1-309">    <span class="k">if</span> <span class="n">typing</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span id="1-310">
</span><span id="1-311">        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="1-312">            <span class="bp">self</span><span class="p">,</span>
</span><span id="1-313">            <span class="n">fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">_T</span><span class="p">],</span>
</span><span id="1-314">            <span class="n">cascading</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="1-315">        <span class="p">):</span>
</span><span id="1-316">            <span class="o">...</span>
</span><span id="1-317">
</span><span id="1-318">        <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">object</span><span class="p">],</span> <span class="n">owner</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_T</span><span class="p">:</span>
</span><span id="1-319">            <span class="o">...</span>
</span><span id="1-320">
</span><span id="1-321">        <span class="k">def</span> <span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-322">            <span class="o">...</span>
</span><span id="1-323">
</span><span id="1-324">        <span class="k">def</span> <span class="fm">__delete__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-325">            <span class="o">...</span>
</span><span id="1-326">
</span><span id="1-327">        <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">_TT</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">_declared_directive</span><span class="p">[</span><span class="n">_TT</span><span class="p">]:</span>
</span><span id="1-328">            <span class="c1"># extensive fooling of mypy underway...</span>
</span><span id="1-329">            <span class="o">...</span>
</span><span id="1-330">
</span><span id="1-331">
</span><span id="1-332"><span class="k">class</span> <span class="nc">declared_attr</span><span class="p">(</span><span class="n">interfaces</span><span class="o">.</span><span class="n">_MappedAttribute</span><span class="p">[</span><span class="n">_T</span><span class="p">],</span> <span class="n">_declared_attr_common</span><span class="p">):</span>
</span><span id="1-333"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Mark a class-level method as representing the definition of</span>
</span><span id="1-334"><span class="sd">    a mapped property or Declarative directive.</span>
</span><span id="1-335">
</span><span id="1-336"><span class="sd">    :class:`_orm.declared_attr` is typically applied as a decorator to a class</span>
</span><span id="1-337"><span class="sd">    level method, turning the attribute into a scalar-like property that can be</span>
</span><span id="1-338"><span class="sd">    invoked from the uninstantiated class. The Declarative mapping process</span>
</span><span id="1-339"><span class="sd">    looks for these :class:`_orm.declared_attr` callables as it scans classes,</span>
</span><span id="1-340"><span class="sd">    and assumes any attribute marked with :class:`_orm.declared_attr` will be a</span>
</span><span id="1-341"><span class="sd">    callable that will produce an object specific to the Declarative mapping or</span>
</span><span id="1-342"><span class="sd">    table configuration.</span>
</span><span id="1-343">
</span><span id="1-344"><span class="sd">    :class:`_orm.declared_attr` is usually applicable to</span>
</span><span id="1-345"><span class="sd">    :ref:`mixins &lt;orm_mixins_toplevel&gt;`, to define relationships that are to be</span>
</span><span id="1-346"><span class="sd">    applied to different implementors of the class. It may also be used to</span>
</span><span id="1-347"><span class="sd">    define dynamically generated column expressions and other Declarative</span>
</span><span id="1-348"><span class="sd">    attributes.</span>
</span><span id="1-349">
</span><span id="1-350"><span class="sd">    Example::</span>
</span><span id="1-351">
</span><span id="1-352"><span class="sd">        class ProvidesUserMixin:</span>
</span><span id="1-353"><span class="sd">            &quot;A mixin that adds a &#39;user&#39; relationship to classes.&quot;</span>
</span><span id="1-354">
</span><span id="1-355"><span class="sd">            user_id: Mapped[int] = mapped_column(ForeignKey(&quot;user_table.id&quot;))</span>
</span><span id="1-356">
</span><span id="1-357"><span class="sd">            @declared_attr</span>
</span><span id="1-358"><span class="sd">            def user(cls) -&gt; Mapped[&quot;User&quot;]:</span>
</span><span id="1-359"><span class="sd">                return relationship(&quot;User&quot;)</span>
</span><span id="1-360">
</span><span id="1-361"><span class="sd">    When used with Declarative directives such as ``__tablename__``, the</span>
</span><span id="1-362"><span class="sd">    :meth:`_orm.declared_attr.directive` modifier may be used which indicates</span>
</span><span id="1-363"><span class="sd">    to :pep:`484` typing tools that the given method is not dealing with</span>
</span><span id="1-364"><span class="sd">    :class:`_orm.Mapped` attributes::</span>
</span><span id="1-365">
</span><span id="1-366"><span class="sd">        class CreateTableName:</span>
</span><span id="1-367"><span class="sd">            @declared_attr.directive</span>
</span><span id="1-368"><span class="sd">            def __tablename__(cls) -&gt; str:</span>
</span><span id="1-369"><span class="sd">                return cls.__name__.lower()</span>
</span><span id="1-370">
</span><span id="1-371"><span class="sd">    :class:`_orm.declared_attr` can also be applied directly to mapped</span>
</span><span id="1-372"><span class="sd">    classes, to allow for attributes that dynamically configure themselves</span>
</span><span id="1-373"><span class="sd">    on subclasses when using mapped inheritance schemes.   Below</span>
</span><span id="1-374"><span class="sd">    illustrates :class:`_orm.declared_attr` to create a dynamic scheme</span>
</span><span id="1-375"><span class="sd">    for generating the :paramref:`_orm.Mapper.polymorphic_identity` parameter</span>
</span><span id="1-376"><span class="sd">    for subclasses::</span>
</span><span id="1-377">
</span><span id="1-378"><span class="sd">        class Employee(Base):</span>
</span><span id="1-379"><span class="sd">            __tablename__ = &#39;employee&#39;</span>
</span><span id="1-380">
</span><span id="1-381"><span class="sd">            id: Mapped[int] = mapped_column(primary_key=True)</span>
</span><span id="1-382"><span class="sd">            type: Mapped[str] = mapped_column(String(50))</span>
</span><span id="1-383">
</span><span id="1-384"><span class="sd">            @declared_attr.directive</span>
</span><span id="1-385"><span class="sd">            def __mapper_args__(cls) -&gt; Dict[str, Any]:</span>
</span><span id="1-386"><span class="sd">                if cls.__name__ == &#39;Employee&#39;:</span>
</span><span id="1-387"><span class="sd">                    return {</span>
</span><span id="1-388"><span class="sd">                            &quot;polymorphic_on&quot;:cls.type,</span>
</span><span id="1-389"><span class="sd">                            &quot;polymorphic_identity&quot;:&quot;Employee&quot;</span>
</span><span id="1-390"><span class="sd">                    }</span>
</span><span id="1-391"><span class="sd">                else:</span>
</span><span id="1-392"><span class="sd">                    return {&quot;polymorphic_identity&quot;:cls.__name__}</span>
</span><span id="1-393">
</span><span id="1-394"><span class="sd">        class Engineer(Employee):</span>
</span><span id="1-395"><span class="sd">            pass</span>
</span><span id="1-396">
</span><span id="1-397"><span class="sd">    :class:`_orm.declared_attr` supports decorating functions that are</span>
</span><span id="1-398"><span class="sd">    explicitly decorated with ``@classmethod``. This is never necessary from a</span>
</span><span id="1-399"><span class="sd">    runtime perspective, however may be needed in order to support :pep:`484`</span>
</span><span id="1-400"><span class="sd">    typing tools that don&#39;t otherwise recognize the decorated function as</span>
</span><span id="1-401"><span class="sd">    having class-level behaviors for the ``cls`` parameter::</span>
</span><span id="1-402">
</span><span id="1-403"><span class="sd">        class SomethingMixin:</span>
</span><span id="1-404"><span class="sd">            x: Mapped[int]</span>
</span><span id="1-405"><span class="sd">            y: Mapped[int]</span>
</span><span id="1-406">
</span><span id="1-407"><span class="sd">            @declared_attr</span>
</span><span id="1-408"><span class="sd">            @classmethod</span>
</span><span id="1-409"><span class="sd">            def x_plus_y(cls) -&gt; Mapped[int]:</span>
</span><span id="1-410"><span class="sd">                return column_property(cls.x + cls.y)</span>
</span><span id="1-411">
</span><span id="1-412"><span class="sd">    .. versionadded:: 2.0 - :class:`_orm.declared_attr` can accommodate a</span>
</span><span id="1-413"><span class="sd">       function decorated with ``@classmethod`` to help with :pep:`484`</span>
</span><span id="1-414"><span class="sd">       integration where needed.</span>
</span><span id="1-415">
</span><span id="1-416">
</span><span id="1-417"><span class="sd">    .. seealso::</span>
</span><span id="1-418">
</span><span id="1-419"><span class="sd">        :ref:`orm_mixins_toplevel` - Declarative Mixin documentation with</span>
</span><span id="1-420"><span class="sd">        background on use patterns for :class:`_orm.declared_attr`.</span>
</span><span id="1-421">
</span><span id="1-422"><span class="sd">    &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>
</span><span id="1-423">
</span><span id="1-424">    <span class="k">if</span> <span class="n">typing</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span id="1-425">
</span><span id="1-426">        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="1-427">            <span class="bp">self</span><span class="p">,</span>
</span><span id="1-428">            <span class="n">fn</span><span class="p">:</span> <span class="n">_DeclaredAttrDecorated</span><span class="p">[</span><span class="n">_T</span><span class="p">],</span>
</span><span id="1-429">            <span class="n">cascading</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
</span><span id="1-430">        <span class="p">):</span>
</span><span id="1-431">            <span class="o">...</span>
</span><span id="1-432">
</span><span id="1-433">        <span class="k">def</span> <span class="fm">__set__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-434">            <span class="o">...</span>
</span><span id="1-435">
</span><span id="1-436">        <span class="k">def</span> <span class="fm">__delete__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-437">            <span class="o">...</span>
</span><span id="1-438">
</span><span id="1-439">        <span class="c1"># this is the Mapped[] API where at class descriptor get time we want</span>
</span><span id="1-440">        <span class="c1"># the type checker to see InstrumentedAttribute[_T].   However the</span>
</span><span id="1-441">        <span class="c1"># callable function prior to mapping in fact calls the given</span>
</span><span id="1-442">        <span class="c1"># declarative function that does not return InstrumentedAttribute</span>
</span><span id="1-443">        <span class="nd">@overload</span>
</span><span id="1-444">        <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span>
</span><span id="1-445">            <span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="n">owner</span><span class="p">:</span> <span class="n">Any</span>
</span><span id="1-446">        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InstrumentedAttribute</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span id="1-447">            <span class="o">...</span>
</span><span id="1-448">
</span><span id="1-449">        <span class="nd">@overload</span>
</span><span id="1-450">        <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="nb">object</span><span class="p">,</span> <span class="n">owner</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_T</span><span class="p">:</span>
</span><span id="1-451">            <span class="o">...</span>
</span><span id="1-452">
</span><span id="1-453">        <span class="k">def</span> <span class="fm">__get__</span><span class="p">(</span>
</span><span id="1-454">            <span class="bp">self</span><span class="p">,</span> <span class="n">instance</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">object</span><span class="p">],</span> <span class="n">owner</span><span class="p">:</span> <span class="n">Any</span>
</span><span id="1-455">        <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">InstrumentedAttribute</span><span class="p">[</span><span class="n">_T</span><span class="p">],</span> <span class="n">_T</span><span class="p">]:</span>
</span><span id="1-456">            <span class="o">...</span>
</span><span id="1-457">
</span><span id="1-458">    <span class="nd">@hybridmethod</span>
</span><span id="1-459">    <span class="k">def</span> <span class="nf">_stateful</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_stateful_declared_attr</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span id="1-460">        <span class="k">return</span> <span class="n">_stateful_declared_attr</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>
</span><span id="1-461">
</span><span id="1-462">    <span class="nd">@hybridproperty</span>
</span><span id="1-463">    <span class="k">def</span> <span class="nf">directive</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_declared_directive</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span id="1-464">        <span class="c1"># see mapping_api.rst for docstring</span>
</span><span id="1-465">        <span class="k">return</span> <span class="n">_declared_directive</span>  <span class="c1"># type: ignore</span>
</span><span id="1-466">
</span><span id="1-467">    <span class="nd">@hybridproperty</span>
</span><span id="1-468">    <span class="k">def</span> <span class="nf">cascading</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_stateful_declared_attr</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span id="1-469">        <span class="c1"># see mapping_api.rst for docstring</span>
</span><span id="1-470">        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_stateful</span><span class="p">(</span><span class="n">cascading</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="1-471">
</span><span id="1-472">
</span><span id="1-473"><span class="k">class</span> <span class="nc">_stateful_declared_attr</span><span class="p">(</span><span class="n">declared_attr</span><span class="p">[</span><span class="n">_T</span><span class="p">]):</span>
</span><span id="1-474">    <span class="n">kw</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
</span><span id="1-475">
</span><span id="1-476">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
</span><span id="1-477">        <span class="bp">self</span><span class="o">.</span><span class="n">kw</span> <span class="o">=</span> <span class="n">kw</span>
</span><span id="1-478">
</span><span id="1-479">    <span class="nd">@hybridmethod</span>
</span><span id="1-480">    <span class="k">def</span> <span class="nf">_stateful</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_stateful_declared_attr</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span id="1-481">        <span class="n">new_kw</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">kw</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="1-482">        <span class="n">new_kw</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kw</span><span class="p">)</span>
</span><span id="1-483">        <span class="k">return</span> <span class="n">_stateful_declared_attr</span><span class="p">(</span><span class="o">**</span><span class="n">new_kw</span><span class="p">)</span>
</span><span id="1-484">
</span><span id="1-485">    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fn</span><span class="p">:</span> <span class="n">_DeclaredAttrDecorated</span><span class="p">[</span><span class="n">_T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">declared_attr</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span id="1-486">        <span class="k">return</span> <span class="n">declared_attr</span><span class="p">(</span><span class="n">fn</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">kw</span><span class="p">)</span>
</span><span id="1-487">
</span><span id="1-488">
</span><span id="1-489"><span class="k">def</span> <span class="nf">declarative_mixin</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span id="1-490"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Mark a class as providing the feature of &quot;declarative mixin&quot;.</span>
</span><span id="1-491">
</span><span id="1-492"><span class="sd">    E.g.::</span>
</span><span id="1-493">
</span><span id="1-494"><span class="sd">        from sqlalchemy.orm import declared_attr</span>
</span><span id="1-495"><span class="sd">        from sqlalchemy.orm import declarative_mixin</span>
</span><span id="1-496">
</span><span id="1-497"><span class="sd">        @declarative_mixin</span>
</span><span id="1-498"><span class="sd">        class MyMixin:</span>
</span><span id="1-499">
</span><span id="1-500"><span class="sd">            @declared_attr</span>
</span><span id="1-501"><span class="sd">            def __tablename__(cls):</span>
</span><span id="1-502"><span class="sd">                return cls.__name__.lower()</span>
</span><span id="1-503">
</span><span id="1-504"><span class="sd">            __table_args__ = {&#39;mysql_engine&#39;: &#39;InnoDB&#39;}</span>
</span><span id="1-505"><span class="sd">            __mapper_args__= {&#39;always_refresh&#39;: True}</span>
</span><span id="1-506">
</span><span id="1-507"><span class="sd">            id =  Column(Integer, primary_key=True)</span>
</span><span id="1-508">
</span><span id="1-509"><span class="sd">        class MyModel(MyMixin, Base):</span>
</span><span id="1-510"><span class="sd">            name = Column(String(1000))</span>
</span><span id="1-511">
</span><span id="1-512"><span class="sd">    The :func:`_orm.declarative_mixin` decorator currently does not modify</span>
</span><span id="1-513"><span class="sd">    the given class in any way; it&#39;s current purpose is strictly to assist</span>
</span><span id="1-514"><span class="sd">    the :ref:`Mypy plugin &lt;mypy_toplevel&gt;` in being able to identify</span>
</span><span id="1-515"><span class="sd">    SQLAlchemy declarative mixin classes when no other context is present.</span>
</span><span id="1-516">
</span><span id="1-517"><span class="sd">    .. versionadded:: 1.4.6</span>
</span><span id="1-518">
</span><span id="1-519"><span class="sd">    .. seealso::</span>
</span><span id="1-520">
</span><span id="1-521"><span class="sd">        :ref:`orm_mixins_toplevel`</span>
</span><span id="1-522">
</span><span id="1-523"><span class="sd">        :ref:`mypy_declarative_mixins` - in the</span>
</span><span id="1-524"><span class="sd">        :ref:`Mypy plugin documentation &lt;mypy_toplevel&gt;`</span>
</span><span id="1-525">
</span><span id="1-526"><span class="sd">    &quot;&quot;&quot;</span>  <span class="c1"># noqa: E501</span>
</span><span id="1-527">
</span><span id="1-528">    <span class="k">return</span> <span class="bp">cls</span>
</span><span id="1-529">
</span><span id="1-530">
</span><span id="1-531"><span class="k">def</span> <span class="nf">_setup_declarative_base</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-532">    <span class="k">if</span> <span class="s2">&quot;metadata&quot;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
</span><span id="1-533">        <span class="n">metadata</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;metadata&quot;</span><span class="p">]</span>
</span><span id="1-534">    <span class="k">else</span><span class="p">:</span>
</span><span id="1-535">        <span class="n">metadata</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-536">
</span><span id="1-537">    <span class="k">if</span> <span class="s2">&quot;type_annotation_map&quot;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
</span><span id="1-538">        <span class="n">type_annotation_map</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="s2">&quot;type_annotation_map&quot;</span><span class="p">]</span>
</span><span id="1-539">    <span class="k">else</span><span class="p">:</span>
</span><span id="1-540">        <span class="n">type_annotation_map</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-541">
</span><span id="1-542">    <span class="n">reg</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;registry&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="1-543">    <span class="k">if</span> <span class="n">reg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-544">        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">reg</span><span class="p">,</span> <span class="n">registry</span><span class="p">):</span>
</span><span id="1-545">            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span id="1-546">                <span class="s2">&quot;Declarative base class has a &#39;registry&#39; attribute that is &quot;</span>
</span><span id="1-547">                <span class="s2">&quot;not an instance of sqlalchemy.orm.registry()&quot;</span>
</span><span id="1-548">            <span class="p">)</span>
</span><span id="1-549">        <span class="k">elif</span> <span class="n">type_annotation_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-550">            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span id="1-551">                <span class="s2">&quot;Declarative base class has both a &#39;registry&#39; attribute and a &quot;</span>
</span><span id="1-552">                <span class="s2">&quot;type_annotation_map entry.  Per-base type_annotation_maps &quot;</span>
</span><span id="1-553">                <span class="s2">&quot;are not supported.  Please apply the type_annotation_map &quot;</span>
</span><span id="1-554">                <span class="s2">&quot;to this registry directly.&quot;</span>
</span><span id="1-555">            <span class="p">)</span>
</span><span id="1-556">
</span><span id="1-557">    <span class="k">else</span><span class="p">:</span>
</span><span id="1-558">        <span class="n">reg</span> <span class="o">=</span> <span class="n">registry</span><span class="p">(</span>
</span><span id="1-559">            <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="n">type_annotation_map</span><span class="o">=</span><span class="n">type_annotation_map</span>
</span><span id="1-560">        <span class="p">)</span>
</span><span id="1-561">        <span class="bp">cls</span><span class="o">.</span><span class="n">registry</span> <span class="o">=</span> <span class="n">reg</span>  <span class="c1"># type: ignore</span>
</span><span id="1-562">
</span><span id="1-563">    <span class="bp">cls</span><span class="o">.</span><span class="n">_sa_registry</span> <span class="o">=</span> <span class="n">reg</span>  <span class="c1"># type: ignore</span>
</span><span id="1-564">
</span><span id="1-565">    <span class="k">if</span> <span class="s2">&quot;metadata&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
</span><span id="1-566">        <span class="bp">cls</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">metadata</span>  <span class="c1"># type: ignore</span>
</span><span id="1-567">
</span><span id="1-568">    <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;__init__&quot;</span><span class="p">,</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__init__</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">object</span><span class="o">.</span><span class="fm">__init__</span><span class="p">:</span>
</span><span id="1-569">        <span class="bp">cls</span><span class="o">.</span><span class="fm">__init__</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">constructor</span>
</span><span id="1-570">
</span><span id="1-571">
</span><span id="1-572"><span class="k">class</span> <span class="nc">MappedAsDataclass</span><span class="p">(</span><span class="n">metaclass</span><span class="o">=</span><span class="n">DCTransformDeclarative</span><span class="p">):</span>
</span><span id="1-573"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Mixin class to indicate when mapping this class, also convert it to be</span>
</span><span id="1-574"><span class="sd">    a dataclass.</span>
</span><span id="1-575">
</span><span id="1-576"><span class="sd">    .. seealso::</span>
</span><span id="1-577">
</span><span id="1-578"><span class="sd">        :ref:`orm_declarative_native_dataclasses` - complete background</span>
</span><span id="1-579"><span class="sd">        on SQLAlchemy native dataclass mapping</span>
</span><span id="1-580">
</span><span id="1-581"><span class="sd">    .. versionadded:: 2.0</span>
</span><span id="1-582">
</span><span id="1-583"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-584">
</span><span id="1-585">    <span class="k">def</span> <span class="nf">__init_subclass__</span><span class="p">(</span>
</span><span id="1-586">        <span class="bp">cls</span><span class="p">,</span>
</span><span id="1-587">        <span class="n">init</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">,</span>
</span><span id="1-588">        <span class="nb">repr</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">,</span>  <span class="c1"># noqa: A002</span>
</span><span id="1-589">        <span class="n">eq</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">,</span>
</span><span id="1-590">        <span class="n">order</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">,</span>
</span><span id="1-591">        <span class="n">unsafe_hash</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">,</span>
</span><span id="1-592">        <span class="n">match_args</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">,</span>
</span><span id="1-593">        <span class="n">kw_only</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">,</span>
</span><span id="1-594">        <span class="n">dataclass_callable</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
</span><span id="1-595">            <span class="n">_NoArg</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
</span><span id="1-596">        <span class="p">]</span> <span class="o">=</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">,</span>
</span><span id="1-597">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-598">        <span class="n">apply_dc_transforms</span><span class="p">:</span> <span class="n">_DataclassArguments</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="1-599">            <span class="s2">&quot;init&quot;</span><span class="p">:</span> <span class="n">init</span><span class="p">,</span>
</span><span id="1-600">            <span class="s2">&quot;repr&quot;</span><span class="p">:</span> <span class="nb">repr</span><span class="p">,</span>
</span><span id="1-601">            <span class="s2">&quot;eq&quot;</span><span class="p">:</span> <span class="n">eq</span><span class="p">,</span>
</span><span id="1-602">            <span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="n">order</span><span class="p">,</span>
</span><span id="1-603">            <span class="s2">&quot;unsafe_hash&quot;</span><span class="p">:</span> <span class="n">unsafe_hash</span><span class="p">,</span>
</span><span id="1-604">            <span class="s2">&quot;match_args&quot;</span><span class="p">:</span> <span class="n">match_args</span><span class="p">,</span>
</span><span id="1-605">            <span class="s2">&quot;kw_only&quot;</span><span class="p">:</span> <span class="n">kw_only</span><span class="p">,</span>
</span><span id="1-606">            <span class="s2">&quot;dataclass_callable&quot;</span><span class="p">:</span> <span class="n">dataclass_callable</span><span class="p">,</span>
</span><span id="1-607">        <span class="p">}</span>
</span><span id="1-608">
</span><span id="1-609">        <span class="n">current_transforms</span><span class="p">:</span> <span class="n">_DataclassArguments</span>
</span><span id="1-610">
</span><span id="1-611">        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;_sa_apply_dc_transforms&quot;</span><span class="p">):</span>
</span><span id="1-612">            <span class="n">current</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_sa_apply_dc_transforms</span>  <span class="c1"># type: ignore[attr-defined]</span>
</span><span id="1-613">
</span><span id="1-614">            <span class="n">_ClassScanMapperConfig</span><span class="o">.</span><span class="n">_assert_dc_arguments</span><span class="p">(</span><span class="n">current</span><span class="p">)</span>
</span><span id="1-615">
</span><span id="1-616">            <span class="bp">cls</span><span class="o">.</span><span class="n">_sa_apply_dc_transforms</span> <span class="o">=</span> <span class="n">current_transforms</span> <span class="o">=</span> <span class="p">{</span>  <span class="c1"># type: ignore  # noqa: E501</span>
</span><span id="1-617">                <span class="n">k</span><span class="p">:</span> <span class="n">current</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">)</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span> <span class="k">else</span> <span class="n">v</span>
</span><span id="1-618">                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">apply_dc_transforms</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="1-619">            <span class="p">}</span>
</span><span id="1-620">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-621">            <span class="bp">cls</span><span class="o">.</span><span class="n">_sa_apply_dc_transforms</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="1-622">                <span class="n">current_transforms</span>
</span><span id="1-623">            <span class="p">)</span> <span class="o">=</span> <span class="n">apply_dc_transforms</span>
</span><span id="1-624">
</span><span id="1-625">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init_subclass__</span><span class="p">()</span>
</span><span id="1-626">
</span><span id="1-627">        <span class="k">if</span> <span class="ow">not</span> <span class="n">_is_mapped_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
</span><span id="1-628">            <span class="n">new_anno</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="1-629">                <span class="n">_ClassScanMapperConfig</span><span class="o">.</span><span class="n">_update_annotations_for_non_mapped_class</span>
</span><span id="1-630">            <span class="p">)(</span><span class="bp">cls</span><span class="p">)</span>
</span><span id="1-631">            <span class="n">_ClassScanMapperConfig</span><span class="o">.</span><span class="n">_apply_dataclasses_to_any_class</span><span class="p">(</span>
</span><span id="1-632">                <span class="n">current_transforms</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">new_anno</span>
</span><span id="1-633">            <span class="p">)</span>
</span><span id="1-634">
</span><span id="1-635">
</span><span id="1-636"><span class="k">class</span> <span class="nc">DeclarativeBase</span><span class="p">(</span>
</span><span id="1-637">    <span class="c1"># Inspectable is used only by the mypy plugin</span>
</span><span id="1-638">    <span class="n">inspection</span><span class="o">.</span><span class="n">Inspectable</span><span class="p">[</span><span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
</span><span id="1-639">    <span class="n">metaclass</span><span class="o">=</span><span class="n">DeclarativeAttributeIntercept</span><span class="p">,</span>
</span><span id="1-640"><span class="p">):</span>
</span><span id="1-641"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Base class used for declarative class definitions.</span>
</span><span id="1-642">
</span><span id="1-643"><span class="sd">    The :class:`_orm.DeclarativeBase` allows for the creation of new</span>
</span><span id="1-644"><span class="sd">    declarative bases in such a way that is compatible with type checkers::</span>
</span><span id="1-645">
</span><span id="1-646">
</span><span id="1-647"><span class="sd">        from sqlalchemy.orm import DeclarativeBase</span>
</span><span id="1-648">
</span><span id="1-649"><span class="sd">        class Base(DeclarativeBase):</span>
</span><span id="1-650"><span class="sd">            pass</span>
</span><span id="1-651">
</span><span id="1-652">
</span><span id="1-653"><span class="sd">    The above ``Base`` class is now usable as the base for new declarative</span>
</span><span id="1-654"><span class="sd">    mappings.  The superclass makes use of the ``__init_subclass__()``</span>
</span><span id="1-655"><span class="sd">    method to set up new classes and metaclasses aren&#39;t used.</span>
</span><span id="1-656">
</span><span id="1-657"><span class="sd">    When first used, the :class:`_orm.DeclarativeBase` class instantiates a new</span>
</span><span id="1-658"><span class="sd">    :class:`_orm.registry` to be used with the base, assuming one was not</span>
</span><span id="1-659"><span class="sd">    provided explicitly. The :class:`_orm.DeclarativeBase` class supports</span>
</span><span id="1-660"><span class="sd">    class-level attributes which act as parameters for the construction of this</span>
</span><span id="1-661"><span class="sd">    registry; such as to indicate a specific :class:`_schema.MetaData`</span>
</span><span id="1-662"><span class="sd">    collection as well as a specific value for</span>
</span><span id="1-663"><span class="sd">    :paramref:`_orm.registry.type_annotation_map`::</span>
</span><span id="1-664">
</span><span id="1-665"><span class="sd">        from typing_extensions import Annotated</span>
</span><span id="1-666">
</span><span id="1-667"><span class="sd">        from sqlalchemy import BigInteger</span>
</span><span id="1-668"><span class="sd">        from sqlalchemy import MetaData</span>
</span><span id="1-669"><span class="sd">        from sqlalchemy import String</span>
</span><span id="1-670"><span class="sd">        from sqlalchemy.orm import DeclarativeBase</span>
</span><span id="1-671">
</span><span id="1-672"><span class="sd">        bigint = Annotated[int, &quot;bigint&quot;]</span>
</span><span id="1-673"><span class="sd">        my_metadata = MetaData()</span>
</span><span id="1-674">
</span><span id="1-675"><span class="sd">        class Base(DeclarativeBase):</span>
</span><span id="1-676"><span class="sd">            metadata = my_metadata</span>
</span><span id="1-677"><span class="sd">            type_annotation_map = {</span>
</span><span id="1-678"><span class="sd">                str: String().with_variant(String(255), &quot;mysql&quot;, &quot;mariadb&quot;),</span>
</span><span id="1-679"><span class="sd">                bigint: BigInteger()</span>
</span><span id="1-680"><span class="sd">            }</span>
</span><span id="1-681">
</span><span id="1-682"><span class="sd">    Class-level attributes which may be specified include:</span>
</span><span id="1-683">
</span><span id="1-684"><span class="sd">    :param metadata: optional :class:`_schema.MetaData` collection.</span>
</span><span id="1-685"><span class="sd">     If a :class:`_orm.registry` is constructed automatically, this</span>
</span><span id="1-686"><span class="sd">     :class:`_schema.MetaData` collection will be used to construct it.</span>
</span><span id="1-687"><span class="sd">     Otherwise, the local :class:`_schema.MetaData` collection will supercede</span>
</span><span id="1-688"><span class="sd">     that used by an existing :class:`_orm.registry` passed using the</span>
</span><span id="1-689"><span class="sd">     :paramref:`_orm.DeclarativeBase.registry` parameter.</span>
</span><span id="1-690"><span class="sd">    :param type_annotation_map: optional type annotation map that will be</span>
</span><span id="1-691"><span class="sd">     passed to the :class:`_orm.registry` as</span>
</span><span id="1-692"><span class="sd">     :paramref:`_orm.registry.type_annotation_map`.</span>
</span><span id="1-693"><span class="sd">    :param registry: supply a pre-existing :class:`_orm.registry` directly.</span>
</span><span id="1-694">
</span><span id="1-695"><span class="sd">    .. versionadded:: 2.0  Added :class:`.DeclarativeBase`, so that declarative</span>
</span><span id="1-696"><span class="sd">       base classes may be constructed in such a way that is also recognized</span>
</span><span id="1-697"><span class="sd">       by :pep:`484` type checkers.   As a result, :class:`.DeclarativeBase`</span>
</span><span id="1-698"><span class="sd">       and other subclassing-oriented APIs should be seen as</span>
</span><span id="1-699"><span class="sd">       superseding previous &quot;class returned by a function&quot; APIs, namely</span>
</span><span id="1-700"><span class="sd">       :func:`_orm.declarative_base` and :meth:`_orm.registry.generate_base`,</span>
</span><span id="1-701"><span class="sd">       where the base class returned cannot be recognized by type checkers</span>
</span><span id="1-702"><span class="sd">       without using plugins.</span>
</span><span id="1-703">
</span><span id="1-704"><span class="sd">    **__init__ behavior**</span>
</span><span id="1-705">
</span><span id="1-706"><span class="sd">    In a plain Python class, the base-most ``__init__()`` method in the class</span>
</span><span id="1-707"><span class="sd">    hierarchy is ``object.__init__()``, which accepts no arguments. However,</span>
</span><span id="1-708"><span class="sd">    when the :class:`_orm.DeclarativeBase` subclass is first declared, the</span>
</span><span id="1-709"><span class="sd">    class is given an ``__init__()`` method that links to the</span>
</span><span id="1-710"><span class="sd">    :paramref:`_orm.registry.constructor` constructor function, if no</span>
</span><span id="1-711"><span class="sd">    ``__init__()`` method is already present; this is the usual declarative</span>
</span><span id="1-712"><span class="sd">    constructor that will assign keyword arguments as attributes on the</span>
</span><span id="1-713"><span class="sd">    instance, assuming those attributes are established at the class level</span>
</span><span id="1-714"><span class="sd">    (i.e. are mapped, or are linked to a descriptor). This constructor is</span>
</span><span id="1-715"><span class="sd">    **never accessed by a mapped class without being called explicitly via</span>
</span><span id="1-716"><span class="sd">    super()**, as mapped classes are themselves given an ``__init__()`` method</span>
</span><span id="1-717"><span class="sd">    directly which calls :paramref:`_orm.registry.constructor`, so in the</span>
</span><span id="1-718"><span class="sd">    default case works independently of what the base-most ``__init__()``</span>
</span><span id="1-719"><span class="sd">    method does.</span>
</span><span id="1-720">
</span><span id="1-721"><span class="sd">    .. versionchanged:: 2.0.1  :class:`_orm.DeclarativeBase` has a default</span>
</span><span id="1-722"><span class="sd">       constructor that links to :paramref:`_orm.registry.constructor` by</span>
</span><span id="1-723"><span class="sd">       default, so that calls to ``super().__init__()`` can access this</span>
</span><span id="1-724"><span class="sd">       constructor. Previously, due to an implementation mistake, this default</span>
</span><span id="1-725"><span class="sd">       constructor was missing, and calling ``super().__init__()`` would invoke</span>
</span><span id="1-726"><span class="sd">       ``object.__init__()``.</span>
</span><span id="1-727">
</span><span id="1-728"><span class="sd">    The :class:`_orm.DeclarativeBase` subclass may also declare an explicit</span>
</span><span id="1-729"><span class="sd">    ``__init__()`` method which will replace the use of the</span>
</span><span id="1-730"><span class="sd">    :paramref:`_orm.registry.constructor` function at this level::</span>
</span><span id="1-731">
</span><span id="1-732"><span class="sd">        class Base(DeclarativeBase):</span>
</span><span id="1-733"><span class="sd">            def __init__(self, id=None):</span>
</span><span id="1-734"><span class="sd">                self.id = id</span>
</span><span id="1-735">
</span><span id="1-736"><span class="sd">    Mapped classes still will not invoke this constructor implicitly; it</span>
</span><span id="1-737"><span class="sd">    remains only accessible by calling ``super().__init__()``::</span>
</span><span id="1-738">
</span><span id="1-739"><span class="sd">        class MyClass(Base):</span>
</span><span id="1-740"><span class="sd">            def __init__(self, id=None, name=None):</span>
</span><span id="1-741"><span class="sd">                self.name = name</span>
</span><span id="1-742"><span class="sd">                super().__init__(id=id)</span>
</span><span id="1-743">
</span><span id="1-744"><span class="sd">    Note that this is a different behavior from what functions like the legacy</span>
</span><span id="1-745"><span class="sd">    :func:`_orm.declarative_base` would do; the base created by those functions</span>
</span><span id="1-746"><span class="sd">    would always install :paramref:`_orm.registry.constructor` for</span>
</span><span id="1-747"><span class="sd">    ``__init__()``.</span>
</span><span id="1-748">
</span><span id="1-749">
</span><span id="1-750"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-751">
</span><span id="1-752">    <span class="k">if</span> <span class="n">typing</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span id="1-753">
</span><span id="1-754">        <span class="k">def</span> <span class="nf">_sa_inspect_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">Self</span><span class="p">]:</span>
</span><span id="1-755">            <span class="o">...</span>
</span><span id="1-756">
</span><span id="1-757">        <span class="k">def</span> <span class="nf">_sa_inspect_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Self</span><span class="p">]:</span>
</span><span id="1-758">            <span class="o">...</span>
</span><span id="1-759">
</span><span id="1-760">        <span class="n">_sa_registry</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">_RegistryType</span><span class="p">]</span>
</span><span id="1-761">
</span><span id="1-762">        <span class="n">registry</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">_RegistryType</span><span class="p">]</span>
</span><span id="1-763"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Refers to the :class:`_orm.registry` in use where new</span>
</span><span id="1-764"><span class="sd">        :class:`_orm.Mapper` objects will be associated.&quot;&quot;&quot;</span>
</span><span id="1-765">
</span><span id="1-766">        <span class="n">metadata</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">MetaData</span><span class="p">]</span>
</span><span id="1-767"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Refers to the :class:`_schema.MetaData` collection that will be used</span>
</span><span id="1-768"><span class="sd">        for new :class:`_schema.Table` objects.</span>
</span><span id="1-769">
</span><span id="1-770"><span class="sd">        .. seealso::</span>
</span><span id="1-771">
</span><span id="1-772"><span class="sd">            :ref:`orm_declarative_metadata`</span>
</span><span id="1-773">
</span><span id="1-774"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-775">
</span><span id="1-776">        <span class="vm">__name__</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span id="1-777">
</span><span id="1-778">        <span class="c1"># this ideally should be Mapper[Self], but mypy as of 1.4.1 does not</span>
</span><span id="1-779">        <span class="c1"># like it, and breaks the declared_attr_one test. Pyright/pylance is</span>
</span><span id="1-780">        <span class="c1"># ok with it.</span>
</span><span id="1-781">        <span class="n">__mapper__</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
</span><span id="1-782"><span class="w">        </span><span class="sd">&quot;&quot;&quot;The :class:`_orm.Mapper` object to which a particular class is</span>
</span><span id="1-783"><span class="sd">        mapped.</span>
</span><span id="1-784">
</span><span id="1-785"><span class="sd">        May also be acquired using :func:`_sa.inspect`, e.g.</span>
</span><span id="1-786"><span class="sd">        ``inspect(klass)``.</span>
</span><span id="1-787">
</span><span id="1-788"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-789">
</span><span id="1-790">        <span class="n">__table__</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">FromClause</span><span class="p">]</span>
</span><span id="1-791"><span class="w">        </span><span class="sd">&quot;&quot;&quot;The :class:`_sql.FromClause` to which a particular subclass is</span>
</span><span id="1-792"><span class="sd">        mapped.</span>
</span><span id="1-793">
</span><span id="1-794"><span class="sd">        This is usually an instance of :class:`_schema.Table` but may also</span>
</span><span id="1-795"><span class="sd">        refer to other kinds of :class:`_sql.FromClause` such as</span>
</span><span id="1-796"><span class="sd">        :class:`_sql.Subquery`, depending on how the class is mapped.</span>
</span><span id="1-797">
</span><span id="1-798"><span class="sd">        .. seealso::</span>
</span><span id="1-799">
</span><span id="1-800"><span class="sd">            :ref:`orm_declarative_metadata`</span>
</span><span id="1-801">
</span><span id="1-802"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-803">
</span><span id="1-804">        <span class="c1"># pyright/pylance do not consider a classmethod a ClassVar so use Any</span>
</span><span id="1-805">        <span class="c1"># https://github.com/microsoft/pylance-release/issues/3484</span>
</span><span id="1-806">        <span class="n">__tablename__</span><span class="p">:</span> <span class="n">Any</span>
</span><span id="1-807"><span class="w">        </span><span class="sd">&quot;&quot;&quot;String name to assign to the generated</span>
</span><span id="1-808"><span class="sd">        :class:`_schema.Table` object, if not specified directly via</span>
</span><span id="1-809"><span class="sd">        :attr:`_orm.DeclarativeBase.__table__`.</span>
</span><span id="1-810">
</span><span id="1-811"><span class="sd">        .. seealso::</span>
</span><span id="1-812">
</span><span id="1-813"><span class="sd">            :ref:`orm_declarative_table`</span>
</span><span id="1-814">
</span><span id="1-815"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-816">
</span><span id="1-817">        <span class="n">__mapper_args__</span><span class="p">:</span> <span class="n">Any</span>
</span><span id="1-818"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Dictionary of arguments which will be passed to the</span>
</span><span id="1-819"><span class="sd">        :class:`_orm.Mapper` constructor.</span>
</span><span id="1-820">
</span><span id="1-821"><span class="sd">        .. seealso::</span>
</span><span id="1-822">
</span><span id="1-823"><span class="sd">            :ref:`orm_declarative_mapper_options`</span>
</span><span id="1-824">
</span><span id="1-825"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-826">
</span><span id="1-827">        <span class="n">__table_args__</span><span class="p">:</span> <span class="n">Any</span>
</span><span id="1-828"><span class="w">        </span><span class="sd">&quot;&quot;&quot;A dictionary or tuple of arguments that will be passed to the</span>
</span><span id="1-829"><span class="sd">        :class:`_schema.Table` constructor.  See</span>
</span><span id="1-830"><span class="sd">        :ref:`orm_declarative_table_configuration`</span>
</span><span id="1-831"><span class="sd">        for background on the specific structure of this collection.</span>
</span><span id="1-832">
</span><span id="1-833"><span class="sd">        .. seealso::</span>
</span><span id="1-834">
</span><span id="1-835"><span class="sd">            :ref:`orm_declarative_table_configuration`</span>
</span><span id="1-836">
</span><span id="1-837"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-838">
</span><span id="1-839">        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
</span><span id="1-840">            <span class="o">...</span>
</span><span id="1-841">
</span><span id="1-842">    <span class="k">def</span> <span class="nf">__init_subclass__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-843">        <span class="k">if</span> <span class="n">DeclarativeBase</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">:</span>
</span><span id="1-844">            <span class="n">_check_not_declarative</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">DeclarativeBase</span><span class="p">)</span>
</span><span id="1-845">            <span class="n">_setup_declarative_base</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
</span><span id="1-846">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-847">            <span class="n">_as_declarative</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_sa_registry</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
</span><span id="1-848">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">__init_subclass__</span><span class="p">()</span>
</span><span id="1-849">
</span><span id="1-850">
</span><span id="1-851"><span class="k">def</span> <span class="nf">_check_not_declarative</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">base</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-852">    <span class="n">cls_dict</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span>
</span><span id="1-853">    <span class="k">if</span> <span class="p">(</span>
</span><span id="1-854">        <span class="s2">&quot;__table__&quot;</span> <span class="ow">in</span> <span class="n">cls_dict</span>
</span><span id="1-855">        <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span>
</span><span id="1-856">            <span class="nb">callable</span><span class="p">(</span><span class="n">cls_dict</span><span class="p">[</span><span class="s2">&quot;__table__&quot;</span><span class="p">])</span>
</span><span id="1-857">            <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cls_dict</span><span class="p">[</span><span class="s2">&quot;__table__&quot;</span><span class="p">],</span> <span class="s2">&quot;__get__&quot;</span><span class="p">)</span>
</span><span id="1-858">        <span class="p">)</span>
</span><span id="1-859">    <span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cls_dict</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;__tablename__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="nb">str</span><span class="p">):</span>
</span><span id="1-860">        <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span id="1-861">            <span class="sa">f</span><span class="s2">&quot;Cannot use </span><span class="si">{</span><span class="n">base</span><span class="o">.</span><span class="vm">__name__</span><span class="si">!r}</span><span class="s2"> directly as a declarative base &quot;</span>
</span><span id="1-862">            <span class="s2">&quot;class. Create a Base by creating a subclass of it.&quot;</span>
</span><span id="1-863">        <span class="p">)</span>
</span><span id="1-864">
</span><span id="1-865">
</span><span id="1-866"><span class="k">class</span> <span class="nc">DeclarativeBaseNoMeta</span><span class="p">(</span>
</span><span id="1-867">    <span class="c1"># Inspectable is used only by the mypy plugin</span>
</span><span id="1-868">    <span class="n">inspection</span><span class="o">.</span><span class="n">Inspectable</span><span class="p">[</span><span class="n">InstanceState</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
</span><span id="1-869"><span class="p">):</span>
</span><span id="1-870"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Same as :class:`_orm.DeclarativeBase`, but does not use a metaclass</span>
</span><span id="1-871"><span class="sd">    to intercept new attributes.</span>
</span><span id="1-872">
</span><span id="1-873"><span class="sd">    The :class:`_orm.DeclarativeBaseNoMeta` base may be used when use of</span>
</span><span id="1-874"><span class="sd">    custom metaclasses is desirable.</span>
</span><span id="1-875">
</span><span id="1-876"><span class="sd">    .. versionadded:: 2.0</span>
</span><span id="1-877">
</span><span id="1-878">
</span><span id="1-879"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-880">
</span><span id="1-881">    <span class="n">_sa_registry</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">_RegistryType</span><span class="p">]</span>
</span><span id="1-882">
</span><span id="1-883">    <span class="n">registry</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">_RegistryType</span><span class="p">]</span>
</span><span id="1-884"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Refers to the :class:`_orm.registry` in use where new</span>
</span><span id="1-885"><span class="sd">    :class:`_orm.Mapper` objects will be associated.&quot;&quot;&quot;</span>
</span><span id="1-886">
</span><span id="1-887">    <span class="n">metadata</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">MetaData</span><span class="p">]</span>
</span><span id="1-888"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Refers to the :class:`_schema.MetaData` collection that will be used</span>
</span><span id="1-889"><span class="sd">    for new :class:`_schema.Table` objects.</span>
</span><span id="1-890">
</span><span id="1-891"><span class="sd">    .. seealso::</span>
</span><span id="1-892">
</span><span id="1-893"><span class="sd">        :ref:`orm_declarative_metadata`</span>
</span><span id="1-894">
</span><span id="1-895"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-896">
</span><span id="1-897">    <span class="c1"># this ideally should be Mapper[Self], but mypy as of 1.4.1 does not</span>
</span><span id="1-898">    <span class="c1"># like it, and breaks the declared_attr_one test. Pyright/pylance is</span>
</span><span id="1-899">    <span class="c1"># ok with it.</span>
</span><span id="1-900">    <span class="n">__mapper__</span><span class="p">:</span> <span class="n">ClassVar</span><span class="p">[</span><span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
</span><span id="1-901"><span class="w">    </span><span class="sd">&quot;&quot;&quot;The :class:`_orm.Mapper` object to which a particular class is</span>
</span><span id="1-902"><span class="sd">    mapped.</span>
</span><span id="1-903">
</span><span id="1-904"><span class="sd">    May also be acquired using :func:`_sa.inspect`, e.g.</span>
</span><span id="1-905"><span class="sd">    ``inspect(klass)``.</span>
</span><span id="1-906">
</span><span id="1-907"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-908">
</span><span id="1-909">    <span class="n">__table__</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FromClause</span><span class="p">]</span>
</span><span id="1-910"><span class="w">    </span><span class="sd">&quot;&quot;&quot;The :class:`_sql.FromClause` to which a particular subclass is</span>
</span><span id="1-911"><span class="sd">    mapped.</span>
</span><span id="1-912">
</span><span id="1-913"><span class="sd">    This is usually an instance of :class:`_schema.Table` but may also</span>
</span><span id="1-914"><span class="sd">    refer to other kinds of :class:`_sql.FromClause` such as</span>
</span><span id="1-915"><span class="sd">    :class:`_sql.Subquery`, depending on how the class is mapped.</span>
</span><span id="1-916">
</span><span id="1-917"><span class="sd">    .. seealso::</span>
</span><span id="1-918">
</span><span id="1-919"><span class="sd">        :ref:`orm_declarative_metadata`</span>
</span><span id="1-920">
</span><span id="1-921"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-922">
</span><span id="1-923">    <span class="k">if</span> <span class="n">typing</span><span class="o">.</span><span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span id="1-924">
</span><span id="1-925">        <span class="k">def</span> <span class="nf">_sa_inspect_type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">Self</span><span class="p">]:</span>
</span><span id="1-926">            <span class="o">...</span>
</span><span id="1-927">
</span><span id="1-928">        <span class="k">def</span> <span class="nf">_sa_inspect_instance</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">InstanceState</span><span class="p">[</span><span class="n">Self</span><span class="p">]:</span>
</span><span id="1-929">            <span class="o">...</span>
</span><span id="1-930">
</span><span id="1-931">        <span class="n">__tablename__</span><span class="p">:</span> <span class="n">Any</span>
</span><span id="1-932"><span class="w">        </span><span class="sd">&quot;&quot;&quot;String name to assign to the generated</span>
</span><span id="1-933"><span class="sd">        :class:`_schema.Table` object, if not specified directly via</span>
</span><span id="1-934"><span class="sd">        :attr:`_orm.DeclarativeBase.__table__`.</span>
</span><span id="1-935">
</span><span id="1-936"><span class="sd">        .. seealso::</span>
</span><span id="1-937">
</span><span id="1-938"><span class="sd">            :ref:`orm_declarative_table`</span>
</span><span id="1-939">
</span><span id="1-940"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-941">
</span><span id="1-942">        <span class="n">__mapper_args__</span><span class="p">:</span> <span class="n">Any</span>
</span><span id="1-943"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Dictionary of arguments which will be passed to the</span>
</span><span id="1-944"><span class="sd">        :class:`_orm.Mapper` constructor.</span>
</span><span id="1-945">
</span><span id="1-946"><span class="sd">        .. seealso::</span>
</span><span id="1-947">
</span><span id="1-948"><span class="sd">            :ref:`orm_declarative_mapper_options`</span>
</span><span id="1-949">
</span><span id="1-950"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-951">
</span><span id="1-952">        <span class="n">__table_args__</span><span class="p">:</span> <span class="n">Any</span>
</span><span id="1-953"><span class="w">        </span><span class="sd">&quot;&quot;&quot;A dictionary or tuple of arguments that will be passed to the</span>
</span><span id="1-954"><span class="sd">        :class:`_schema.Table` constructor.  See</span>
</span><span id="1-955"><span class="sd">        :ref:`orm_declarative_table_configuration`</span>
</span><span id="1-956"><span class="sd">        for background on the specific structure of this collection.</span>
</span><span id="1-957">
</span><span id="1-958"><span class="sd">        .. seealso::</span>
</span><span id="1-959">
</span><span id="1-960"><span class="sd">            :ref:`orm_declarative_table_configuration`</span>
</span><span id="1-961">
</span><span id="1-962"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-963">
</span><span id="1-964">        <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">):</span>
</span><span id="1-965">            <span class="o">...</span>
</span><span id="1-966">
</span><span id="1-967">    <span class="k">def</span> <span class="nf">__init_subclass__</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-968">        <span class="k">if</span> <span class="n">DeclarativeBaseNoMeta</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">:</span>
</span><span id="1-969">            <span class="n">_check_not_declarative</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">DeclarativeBaseNoMeta</span><span class="p">)</span>
</span><span id="1-970">            <span class="n">_setup_declarative_base</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
</span><span id="1-971">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-972">            <span class="n">_as_declarative</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">_sa_registry</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
</span><span id="1-973">
</span><span id="1-974">
</span><span id="1-975"><span class="k">def</span> <span class="nf">add_mapped_attribute</span><span class="p">(</span>
</span><span id="1-976">    <span class="n">target</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">attr</span><span class="p">:</span> <span class="n">MapperProperty</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
</span><span id="1-977"><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-978"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a new mapped attribute to an ORM mapped class.</span>
</span><span id="1-979">
</span><span id="1-980"><span class="sd">    E.g.::</span>
</span><span id="1-981">
</span><span id="1-982"><span class="sd">        add_mapped_attribute(User, &quot;addresses&quot;, relationship(Address))</span>
</span><span id="1-983">
</span><span id="1-984"><span class="sd">    This may be used for ORM mappings that aren&#39;t using a declarative</span>
</span><span id="1-985"><span class="sd">    metaclass that intercepts attribute set operations.</span>
</span><span id="1-986">
</span><span id="1-987"><span class="sd">    .. versionadded:: 2.0</span>
</span><span id="1-988">
</span><span id="1-989">
</span><span id="1-990"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-991">    <span class="n">_add_attribute</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">attr</span><span class="p">)</span>
</span><span id="1-992">
</span><span id="1-993">
</span><span id="1-994"><span class="k">def</span> <span class="nf">declarative_base</span><span class="p">(</span>
</span><span id="1-995">    <span class="o">*</span><span class="p">,</span>
</span><span id="1-996">    <span class="n">metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">MetaData</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-997">    <span class="n">mapper</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-998">    <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="nb">object</span><span class="p">,</span>
</span><span id="1-999">    <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Base&quot;</span><span class="p">,</span>
</span><span id="1-1000">    <span class="n">class_registry</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">clsregistry</span><span class="o">.</span><span class="n">_ClsRegistryType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-1001">    <span class="n">type_annotation_map</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_TypeAnnotationMapType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-1002">    <span class="n">constructor</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="n">_declarative_constructor</span><span class="p">,</span>
</span><span id="1-1003">    <span class="n">metaclass</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">DeclarativeMeta</span><span class="p">,</span>
</span><span id="1-1004"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span id="1-1005"><span class="w">    </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Construct a base class for declarative class definitions.</span>
</span><span id="1-1006">
</span><span id="1-1007"><span class="sd">    The new base class will be given a metaclass that produces</span>
</span><span id="1-1008"><span class="sd">    appropriate :class:`~sqlalchemy.schema.Table` objects and makes</span>
</span><span id="1-1009"><span class="sd">    the appropriate :class:`_orm.Mapper` calls based on the</span>
</span><span id="1-1010"><span class="sd">    information provided declaratively in the class and any subclasses</span>
</span><span id="1-1011"><span class="sd">    of the class.</span>
</span><span id="1-1012">
</span><span id="1-1013"><span class="sd">    .. versionchanged:: 2.0 Note that the :func:`_orm.declarative_base`</span>
</span><span id="1-1014"><span class="sd">       function is superseded by the new :class:`_orm.DeclarativeBase` class,</span>
</span><span id="1-1015"><span class="sd">       which generates a new &quot;base&quot; class using subclassing, rather than</span>
</span><span id="1-1016"><span class="sd">       return value of a function.  This allows an approach that is compatible</span>
</span><span id="1-1017"><span class="sd">       with :pep:`484` typing tools.</span>
</span><span id="1-1018">
</span><span id="1-1019"><span class="sd">    The :func:`_orm.declarative_base` function is a shorthand version</span>
</span><span id="1-1020"><span class="sd">    of using the :meth:`_orm.registry.generate_base`</span>
</span><span id="1-1021"><span class="sd">    method.  That is, the following::</span>
</span><span id="1-1022">
</span><span id="1-1023"><span class="sd">        from sqlalchemy.orm import declarative_base</span>
</span><span id="1-1024">
</span><span id="1-1025"><span class="sd">        Base = declarative_base()</span>
</span><span id="1-1026">
</span><span id="1-1027"><span class="sd">    Is equivalent to::</span>
</span><span id="1-1028">
</span><span id="1-1029"><span class="sd">        from sqlalchemy.orm import registry</span>
</span><span id="1-1030">
</span><span id="1-1031"><span class="sd">        mapper_registry = registry()</span>
</span><span id="1-1032"><span class="sd">        Base = mapper_registry.generate_base()</span>
</span><span id="1-1033">
</span><span id="1-1034"><span class="sd">    See the docstring for :class:`_orm.registry`</span>
</span><span id="1-1035"><span class="sd">    and :meth:`_orm.registry.generate_base`</span>
</span><span id="1-1036"><span class="sd">    for more details.</span>
</span><span id="1-1037">
</span><span id="1-1038"><span class="sd">    .. versionchanged:: 1.4  The :func:`_orm.declarative_base`</span>
</span><span id="1-1039"><span class="sd">       function is now a specialization of the more generic</span>
</span><span id="1-1040"><span class="sd">       :class:`_orm.registry` class.  The function also moves to the</span>
</span><span id="1-1041"><span class="sd">       ``sqlalchemy.orm`` package from the ``declarative.ext`` package.</span>
</span><span id="1-1042">
</span><span id="1-1043">
</span><span id="1-1044"><span class="sd">    :param metadata:</span>
</span><span id="1-1045"><span class="sd">      An optional :class:`~sqlalchemy.schema.MetaData` instance.  All</span>
</span><span id="1-1046"><span class="sd">      :class:`~sqlalchemy.schema.Table` objects implicitly declared by</span>
</span><span id="1-1047"><span class="sd">      subclasses of the base will share this MetaData.  A MetaData instance</span>
</span><span id="1-1048"><span class="sd">      will be created if none is provided.  The</span>
</span><span id="1-1049"><span class="sd">      :class:`~sqlalchemy.schema.MetaData` instance will be available via the</span>
</span><span id="1-1050"><span class="sd">      ``metadata`` attribute of the generated declarative base class.</span>
</span><span id="1-1051">
</span><span id="1-1052"><span class="sd">    :param mapper:</span>
</span><span id="1-1053"><span class="sd">      An optional callable, defaults to :class:`_orm.Mapper`. Will</span>
</span><span id="1-1054"><span class="sd">      be used to map subclasses to their Tables.</span>
</span><span id="1-1055">
</span><span id="1-1056"><span class="sd">    :param cls:</span>
</span><span id="1-1057"><span class="sd">      Defaults to :class:`object`. A type to use as the base for the generated</span>
</span><span id="1-1058"><span class="sd">      declarative base class. May be a class or tuple of classes.</span>
</span><span id="1-1059">
</span><span id="1-1060"><span class="sd">    :param name:</span>
</span><span id="1-1061"><span class="sd">      Defaults to ``Base``.  The display name for the generated</span>
</span><span id="1-1062"><span class="sd">      class.  Customizing this is not required, but can improve clarity in</span>
</span><span id="1-1063"><span class="sd">      tracebacks and debugging.</span>
</span><span id="1-1064">
</span><span id="1-1065"><span class="sd">    :param constructor:</span>
</span><span id="1-1066"><span class="sd">      Specify the implementation for the ``__init__`` function on a mapped</span>
</span><span id="1-1067"><span class="sd">      class that has no ``__init__`` of its own.  Defaults to an</span>
</span><span id="1-1068"><span class="sd">      implementation that assigns \**kwargs for declared</span>
</span><span id="1-1069"><span class="sd">      fields and relationships to an instance.  If ``None`` is supplied,</span>
</span><span id="1-1070"><span class="sd">      no __init__ will be provided and construction will fall back to</span>
</span><span id="1-1071"><span class="sd">      cls.__init__ by way of the normal Python semantics.</span>
</span><span id="1-1072">
</span><span id="1-1073"><span class="sd">    :param class_registry: optional dictionary that will serve as the</span>
</span><span id="1-1074"><span class="sd">      registry of class names-&gt; mapped classes when string names</span>
</span><span id="1-1075"><span class="sd">      are used to identify classes inside of :func:`_orm.relationship`</span>
</span><span id="1-1076"><span class="sd">      and others.  Allows two or more declarative base classes</span>
</span><span id="1-1077"><span class="sd">      to share the same registry of class names for simplified</span>
</span><span id="1-1078"><span class="sd">      inter-base relationships.</span>
</span><span id="1-1079">
</span><span id="1-1080"><span class="sd">    :param type_annotation_map: optional dictionary of Python types to</span>
</span><span id="1-1081"><span class="sd">        SQLAlchemy :class:`_types.TypeEngine` classes or instances.  This</span>
</span><span id="1-1082"><span class="sd">        is used exclusively by the :class:`_orm.MappedColumn` construct</span>
</span><span id="1-1083"><span class="sd">        to produce column types based on annotations within the</span>
</span><span id="1-1084"><span class="sd">        :class:`_orm.Mapped` type.</span>
</span><span id="1-1085">
</span><span id="1-1086">
</span><span id="1-1087"><span class="sd">        .. versionadded:: 2.0</span>
</span><span id="1-1088">
</span><span id="1-1089"><span class="sd">        .. seealso::</span>
</span><span id="1-1090">
</span><span id="1-1091"><span class="sd">            :ref:`orm_declarative_mapped_column_type_map`</span>
</span><span id="1-1092">
</span><span id="1-1093"><span class="sd">    :param metaclass:</span>
</span><span id="1-1094"><span class="sd">      Defaults to :class:`.DeclarativeMeta`.  A metaclass or __metaclass__</span>
</span><span id="1-1095"><span class="sd">      compatible callable to use as the meta type of the generated</span>
</span><span id="1-1096"><span class="sd">      declarative base class.</span>
</span><span id="1-1097">
</span><span id="1-1098"><span class="sd">    .. seealso::</span>
</span><span id="1-1099">
</span><span id="1-1100"><span class="sd">        :class:`_orm.registry`</span>
</span><span id="1-1101">
</span><span id="1-1102"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-1103">
</span><span id="1-1104">    <span class="k">return</span> <span class="n">registry</span><span class="p">(</span>
</span><span id="1-1105">        <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span>
</span><span id="1-1106">        <span class="n">class_registry</span><span class="o">=</span><span class="n">class_registry</span><span class="p">,</span>
</span><span id="1-1107">        <span class="n">constructor</span><span class="o">=</span><span class="n">constructor</span><span class="p">,</span>
</span><span id="1-1108">        <span class="n">type_annotation_map</span><span class="o">=</span><span class="n">type_annotation_map</span><span class="p">,</span>
</span><span id="1-1109">    <span class="p">)</span><span class="o">.</span><span class="n">generate_base</span><span class="p">(</span>
</span><span id="1-1110">        <span class="n">mapper</span><span class="o">=</span><span class="n">mapper</span><span class="p">,</span>
</span><span id="1-1111">        <span class="bp">cls</span><span class="o">=</span><span class="bp">cls</span><span class="p">,</span>
</span><span id="1-1112">        <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span>
</span><span id="1-1113">        <span class="n">metaclass</span><span class="o">=</span><span class="n">metaclass</span><span class="p">,</span>
</span><span id="1-1114">    <span class="p">)</span>
</span><span id="1-1115">
</span><span id="1-1116">
</span><span id="1-1117"><span class="k">class</span> <span class="nc">registry</span><span class="p">:</span>
</span><span id="1-1118"><span class="w">    </span><span class="sd">&quot;&quot;&quot;Generalized registry for mapping classes.</span>
</span><span id="1-1119">
</span><span id="1-1120"><span class="sd">    The :class:`_orm.registry` serves as the basis for maintaining a collection</span>
</span><span id="1-1121"><span class="sd">    of mappings, and provides configurational hooks used to map classes.</span>
</span><span id="1-1122">
</span><span id="1-1123"><span class="sd">    The three general kinds of mappings supported are Declarative Base,</span>
</span><span id="1-1124"><span class="sd">    Declarative Decorator, and Imperative Mapping.   All of these mapping</span>
</span><span id="1-1125"><span class="sd">    styles may be used interchangeably:</span>
</span><span id="1-1126">
</span><span id="1-1127"><span class="sd">    * :meth:`_orm.registry.generate_base` returns a new declarative base</span>
</span><span id="1-1128"><span class="sd">      class, and is the underlying implementation of the</span>
</span><span id="1-1129"><span class="sd">      :func:`_orm.declarative_base` function.</span>
</span><span id="1-1130">
</span><span id="1-1131"><span class="sd">    * :meth:`_orm.registry.mapped` provides a class decorator that will</span>
</span><span id="1-1132"><span class="sd">      apply declarative mapping to a class without the use of a declarative</span>
</span><span id="1-1133"><span class="sd">      base class.</span>
</span><span id="1-1134">
</span><span id="1-1135"><span class="sd">    * :meth:`_orm.registry.map_imperatively` will produce a</span>
</span><span id="1-1136"><span class="sd">      :class:`_orm.Mapper` for a class without scanning the class for</span>
</span><span id="1-1137"><span class="sd">      declarative class attributes. This method suits the use case historically</span>
</span><span id="1-1138"><span class="sd">      provided by the ``sqlalchemy.orm.mapper()`` classical mapping function,</span>
</span><span id="1-1139"><span class="sd">      which is removed as of SQLAlchemy 2.0.</span>
</span><span id="1-1140">
</span><span id="1-1141"><span class="sd">    .. versionadded:: 1.4</span>
</span><span id="1-1142">
</span><span id="1-1143"><span class="sd">    .. seealso::</span>
</span><span id="1-1144">
</span><span id="1-1145"><span class="sd">        :ref:`orm_mapping_classes_toplevel` - overview of class mapping</span>
</span><span id="1-1146"><span class="sd">        styles.</span>
</span><span id="1-1147">
</span><span id="1-1148"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-1149">
</span><span id="1-1150">    <span class="n">_class_registry</span><span class="p">:</span> <span class="n">clsregistry</span><span class="o">.</span><span class="n">_ClsRegistryType</span>
</span><span id="1-1151">    <span class="n">_managers</span><span class="p">:</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">[</span><span class="n">ClassManager</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">True</span><span class="p">]]</span>
</span><span id="1-1152">    <span class="n">_non_primary_mappers</span><span class="p">:</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">[</span><span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">True</span><span class="p">]]</span>
</span><span id="1-1153">    <span class="n">metadata</span><span class="p">:</span> <span class="n">MetaData</span>
</span><span id="1-1154">    <span class="n">constructor</span><span class="p">:</span> <span class="n">CallableReference</span><span class="p">[</span><span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]]</span>
</span><span id="1-1155">    <span class="n">type_annotation_map</span><span class="p">:</span> <span class="n">_MutableTypeAnnotationMapType</span>
</span><span id="1-1156">    <span class="n">_dependents</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">_RegistryType</span><span class="p">]</span>
</span><span id="1-1157">    <span class="n">_dependencies</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">_RegistryType</span><span class="p">]</span>
</span><span id="1-1158">    <span class="n">_new_mappers</span><span class="p">:</span> <span class="nb">bool</span>
</span><span id="1-1159">
</span><span id="1-1160">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="1-1161">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1162">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-1163">        <span class="n">metadata</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">MetaData</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-1164">        <span class="n">class_registry</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">clsregistry</span><span class="o">.</span><span class="n">_ClsRegistryType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-1165">        <span class="n">type_annotation_map</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_TypeAnnotationMapType</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-1166">        <span class="n">constructor</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="n">_declarative_constructor</span><span class="p">,</span>
</span><span id="1-1167">    <span class="p">):</span>
</span><span id="1-1168"><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Construct a new :class:`_orm.registry`</span>
</span><span id="1-1169">
</span><span id="1-1170"><span class="sd">        :param metadata:</span>
</span><span id="1-1171"><span class="sd">          An optional :class:`_schema.MetaData` instance.  All</span>
</span><span id="1-1172"><span class="sd">          :class:`_schema.Table` objects generated using declarative</span>
</span><span id="1-1173"><span class="sd">          table mapping will make use of this :class:`_schema.MetaData`</span>
</span><span id="1-1174"><span class="sd">          collection.  If this argument is left at its default of ``None``,</span>
</span><span id="1-1175"><span class="sd">          a blank :class:`_schema.MetaData` collection is created.</span>
</span><span id="1-1176">
</span><span id="1-1177"><span class="sd">        :param constructor:</span>
</span><span id="1-1178"><span class="sd">          Specify the implementation for the ``__init__`` function on a mapped</span>
</span><span id="1-1179"><span class="sd">          class that has no ``__init__`` of its own.  Defaults to an</span>
</span><span id="1-1180"><span class="sd">          implementation that assigns \**kwargs for declared</span>
</span><span id="1-1181"><span class="sd">          fields and relationships to an instance.  If ``None`` is supplied,</span>
</span><span id="1-1182"><span class="sd">          no __init__ will be provided and construction will fall back to</span>
</span><span id="1-1183"><span class="sd">          cls.__init__ by way of the normal Python semantics.</span>
</span><span id="1-1184">
</span><span id="1-1185"><span class="sd">        :param class_registry: optional dictionary that will serve as the</span>
</span><span id="1-1186"><span class="sd">          registry of class names-&gt; mapped classes when string names</span>
</span><span id="1-1187"><span class="sd">          are used to identify classes inside of :func:`_orm.relationship`</span>
</span><span id="1-1188"><span class="sd">          and others.  Allows two or more declarative base classes</span>
</span><span id="1-1189"><span class="sd">          to share the same registry of class names for simplified</span>
</span><span id="1-1190"><span class="sd">          inter-base relationships.</span>
</span><span id="1-1191">
</span><span id="1-1192"><span class="sd">        :param type_annotation_map: optional dictionary of Python types to</span>
</span><span id="1-1193"><span class="sd">          SQLAlchemy :class:`_types.TypeEngine` classes or instances.</span>
</span><span id="1-1194"><span class="sd">          The provided dict will update the default type mapping.  This</span>
</span><span id="1-1195"><span class="sd">          is used exclusively by the :class:`_orm.MappedColumn` construct</span>
</span><span id="1-1196"><span class="sd">          to produce column types based on annotations within the</span>
</span><span id="1-1197"><span class="sd">          :class:`_orm.Mapped` type.</span>
</span><span id="1-1198">
</span><span id="1-1199"><span class="sd">          .. versionadded:: 2.0</span>
</span><span id="1-1200">
</span><span id="1-1201"><span class="sd">          .. seealso::</span>
</span><span id="1-1202">
</span><span id="1-1203"><span class="sd">              :ref:`orm_declarative_mapped_column_type_map`</span>
</span><span id="1-1204">
</span><span id="1-1205">
</span><span id="1-1206"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-1207">        <span class="n">lcl_metadata</span> <span class="o">=</span> <span class="n">metadata</span> <span class="ow">or</span> <span class="n">MetaData</span><span class="p">()</span>
</span><span id="1-1208">
</span><span id="1-1209">        <span class="k">if</span> <span class="n">class_registry</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1210">            <span class="n">class_registry</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakValueDictionary</span><span class="p">()</span>
</span><span id="1-1211">
</span><span id="1-1212">        <span class="bp">self</span><span class="o">.</span><span class="n">_class_registry</span> <span class="o">=</span> <span class="n">class_registry</span>
</span><span id="1-1213">        <span class="bp">self</span><span class="o">.</span><span class="n">_managers</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">()</span>
</span><span id="1-1214">        <span class="bp">self</span><span class="o">.</span><span class="n">_non_primary_mappers</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">WeakKeyDictionary</span><span class="p">()</span>
</span><span id="1-1215">        <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span> <span class="o">=</span> <span class="n">lcl_metadata</span>
</span><span id="1-1216">        <span class="bp">self</span><span class="o">.</span><span class="n">constructor</span> <span class="o">=</span> <span class="n">constructor</span>
</span><span id="1-1217">        <span class="bp">self</span><span class="o">.</span><span class="n">type_annotation_map</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="1-1218">        <span class="k">if</span> <span class="n">type_annotation_map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1219">            <span class="bp">self</span><span class="o">.</span><span class="n">update_type_annotation_map</span><span class="p">(</span><span class="n">type_annotation_map</span><span class="p">)</span>
</span><span id="1-1220">        <span class="bp">self</span><span class="o">.</span><span class="n">_dependents</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="1-1221">        <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="1-1222">
</span><span id="1-1223">        <span class="bp">self</span><span class="o">.</span><span class="n">_new_mappers</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-1224">
</span><span id="1-1225">        <span class="k">with</span> <span class="n">mapperlib</span><span class="o">.</span><span class="n">_CONFIGURE_MUTEX</span><span class="p">:</span>
</span><span id="1-1226">            <span class="n">mapperlib</span><span class="o">.</span><span class="n">_mapper_registries</span><span class="p">[</span><span class="bp">self</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="1-1227">
</span><span id="1-1228">    <span class="k">def</span> <span class="nf">update_type_annotation_map</span><span class="p">(</span>
</span><span id="1-1229">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1230">        <span class="n">type_annotation_map</span><span class="p">:</span> <span class="n">_TypeAnnotationMapType</span><span class="p">,</span>
</span><span id="1-1231">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1232"><span class="w">        </span><span class="sd">&quot;&quot;&quot;update the :paramref:`_orm.registry.type_annotation_map` with new</span>
</span><span id="1-1233"><span class="sd">        values.&quot;&quot;&quot;</span>
</span><span id="1-1234">
</span><span id="1-1235">        <span class="bp">self</span><span class="o">.</span><span class="n">type_annotation_map</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
</span><span id="1-1236">            <span class="p">{</span>
</span><span id="1-1237">                <span class="n">sub_type</span><span class="p">:</span> <span class="n">sqltype</span>
</span><span id="1-1238">                <span class="k">for</span> <span class="n">typ</span><span class="p">,</span> <span class="n">sqltype</span> <span class="ow">in</span> <span class="n">type_annotation_map</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="1-1239">                <span class="k">for</span> <span class="n">sub_type</span> <span class="ow">in</span> <span class="n">compat_typing</span><span class="o">.</span><span class="n">expand_unions</span><span class="p">(</span>
</span><span id="1-1240">                    <span class="n">typ</span><span class="p">,</span> <span class="n">include_union</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">discard_none</span><span class="o">=</span><span class="kc">True</span>
</span><span id="1-1241">                <span class="p">)</span>
</span><span id="1-1242">            <span class="p">}</span>
</span><span id="1-1243">        <span class="p">)</span>
</span><span id="1-1244">
</span><span id="1-1245">    <span class="k">def</span> <span class="nf">_resolve_type</span><span class="p">(</span>
</span><span id="1-1246">        <span class="bp">self</span><span class="p">,</span> <span class="n">python_type</span><span class="p">:</span> <span class="n">_MatchedOnType</span>
</span><span id="1-1247">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">sqltypes</span><span class="o">.</span><span class="n">TypeEngine</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
</span><span id="1-1248">        <span class="n">search</span><span class="p">:</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">_MatchedOnType</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span>
</span><span id="1-1249">        <span class="n">python_type_type</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
</span><span id="1-1250">
</span><span id="1-1251">        <span class="k">if</span> <span class="n">is_generic</span><span class="p">(</span><span class="n">python_type</span><span class="p">):</span>
</span><span id="1-1252">            <span class="k">if</span> <span class="n">is_literal</span><span class="p">(</span><span class="n">python_type</span><span class="p">):</span>
</span><span id="1-1253">                <span class="n">python_type_type</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;Type[Any]&quot;</span><span class="p">,</span> <span class="n">python_type</span><span class="p">)</span>
</span><span id="1-1254">
</span><span id="1-1255">                <span class="n">search</span> <span class="o">=</span> <span class="p">(</span>  <span class="c1"># type: ignore[assignment]</span>
</span><span id="1-1256">                    <span class="p">(</span><span class="n">python_type</span><span class="p">,</span> <span class="n">python_type_type</span><span class="p">),</span>
</span><span id="1-1257">                    <span class="p">(</span><span class="n">Literal</span><span class="p">,</span> <span class="n">python_type_type</span><span class="p">),</span>
</span><span id="1-1258">                <span class="p">)</span>
</span><span id="1-1259">            <span class="k">else</span><span class="p">:</span>
</span><span id="1-1260">                <span class="n">python_type_type</span> <span class="o">=</span> <span class="n">python_type</span><span class="o">.</span><span class="n">__origin__</span>
</span><span id="1-1261">                <span class="n">search</span> <span class="o">=</span> <span class="p">((</span><span class="n">python_type</span><span class="p">,</span> <span class="n">python_type_type</span><span class="p">),)</span>
</span><span id="1-1262">        <span class="k">elif</span> <span class="n">is_newtype</span><span class="p">(</span><span class="n">python_type</span><span class="p">):</span>
</span><span id="1-1263">            <span class="n">python_type_type</span> <span class="o">=</span> <span class="n">flatten_newtype</span><span class="p">(</span><span class="n">python_type</span><span class="p">)</span>
</span><span id="1-1264">            <span class="n">search</span> <span class="o">=</span> <span class="p">((</span><span class="n">python_type</span><span class="p">,</span> <span class="n">python_type_type</span><span class="p">),)</span>
</span><span id="1-1265">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-1266">            <span class="n">python_type_type</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;Type[Any]&quot;</span><span class="p">,</span> <span class="n">python_type</span><span class="p">)</span>
</span><span id="1-1267">            <span class="n">flattened</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-1268">            <span class="n">search</span> <span class="o">=</span> <span class="p">((</span><span class="n">pt</span><span class="p">,</span> <span class="n">pt</span><span class="p">)</span> <span class="k">for</span> <span class="n">pt</span> <span class="ow">in</span> <span class="n">python_type_type</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">)</span>
</span><span id="1-1269">
</span><span id="1-1270">        <span class="k">for</span> <span class="n">pt</span><span class="p">,</span> <span class="n">flattened</span> <span class="ow">in</span> <span class="n">search</span><span class="p">:</span>
</span><span id="1-1271">            <span class="c1"># we search through full __mro__ for types.  however...</span>
</span><span id="1-1272">            <span class="n">sql_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">type_annotation_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>
</span><span id="1-1273">            <span class="k">if</span> <span class="n">sql_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1274">                <span class="n">sql_type</span> <span class="o">=</span> <span class="n">sqltypes</span><span class="o">.</span><span class="n">_type_map_get</span><span class="p">(</span><span class="n">pt</span><span class="p">)</span>  <span class="c1"># type: ignore  # noqa: E501</span>
</span><span id="1-1275">
</span><span id="1-1276">            <span class="k">if</span> <span class="n">sql_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1277">                <span class="n">sql_type_inst</span> <span class="o">=</span> <span class="n">sqltypes</span><span class="o">.</span><span class="n">to_instance</span><span class="p">(</span><span class="n">sql_type</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
</span><span id="1-1278">
</span><span id="1-1279">                <span class="c1"># ... this additional step will reject most</span>
</span><span id="1-1280">                <span class="c1"># type -&gt; supertype matches, such as if we had</span>
</span><span id="1-1281">                <span class="c1"># a MyInt(int) subclass.  note also we pass NewType()</span>
</span><span id="1-1282">                <span class="c1"># here directly; these always have to be in the</span>
</span><span id="1-1283">                <span class="c1"># type_annotation_map to be useful</span>
</span><span id="1-1284">                <span class="n">resolved_sql_type</span> <span class="o">=</span> <span class="n">sql_type_inst</span><span class="o">.</span><span class="n">_resolve_for_python_type</span><span class="p">(</span>
</span><span id="1-1285">                    <span class="n">python_type_type</span><span class="p">,</span>
</span><span id="1-1286">                    <span class="n">pt</span><span class="p">,</span>
</span><span id="1-1287">                    <span class="n">flattened</span><span class="p">,</span>
</span><span id="1-1288">                <span class="p">)</span>
</span><span id="1-1289">                <span class="k">if</span> <span class="n">resolved_sql_type</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1290">                    <span class="k">return</span> <span class="n">resolved_sql_type</span>
</span><span id="1-1291">
</span><span id="1-1292">        <span class="k">return</span> <span class="kc">None</span>
</span><span id="1-1293">
</span><span id="1-1294">    <span class="nd">@property</span>
</span><span id="1-1295">    <span class="k">def</span> <span class="nf">mappers</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">FrozenSet</span><span class="p">[</span><span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
</span><span id="1-1296"><span class="w">        </span><span class="sd">&quot;&quot;&quot;read only collection of all :class:`_orm.Mapper` objects.&quot;&quot;&quot;</span>
</span><span id="1-1297">
</span><span id="1-1298">        <span class="k">return</span> <span class="nb">frozenset</span><span class="p">(</span><span class="n">manager</span><span class="o">.</span><span class="n">mapper</span> <span class="k">for</span> <span class="n">manager</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_managers</span><span class="p">)</span><span class="o">.</span><span class="n">union</span><span class="p">(</span>
</span><span id="1-1299">            <span class="bp">self</span><span class="o">.</span><span class="n">_non_primary_mappers</span>
</span><span id="1-1300">        <span class="p">)</span>
</span><span id="1-1301">
</span><span id="1-1302">    <span class="k">def</span> <span class="nf">_set_depends_on</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">registry</span><span class="p">:</span> <span class="n">RegistryType</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1303">        <span class="k">if</span> <span class="n">registry</span> <span class="ow">is</span> <span class="bp">self</span><span class="p">:</span>
</span><span id="1-1304">            <span class="k">return</span>
</span><span id="1-1305">        <span class="n">registry</span><span class="o">.</span><span class="n">_dependents</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="1-1306">        <span class="bp">self</span><span class="o">.</span><span class="n">_dependencies</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">registry</span><span class="p">)</span>
</span><span id="1-1307">
</span><span id="1-1308">    <span class="k">def</span> <span class="nf">_flag_new_mapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapper</span><span class="p">:</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1309">        <span class="n">mapper</span><span class="o">.</span><span class="n">_ready_for_configure</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="1-1310">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_new_mappers</span><span class="p">:</span>
</span><span id="1-1311">            <span class="k">return</span>
</span><span id="1-1312">
</span><span id="1-1313">        <span class="k">for</span> <span class="n">reg</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_recurse_with_dependents</span><span class="p">({</span><span class="bp">self</span><span class="p">}):</span>
</span><span id="1-1314">            <span class="n">reg</span><span class="o">.</span><span class="n">_new_mappers</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="1-1315">
</span><span id="1-1316">    <span class="nd">@classmethod</span>
</span><span id="1-1317">    <span class="k">def</span> <span class="nf">_recurse_with_dependents</span><span class="p">(</span>
</span><span id="1-1318">        <span class="bp">cls</span><span class="p">,</span> <span class="n">registries</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">RegistryType</span><span class="p">]</span>
</span><span id="1-1319">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">RegistryType</span><span class="p">]:</span>
</span><span id="1-1320">        <span class="n">todo</span> <span class="o">=</span> <span class="n">registries</span>
</span><span id="1-1321">        <span class="n">done</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="1-1322">        <span class="k">while</span> <span class="n">todo</span><span class="p">:</span>
</span><span id="1-1323">            <span class="n">reg</span> <span class="o">=</span> <span class="n">todo</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span><span id="1-1324">            <span class="n">done</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span>
</span><span id="1-1325">
</span><span id="1-1326">            <span class="c1"># if yielding would remove dependents, make sure we have</span>
</span><span id="1-1327">            <span class="c1"># them before</span>
</span><span id="1-1328">            <span class="n">todo</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">reg</span><span class="o">.</span><span class="n">_dependents</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">done</span><span class="p">))</span>
</span><span id="1-1329">            <span class="k">yield</span> <span class="n">reg</span>
</span><span id="1-1330">
</span><span id="1-1331">            <span class="c1"># if yielding would add dependents, make sure we have them</span>
</span><span id="1-1332">            <span class="c1"># after</span>
</span><span id="1-1333">            <span class="n">todo</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">reg</span><span class="o">.</span><span class="n">_dependents</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">done</span><span class="p">))</span>
</span><span id="1-1334">
</span><span id="1-1335">    <span class="nd">@classmethod</span>
</span><span id="1-1336">    <span class="k">def</span> <span class="nf">_recurse_with_dependencies</span><span class="p">(</span>
</span><span id="1-1337">        <span class="bp">cls</span><span class="p">,</span> <span class="n">registries</span><span class="p">:</span> <span class="n">Set</span><span class="p">[</span><span class="n">RegistryType</span><span class="p">]</span>
</span><span id="1-1338">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">RegistryType</span><span class="p">]:</span>
</span><span id="1-1339">        <span class="n">todo</span> <span class="o">=</span> <span class="n">registries</span>
</span><span id="1-1340">        <span class="n">done</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
</span><span id="1-1341">        <span class="k">while</span> <span class="n">todo</span><span class="p">:</span>
</span><span id="1-1342">            <span class="n">reg</span> <span class="o">=</span> <span class="n">todo</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</span><span id="1-1343">            <span class="n">done</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">reg</span><span class="p">)</span>
</span><span id="1-1344">
</span><span id="1-1345">            <span class="c1"># if yielding would remove dependencies, make sure we have</span>
</span><span id="1-1346">            <span class="c1"># them before</span>
</span><span id="1-1347">            <span class="n">todo</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">reg</span><span class="o">.</span><span class="n">_dependencies</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">done</span><span class="p">))</span>
</span><span id="1-1348">
</span><span id="1-1349">            <span class="k">yield</span> <span class="n">reg</span>
</span><span id="1-1350">
</span><span id="1-1351">            <span class="c1"># if yielding would remove dependencies, make sure we have</span>
</span><span id="1-1352">            <span class="c1"># them before</span>
</span><span id="1-1353">            <span class="n">todo</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">reg</span><span class="o">.</span><span class="n">_dependencies</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">done</span><span class="p">))</span>
</span><span id="1-1354">
</span><span id="1-1355">    <span class="k">def</span> <span class="nf">_mappers_to_configure</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Iterator</span><span class="p">[</span><span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
</span><span id="1-1356">        <span class="k">return</span> <span class="n">itertools</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span>
</span><span id="1-1357">            <span class="p">(</span>
</span><span id="1-1358">                <span class="n">manager</span><span class="o">.</span><span class="n">mapper</span>
</span><span id="1-1359">                <span class="k">for</span> <span class="n">manager</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_managers</span><span class="p">)</span>
</span><span id="1-1360">                <span class="k">if</span> <span class="n">manager</span><span class="o">.</span><span class="n">is_mapped</span>
</span><span id="1-1361">                <span class="ow">and</span> <span class="ow">not</span> <span class="n">manager</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">configured</span>
</span><span id="1-1362">                <span class="ow">and</span> <span class="n">manager</span><span class="o">.</span><span class="n">mapper</span><span class="o">.</span><span class="n">_ready_for_configure</span>
</span><span id="1-1363">            <span class="p">),</span>
</span><span id="1-1364">            <span class="p">(</span>
</span><span id="1-1365">                <span class="n">npm</span>
</span><span id="1-1366">                <span class="k">for</span> <span class="n">npm</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_non_primary_mappers</span><span class="p">)</span>
</span><span id="1-1367">                <span class="k">if</span> <span class="ow">not</span> <span class="n">npm</span><span class="o">.</span><span class="n">configured</span> <span class="ow">and</span> <span class="n">npm</span><span class="o">.</span><span class="n">_ready_for_configure</span>
</span><span id="1-1368">            <span class="p">),</span>
</span><span id="1-1369">        <span class="p">)</span>
</span><span id="1-1370">
</span><span id="1-1371">    <span class="k">def</span> <span class="nf">_add_non_primary_mapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">np_mapper</span><span class="p">:</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1372">        <span class="bp">self</span><span class="o">.</span><span class="n">_non_primary_mappers</span><span class="p">[</span><span class="n">np_mapper</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="1-1373">
</span><span id="1-1374">    <span class="k">def</span> <span class="nf">_dispose_cls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1375">        <span class="n">clsregistry</span><span class="o">.</span><span class="n">remove_class</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_class_registry</span><span class="p">)</span>
</span><span id="1-1376">
</span><span id="1-1377">    <span class="k">def</span> <span class="nf">_add_manager</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">manager</span><span class="p">:</span> <span class="n">ClassManager</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1378">        <span class="bp">self</span><span class="o">.</span><span class="n">_managers</span><span class="p">[</span><span class="n">manager</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="1-1379">        <span class="k">if</span> <span class="n">manager</span><span class="o">.</span><span class="n">is_mapped</span><span class="p">:</span>
</span><span id="1-1380">            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span id="1-1381">                <span class="s2">&quot;Class &#39;</span><span class="si">%s</span><span class="s2">&#39; already has a primary mapper defined. &quot;</span>
</span><span id="1-1382">                <span class="o">%</span> <span class="n">manager</span><span class="o">.</span><span class="n">class_</span>
</span><span id="1-1383">            <span class="p">)</span>
</span><span id="1-1384">        <span class="k">assert</span> <span class="n">manager</span><span class="o">.</span><span class="n">registry</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="1-1385">        <span class="n">manager</span><span class="o">.</span><span class="n">registry</span> <span class="o">=</span> <span class="bp">self</span>
</span><span id="1-1386">
</span><span id="1-1387">    <span class="k">def</span> <span class="nf">configure</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cascade</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1388"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Configure all as-yet unconfigured mappers in this</span>
</span><span id="1-1389"><span class="sd">        :class:`_orm.registry`.</span>
</span><span id="1-1390">
</span><span id="1-1391"><span class="sd">        The configure step is used to reconcile and initialize the</span>
</span><span id="1-1392"><span class="sd">        :func:`_orm.relationship` linkages between mapped classes, as well as</span>
</span><span id="1-1393"><span class="sd">        to invoke configuration events such as the</span>
</span><span id="1-1394"><span class="sd">        :meth:`_orm.MapperEvents.before_configured` and</span>
</span><span id="1-1395"><span class="sd">        :meth:`_orm.MapperEvents.after_configured`, which may be used by ORM</span>
</span><span id="1-1396"><span class="sd">        extensions or user-defined extension hooks.</span>
</span><span id="1-1397">
</span><span id="1-1398"><span class="sd">        If one or more mappers in this registry contain</span>
</span><span id="1-1399"><span class="sd">        :func:`_orm.relationship` constructs that refer to mapped classes in</span>
</span><span id="1-1400"><span class="sd">        other registries, this registry is said to be *dependent* on those</span>
</span><span id="1-1401"><span class="sd">        registries. In order to configure those dependent registries</span>
</span><span id="1-1402"><span class="sd">        automatically, the :paramref:`_orm.registry.configure.cascade` flag</span>
</span><span id="1-1403"><span class="sd">        should be set to ``True``. Otherwise, if they are not configured, an</span>
</span><span id="1-1404"><span class="sd">        exception will be raised.  The rationale behind this behavior is to</span>
</span><span id="1-1405"><span class="sd">        allow an application to programmatically invoke configuration of</span>
</span><span id="1-1406"><span class="sd">        registries while controlling whether or not the process implicitly</span>
</span><span id="1-1407"><span class="sd">        reaches other registries.</span>
</span><span id="1-1408">
</span><span id="1-1409"><span class="sd">        As an alternative to invoking :meth:`_orm.registry.configure`, the ORM</span>
</span><span id="1-1410"><span class="sd">        function :func:`_orm.configure_mappers` function may be used to ensure</span>
</span><span id="1-1411"><span class="sd">        configuration is complete for all :class:`_orm.registry` objects in</span>
</span><span id="1-1412"><span class="sd">        memory. This is generally simpler to use and also predates the usage of</span>
</span><span id="1-1413"><span class="sd">        :class:`_orm.registry` objects overall. However, this function will</span>
</span><span id="1-1414"><span class="sd">        impact all mappings throughout the running Python process and may be</span>
</span><span id="1-1415"><span class="sd">        more memory/time consuming for an application that has many registries</span>
</span><span id="1-1416"><span class="sd">        in use for different purposes that may not be needed immediately.</span>
</span><span id="1-1417">
</span><span id="1-1418"><span class="sd">        .. seealso::</span>
</span><span id="1-1419">
</span><span id="1-1420"><span class="sd">            :func:`_orm.configure_mappers`</span>
</span><span id="1-1421">
</span><span id="1-1422">
</span><span id="1-1423"><span class="sd">        .. versionadded:: 1.4.0b2</span>
</span><span id="1-1424">
</span><span id="1-1425"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-1426">        <span class="n">mapperlib</span><span class="o">.</span><span class="n">_configure_registries</span><span class="p">({</span><span class="bp">self</span><span class="p">},</span> <span class="n">cascade</span><span class="o">=</span><span class="n">cascade</span><span class="p">)</span>
</span><span id="1-1427">
</span><span id="1-1428">    <span class="k">def</span> <span class="nf">dispose</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cascade</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1429"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Dispose of all mappers in this :class:`_orm.registry`.</span>
</span><span id="1-1430">
</span><span id="1-1431"><span class="sd">        After invocation, all the classes that were mapped within this registry</span>
</span><span id="1-1432"><span class="sd">        will no longer have class instrumentation associated with them. This</span>
</span><span id="1-1433"><span class="sd">        method is the per-:class:`_orm.registry` analogue to the</span>
</span><span id="1-1434"><span class="sd">        application-wide :func:`_orm.clear_mappers` function.</span>
</span><span id="1-1435">
</span><span id="1-1436"><span class="sd">        If this registry contains mappers that are dependencies of other</span>
</span><span id="1-1437"><span class="sd">        registries, typically via :func:`_orm.relationship` links, then those</span>
</span><span id="1-1438"><span class="sd">        registries must be disposed as well. When such registries exist in</span>
</span><span id="1-1439"><span class="sd">        relation to this one, their :meth:`_orm.registry.dispose` method will</span>
</span><span id="1-1440"><span class="sd">        also be called, if the :paramref:`_orm.registry.dispose.cascade` flag</span>
</span><span id="1-1441"><span class="sd">        is set to ``True``; otherwise, an error is raised if those registries</span>
</span><span id="1-1442"><span class="sd">        were not already disposed.</span>
</span><span id="1-1443">
</span><span id="1-1444"><span class="sd">        .. versionadded:: 1.4.0b2</span>
</span><span id="1-1445">
</span><span id="1-1446"><span class="sd">        .. seealso::</span>
</span><span id="1-1447">
</span><span id="1-1448"><span class="sd">            :func:`_orm.clear_mappers`</span>
</span><span id="1-1449">
</span><span id="1-1450"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-1451">
</span><span id="1-1452">        <span class="n">mapperlib</span><span class="o">.</span><span class="n">_dispose_registries</span><span class="p">({</span><span class="bp">self</span><span class="p">},</span> <span class="n">cascade</span><span class="o">=</span><span class="n">cascade</span><span class="p">)</span>
</span><span id="1-1453">
</span><span id="1-1454">    <span class="k">def</span> <span class="nf">_dispose_manager_and_mapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">manager</span><span class="p">:</span> <span class="n">ClassManager</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1455">        <span class="k">if</span> <span class="s2">&quot;mapper&quot;</span> <span class="ow">in</span> <span class="n">manager</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
</span><span id="1-1456">            <span class="n">mapper</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">mapper</span>
</span><span id="1-1457">
</span><span id="1-1458">            <span class="n">mapper</span><span class="o">.</span><span class="n">_set_dispose_flags</span><span class="p">()</span>
</span><span id="1-1459">
</span><span id="1-1460">        <span class="n">class_</span> <span class="o">=</span> <span class="n">manager</span><span class="o">.</span><span class="n">class_</span>
</span><span id="1-1461">        <span class="bp">self</span><span class="o">.</span><span class="n">_dispose_cls</span><span class="p">(</span><span class="n">class_</span><span class="p">)</span>
</span><span id="1-1462">        <span class="n">instrumentation</span><span class="o">.</span><span class="n">_instrumentation_factory</span><span class="o">.</span><span class="n">unregister</span><span class="p">(</span><span class="n">class_</span><span class="p">)</span>
</span><span id="1-1463">
</span><span id="1-1464">    <span class="k">def</span> <span class="nf">generate_base</span><span class="p">(</span>
</span><span id="1-1465">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1466">        <span class="n">mapper</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-1467">        <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="nb">object</span><span class="p">,</span>
</span><span id="1-1468">        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Base&quot;</span><span class="p">,</span>
</span><span id="1-1469">        <span class="n">metaclass</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="n">DeclarativeMeta</span><span class="p">,</span>
</span><span id="1-1470">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span id="1-1471"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate a declarative base class.</span>
</span><span id="1-1472">
</span><span id="1-1473"><span class="sd">        Classes that inherit from the returned class object will be</span>
</span><span id="1-1474"><span class="sd">        automatically mapped using declarative mapping.</span>
</span><span id="1-1475">
</span><span id="1-1476"><span class="sd">        E.g.::</span>
</span><span id="1-1477">
</span><span id="1-1478"><span class="sd">            from sqlalchemy.orm import registry</span>
</span><span id="1-1479">
</span><span id="1-1480"><span class="sd">            mapper_registry = registry()</span>
</span><span id="1-1481">
</span><span id="1-1482"><span class="sd">            Base = mapper_registry.generate_base()</span>
</span><span id="1-1483">
</span><span id="1-1484"><span class="sd">            class MyClass(Base):</span>
</span><span id="1-1485"><span class="sd">                __tablename__ = &quot;my_table&quot;</span>
</span><span id="1-1486"><span class="sd">                id = Column(Integer, primary_key=True)</span>
</span><span id="1-1487">
</span><span id="1-1488"><span class="sd">        The above dynamically generated class is equivalent to the</span>
</span><span id="1-1489"><span class="sd">        non-dynamic example below::</span>
</span><span id="1-1490">
</span><span id="1-1491"><span class="sd">            from sqlalchemy.orm import registry</span>
</span><span id="1-1492"><span class="sd">            from sqlalchemy.orm.decl_api import DeclarativeMeta</span>
</span><span id="1-1493">
</span><span id="1-1494"><span class="sd">            mapper_registry = registry()</span>
</span><span id="1-1495">
</span><span id="1-1496"><span class="sd">            class Base(metaclass=DeclarativeMeta):</span>
</span><span id="1-1497"><span class="sd">                __abstract__ = True</span>
</span><span id="1-1498"><span class="sd">                registry = mapper_registry</span>
</span><span id="1-1499"><span class="sd">                metadata = mapper_registry.metadata</span>
</span><span id="1-1500">
</span><span id="1-1501"><span class="sd">                __init__ = mapper_registry.constructor</span>
</span><span id="1-1502">
</span><span id="1-1503"><span class="sd">        .. versionchanged:: 2.0 Note that the</span>
</span><span id="1-1504"><span class="sd">           :meth:`_orm.registry.generate_base` method is superseded by the new</span>
</span><span id="1-1505"><span class="sd">           :class:`_orm.DeclarativeBase` class, which generates a new &quot;base&quot;</span>
</span><span id="1-1506"><span class="sd">           class using subclassing, rather than return value of a function.</span>
</span><span id="1-1507"><span class="sd">           This allows an approach that is compatible with :pep:`484` typing</span>
</span><span id="1-1508"><span class="sd">           tools.</span>
</span><span id="1-1509">
</span><span id="1-1510"><span class="sd">        The :meth:`_orm.registry.generate_base` method provides the</span>
</span><span id="1-1511"><span class="sd">        implementation for the :func:`_orm.declarative_base` function, which</span>
</span><span id="1-1512"><span class="sd">        creates the :class:`_orm.registry` and base class all at once.</span>
</span><span id="1-1513">
</span><span id="1-1514"><span class="sd">        See the section :ref:`orm_declarative_mapping` for background and</span>
</span><span id="1-1515"><span class="sd">        examples.</span>
</span><span id="1-1516">
</span><span id="1-1517"><span class="sd">        :param mapper:</span>
</span><span id="1-1518"><span class="sd">          An optional callable, defaults to :class:`_orm.Mapper`.</span>
</span><span id="1-1519"><span class="sd">          This function is used to generate new :class:`_orm.Mapper` objects.</span>
</span><span id="1-1520">
</span><span id="1-1521"><span class="sd">        :param cls:</span>
</span><span id="1-1522"><span class="sd">          Defaults to :class:`object`. A type to use as the base for the</span>
</span><span id="1-1523"><span class="sd">          generated declarative base class. May be a class or tuple of classes.</span>
</span><span id="1-1524">
</span><span id="1-1525"><span class="sd">        :param name:</span>
</span><span id="1-1526"><span class="sd">          Defaults to ``Base``.  The display name for the generated</span>
</span><span id="1-1527"><span class="sd">          class.  Customizing this is not required, but can improve clarity in</span>
</span><span id="1-1528"><span class="sd">          tracebacks and debugging.</span>
</span><span id="1-1529">
</span><span id="1-1530"><span class="sd">        :param metaclass:</span>
</span><span id="1-1531"><span class="sd">          Defaults to :class:`.DeclarativeMeta`.  A metaclass or __metaclass__</span>
</span><span id="1-1532"><span class="sd">          compatible callable to use as the meta type of the generated</span>
</span><span id="1-1533"><span class="sd">          declarative base class.</span>
</span><span id="1-1534">
</span><span id="1-1535"><span class="sd">        .. seealso::</span>
</span><span id="1-1536">
</span><span id="1-1537"><span class="sd">            :ref:`orm_declarative_mapping`</span>
</span><span id="1-1538">
</span><span id="1-1539"><span class="sd">            :func:`_orm.declarative_base`</span>
</span><span id="1-1540">
</span><span id="1-1541"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-1542">        <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span>
</span><span id="1-1543">
</span><span id="1-1544">        <span class="n">bases</span> <span class="o">=</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="bp">cls</span><span class="p">,)</span> <span class="ow">or</span> <span class="bp">cls</span>
</span><span id="1-1545">
</span><span id="1-1546">        <span class="n">class_dict</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">registry</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">)</span>
</span><span id="1-1547">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="nb">type</span><span class="p">):</span>
</span><span id="1-1548">            <span class="n">class_dict</span><span class="p">[</span><span class="s2">&quot;__doc__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__doc__</span>
</span><span id="1-1549">
</span><span id="1-1550">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">constructor</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1551">            <span class="n">class_dict</span><span class="p">[</span><span class="s2">&quot;__init__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constructor</span>
</span><span id="1-1552">
</span><span id="1-1553">        <span class="n">class_dict</span><span class="p">[</span><span class="s2">&quot;__abstract__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="1-1554">        <span class="k">if</span> <span class="n">mapper</span><span class="p">:</span>
</span><span id="1-1555">            <span class="n">class_dict</span><span class="p">[</span><span class="s2">&quot;__mapper_cls__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mapper</span>
</span><span id="1-1556">
</span><span id="1-1557">        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;__class_getitem__&quot;</span><span class="p">):</span>
</span><span id="1-1558">
</span><span id="1-1559">            <span class="k">def</span> <span class="nf">__class_getitem__</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_T</span><span class="p">],</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span id="1-1560">                <span class="c1"># allow generic classes in py3.9+</span>
</span><span id="1-1561">                <span class="k">return</span> <span class="bp">cls</span>
</span><span id="1-1562">
</span><span id="1-1563">            <span class="n">class_dict</span><span class="p">[</span><span class="s2">&quot;__class_getitem__&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">__class_getitem__</span>
</span><span id="1-1564">
</span><span id="1-1565">        <span class="k">return</span> <span class="n">metaclass</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">bases</span><span class="p">,</span> <span class="n">class_dict</span><span class="p">)</span>
</span><span id="1-1566">
</span><span id="1-1567">    <span class="nd">@compat_typing</span><span class="o">.</span><span class="n">dataclass_transform</span><span class="p">(</span>
</span><span id="1-1568">        <span class="n">field_specifiers</span><span class="o">=</span><span class="p">(</span>
</span><span id="1-1569">            <span class="n">MappedColumn</span><span class="p">,</span>
</span><span id="1-1570">            <span class="n">RelationshipProperty</span><span class="p">,</span>
</span><span id="1-1571">            <span class="n">Composite</span><span class="p">,</span>
</span><span id="1-1572">            <span class="n">Synonym</span><span class="p">,</span>
</span><span id="1-1573">            <span class="n">mapped_column</span><span class="p">,</span>
</span><span id="1-1574">            <span class="n">relationship</span><span class="p">,</span>
</span><span id="1-1575">            <span class="n">composite</span><span class="p">,</span>
</span><span id="1-1576">            <span class="n">synonym</span><span class="p">,</span>
</span><span id="1-1577">            <span class="n">deferred</span><span class="p">,</span>
</span><span id="1-1578">        <span class="p">),</span>
</span><span id="1-1579">    <span class="p">)</span>
</span><span id="1-1580">    <span class="nd">@overload</span>
</span><span id="1-1581">    <span class="k">def</span> <span class="nf">mapped_as_dataclass</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">__cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">]:</span>
</span><span id="1-1582">        <span class="o">...</span>
</span><span id="1-1583">
</span><span id="1-1584">    <span class="nd">@overload</span>
</span><span id="1-1585">    <span class="k">def</span> <span class="nf">mapped_as_dataclass</span><span class="p">(</span>
</span><span id="1-1586">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1587">        <span class="n">__cls</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span id="1-1588">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-1589">        <span class="n">init</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span id="1-1590">        <span class="nb">repr</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>  <span class="c1"># noqa: A002</span>
</span><span id="1-1591">        <span class="n">eq</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span id="1-1592">        <span class="n">order</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span id="1-1593">        <span class="n">unsafe_hash</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span id="1-1594">        <span class="n">match_args</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span id="1-1595">        <span class="n">kw_only</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span id="1-1596">        <span class="n">dataclass_callable</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span> <span class="o">=</span> <span class="o">...</span><span class="p">,</span>
</span><span id="1-1597">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">]],</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">]]:</span>
</span><span id="1-1598">        <span class="o">...</span>
</span><span id="1-1599">
</span><span id="1-1600">    <span class="k">def</span> <span class="nf">mapped_as_dataclass</span><span class="p">(</span>
</span><span id="1-1601">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1602">        <span class="n">__cls</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-1603">        <span class="o">*</span><span class="p">,</span>
</span><span id="1-1604">        <span class="n">init</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">,</span>
</span><span id="1-1605">        <span class="nb">repr</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">,</span>  <span class="c1"># noqa: A002</span>
</span><span id="1-1606">        <span class="n">eq</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">,</span>
</span><span id="1-1607">        <span class="n">order</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">,</span>
</span><span id="1-1608">        <span class="n">unsafe_hash</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">,</span>
</span><span id="1-1609">        <span class="n">match_args</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">,</span>
</span><span id="1-1610">        <span class="n">kw_only</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span> <span class="o">=</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">,</span>
</span><span id="1-1611">        <span class="n">dataclass_callable</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span>
</span><span id="1-1612">            <span class="n">_NoArg</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
</span><span id="1-1613">        <span class="p">]</span> <span class="o">=</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">,</span>
</span><span id="1-1614">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">]],</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">]]]:</span>
</span><span id="1-1615"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Class decorator that will apply the Declarative mapping process</span>
</span><span id="1-1616"><span class="sd">        to a given class, and additionally convert the class to be a</span>
</span><span id="1-1617"><span class="sd">        Python dataclass.</span>
</span><span id="1-1618">
</span><span id="1-1619"><span class="sd">        .. seealso::</span>
</span><span id="1-1620">
</span><span id="1-1621"><span class="sd">            :ref:`orm_declarative_native_dataclasses` - complete background</span>
</span><span id="1-1622"><span class="sd">            on SQLAlchemy native dataclass mapping</span>
</span><span id="1-1623">
</span><span id="1-1624">
</span><span id="1-1625"><span class="sd">        .. versionadded:: 2.0</span>
</span><span id="1-1626">
</span><span id="1-1627">
</span><span id="1-1628"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-1629">
</span><span id="1-1630">        <span class="k">def</span> <span class="nf">decorate</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">]:</span>
</span><span id="1-1631">            <span class="nb">setattr</span><span class="p">(</span>
</span><span id="1-1632">                <span class="bp">cls</span><span class="p">,</span>
</span><span id="1-1633">                <span class="s2">&quot;_sa_apply_dc_transforms&quot;</span><span class="p">,</span>
</span><span id="1-1634">                <span class="p">{</span>
</span><span id="1-1635">                    <span class="s2">&quot;init&quot;</span><span class="p">:</span> <span class="n">init</span><span class="p">,</span>
</span><span id="1-1636">                    <span class="s2">&quot;repr&quot;</span><span class="p">:</span> <span class="nb">repr</span><span class="p">,</span>
</span><span id="1-1637">                    <span class="s2">&quot;eq&quot;</span><span class="p">:</span> <span class="n">eq</span><span class="p">,</span>
</span><span id="1-1638">                    <span class="s2">&quot;order&quot;</span><span class="p">:</span> <span class="n">order</span><span class="p">,</span>
</span><span id="1-1639">                    <span class="s2">&quot;unsafe_hash&quot;</span><span class="p">:</span> <span class="n">unsafe_hash</span><span class="p">,</span>
</span><span id="1-1640">                    <span class="s2">&quot;match_args&quot;</span><span class="p">:</span> <span class="n">match_args</span><span class="p">,</span>
</span><span id="1-1641">                    <span class="s2">&quot;kw_only&quot;</span><span class="p">:</span> <span class="n">kw_only</span><span class="p">,</span>
</span><span id="1-1642">                    <span class="s2">&quot;dataclass_callable&quot;</span><span class="p">:</span> <span class="n">dataclass_callable</span><span class="p">,</span>
</span><span id="1-1643">                <span class="p">},</span>
</span><span id="1-1644">            <span class="p">)</span>
</span><span id="1-1645">            <span class="n">_as_declarative</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
</span><span id="1-1646">            <span class="k">return</span> <span class="bp">cls</span>
</span><span id="1-1647">
</span><span id="1-1648">        <span class="k">if</span> <span class="n">__cls</span><span class="p">:</span>
</span><span id="1-1649">            <span class="k">return</span> <span class="n">decorate</span><span class="p">(</span><span class="n">__cls</span><span class="p">)</span>
</span><span id="1-1650">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-1651">            <span class="k">return</span> <span class="n">decorate</span>
</span><span id="1-1652">
</span><span id="1-1653">    <span class="k">def</span> <span class="nf">mapped</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">]:</span>
</span><span id="1-1654"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Class decorator that will apply the Declarative mapping process</span>
</span><span id="1-1655"><span class="sd">        to a given class.</span>
</span><span id="1-1656">
</span><span id="1-1657"><span class="sd">        E.g.::</span>
</span><span id="1-1658">
</span><span id="1-1659"><span class="sd">            from sqlalchemy.orm import registry</span>
</span><span id="1-1660">
</span><span id="1-1661"><span class="sd">            mapper_registry = registry()</span>
</span><span id="1-1662">
</span><span id="1-1663"><span class="sd">            @mapper_registry.mapped</span>
</span><span id="1-1664"><span class="sd">            class Foo:</span>
</span><span id="1-1665"><span class="sd">                __tablename__ = &#39;some_table&#39;</span>
</span><span id="1-1666">
</span><span id="1-1667"><span class="sd">                id = Column(Integer, primary_key=True)</span>
</span><span id="1-1668"><span class="sd">                name = Column(String)</span>
</span><span id="1-1669">
</span><span id="1-1670"><span class="sd">        See the section :ref:`orm_declarative_mapping` for complete</span>
</span><span id="1-1671"><span class="sd">        details and examples.</span>
</span><span id="1-1672">
</span><span id="1-1673"><span class="sd">        :param cls: class to be mapped.</span>
</span><span id="1-1674">
</span><span id="1-1675"><span class="sd">        :return: the class that was passed.</span>
</span><span id="1-1676">
</span><span id="1-1677"><span class="sd">        .. seealso::</span>
</span><span id="1-1678">
</span><span id="1-1679"><span class="sd">            :ref:`orm_declarative_mapping`</span>
</span><span id="1-1680">
</span><span id="1-1681"><span class="sd">            :meth:`_orm.registry.generate_base` - generates a base class</span>
</span><span id="1-1682"><span class="sd">            that will apply Declarative mapping to subclasses automatically</span>
</span><span id="1-1683"><span class="sd">            using a Python metaclass.</span>
</span><span id="1-1684">
</span><span id="1-1685"><span class="sd">        .. seealso::</span>
</span><span id="1-1686">
</span><span id="1-1687"><span class="sd">            :meth:`_orm.registry.mapped_as_dataclass`</span>
</span><span id="1-1688">
</span><span id="1-1689"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-1690">        <span class="n">_as_declarative</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
</span><span id="1-1691">        <span class="k">return</span> <span class="bp">cls</span>
</span><span id="1-1692">
</span><span id="1-1693">    <span class="k">def</span> <span class="nf">as_declarative_base</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Type</span><span class="p">[</span><span class="n">_T</span><span class="p">]],</span> <span class="n">Type</span><span class="p">[</span><span class="n">_T</span><span class="p">]]:</span>
</span><span id="1-1694"><span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="1-1695"><span class="sd">        Class decorator which will invoke</span>
</span><span id="1-1696"><span class="sd">        :meth:`_orm.registry.generate_base`</span>
</span><span id="1-1697"><span class="sd">        for a given base class.</span>
</span><span id="1-1698">
</span><span id="1-1699"><span class="sd">        E.g.::</span>
</span><span id="1-1700">
</span><span id="1-1701"><span class="sd">            from sqlalchemy.orm import registry</span>
</span><span id="1-1702">
</span><span id="1-1703"><span class="sd">            mapper_registry = registry()</span>
</span><span id="1-1704">
</span><span id="1-1705"><span class="sd">            @mapper_registry.as_declarative_base()</span>
</span><span id="1-1706"><span class="sd">            class Base:</span>
</span><span id="1-1707"><span class="sd">                @declared_attr</span>
</span><span id="1-1708"><span class="sd">                def __tablename__(cls):</span>
</span><span id="1-1709"><span class="sd">                    return cls.__name__.lower()</span>
</span><span id="1-1710"><span class="sd">                id = Column(Integer, primary_key=True)</span>
</span><span id="1-1711">
</span><span id="1-1712"><span class="sd">            class MyMappedClass(Base):</span>
</span><span id="1-1713"><span class="sd">                # ...</span>
</span><span id="1-1714">
</span><span id="1-1715"><span class="sd">        All keyword arguments passed to</span>
</span><span id="1-1716"><span class="sd">        :meth:`_orm.registry.as_declarative_base` are passed</span>
</span><span id="1-1717"><span class="sd">        along to :meth:`_orm.registry.generate_base`.</span>
</span><span id="1-1718">
</span><span id="1-1719"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-1720">
</span><span id="1-1721">        <span class="k">def</span> <span class="nf">decorate</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_T</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="n">_T</span><span class="p">]:</span>
</span><span id="1-1722">            <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;cls&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span>
</span><span id="1-1723">            <span class="n">kw</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span>
</span><span id="1-1724">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">generate_base</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
</span><span id="1-1725">
</span><span id="1-1726">        <span class="k">return</span> <span class="n">decorate</span>
</span><span id="1-1727">
</span><span id="1-1728">    <span class="k">def</span> <span class="nf">map_declaratively</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">_O</span><span class="p">]:</span>
</span><span id="1-1729"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Map a class declaratively.</span>
</span><span id="1-1730">
</span><span id="1-1731"><span class="sd">        In this form of mapping, the class is scanned for mapping information,</span>
</span><span id="1-1732"><span class="sd">        including for columns to be associated with a table, and/or an</span>
</span><span id="1-1733"><span class="sd">        actual table object.</span>
</span><span id="1-1734">
</span><span id="1-1735"><span class="sd">        Returns the :class:`_orm.Mapper` object.</span>
</span><span id="1-1736">
</span><span id="1-1737"><span class="sd">        E.g.::</span>
</span><span id="1-1738">
</span><span id="1-1739"><span class="sd">            from sqlalchemy.orm import registry</span>
</span><span id="1-1740">
</span><span id="1-1741"><span class="sd">            mapper_registry = registry()</span>
</span><span id="1-1742">
</span><span id="1-1743"><span class="sd">            class Foo:</span>
</span><span id="1-1744"><span class="sd">                __tablename__ = &#39;some_table&#39;</span>
</span><span id="1-1745">
</span><span id="1-1746"><span class="sd">                id = Column(Integer, primary_key=True)</span>
</span><span id="1-1747"><span class="sd">                name = Column(String)</span>
</span><span id="1-1748">
</span><span id="1-1749"><span class="sd">            mapper = mapper_registry.map_declaratively(Foo)</span>
</span><span id="1-1750">
</span><span id="1-1751"><span class="sd">        This function is more conveniently invoked indirectly via either the</span>
</span><span id="1-1752"><span class="sd">        :meth:`_orm.registry.mapped` class decorator or by subclassing a</span>
</span><span id="1-1753"><span class="sd">        declarative metaclass generated from</span>
</span><span id="1-1754"><span class="sd">        :meth:`_orm.registry.generate_base`.</span>
</span><span id="1-1755">
</span><span id="1-1756"><span class="sd">        See the section :ref:`orm_declarative_mapping` for complete</span>
</span><span id="1-1757"><span class="sd">        details and examples.</span>
</span><span id="1-1758">
</span><span id="1-1759"><span class="sd">        :param cls: class to be mapped.</span>
</span><span id="1-1760">
</span><span id="1-1761"><span class="sd">        :return: a :class:`_orm.Mapper` object.</span>
</span><span id="1-1762">
</span><span id="1-1763"><span class="sd">        .. seealso::</span>
</span><span id="1-1764">
</span><span id="1-1765"><span class="sd">            :ref:`orm_declarative_mapping`</span>
</span><span id="1-1766">
</span><span id="1-1767"><span class="sd">            :meth:`_orm.registry.mapped` - more common decorator interface</span>
</span><span id="1-1768"><span class="sd">            to this function.</span>
</span><span id="1-1769">
</span><span id="1-1770"><span class="sd">            :meth:`_orm.registry.map_imperatively`</span>
</span><span id="1-1771">
</span><span id="1-1772"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-1773">        <span class="n">_as_declarative</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">)</span>
</span><span id="1-1774">        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">__mapper__</span>  <span class="c1"># type: ignore</span>
</span><span id="1-1775">
</span><span id="1-1776">    <span class="k">def</span> <span class="nf">map_imperatively</span><span class="p">(</span>
</span><span id="1-1777">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1778">        <span class="n">class_</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span>
</span><span id="1-1779">        <span class="n">local_table</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FromClause</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
</span><span id="1-1780">        <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-1781">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">_O</span><span class="p">]:</span>
</span><span id="1-1782"><span class="w">        </span><span class="sa">r</span><span class="sd">&quot;&quot;&quot;Map a class imperatively.</span>
</span><span id="1-1783">
</span><span id="1-1784"><span class="sd">        In this form of mapping, the class is not scanned for any mapping</span>
</span><span id="1-1785"><span class="sd">        information.  Instead, all mapping constructs are passed as</span>
</span><span id="1-1786"><span class="sd">        arguments.</span>
</span><span id="1-1787">
</span><span id="1-1788"><span class="sd">        This method is intended to be fully equivalent to the now-removed</span>
</span><span id="1-1789"><span class="sd">        SQLAlchemy ``mapper()`` function, except that it&#39;s in terms of</span>
</span><span id="1-1790"><span class="sd">        a particular registry.</span>
</span><span id="1-1791">
</span><span id="1-1792"><span class="sd">        E.g.::</span>
</span><span id="1-1793">
</span><span id="1-1794"><span class="sd">            from sqlalchemy.orm import registry</span>
</span><span id="1-1795">
</span><span id="1-1796"><span class="sd">            mapper_registry = registry()</span>
</span><span id="1-1797">
</span><span id="1-1798"><span class="sd">            my_table = Table(</span>
</span><span id="1-1799"><span class="sd">                &quot;my_table&quot;,</span>
</span><span id="1-1800"><span class="sd">                mapper_registry.metadata,</span>
</span><span id="1-1801"><span class="sd">                Column(&#39;id&#39;, Integer, primary_key=True)</span>
</span><span id="1-1802"><span class="sd">            )</span>
</span><span id="1-1803">
</span><span id="1-1804"><span class="sd">            class MyClass:</span>
</span><span id="1-1805"><span class="sd">                pass</span>
</span><span id="1-1806">
</span><span id="1-1807"><span class="sd">            mapper_registry.map_imperatively(MyClass, my_table)</span>
</span><span id="1-1808">
</span><span id="1-1809"><span class="sd">        See the section :ref:`orm_imperative_mapping` for complete background</span>
</span><span id="1-1810"><span class="sd">        and usage examples.</span>
</span><span id="1-1811">
</span><span id="1-1812"><span class="sd">        :param class\_: The class to be mapped.  Corresponds to the</span>
</span><span id="1-1813"><span class="sd">         :paramref:`_orm.Mapper.class_` parameter.</span>
</span><span id="1-1814">
</span><span id="1-1815"><span class="sd">        :param local_table: the :class:`_schema.Table` or other</span>
</span><span id="1-1816"><span class="sd">         :class:`_sql.FromClause` object that is the subject of the mapping.</span>
</span><span id="1-1817"><span class="sd">         Corresponds to the</span>
</span><span id="1-1818"><span class="sd">         :paramref:`_orm.Mapper.local_table` parameter.</span>
</span><span id="1-1819">
</span><span id="1-1820"><span class="sd">        :param \**kw: all other keyword arguments are passed to the</span>
</span><span id="1-1821"><span class="sd">         :class:`_orm.Mapper` constructor directly.</span>
</span><span id="1-1822">
</span><span id="1-1823"><span class="sd">        .. seealso::</span>
</span><span id="1-1824">
</span><span id="1-1825"><span class="sd">            :ref:`orm_imperative_mapping`</span>
</span><span id="1-1826">
</span><span id="1-1827"><span class="sd">            :ref:`orm_declarative_mapping`</span>
</span><span id="1-1828">
</span><span id="1-1829"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-1830">        <span class="k">return</span> <span class="n">_mapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">class_</span><span class="p">,</span> <span class="n">local_table</span><span class="p">,</span> <span class="n">kw</span><span class="p">)</span>
</span><span id="1-1831">
</span><span id="1-1832">
</span><span id="1-1833"><span class="n">RegistryType</span> <span class="o">=</span> <span class="n">registry</span>
</span><span id="1-1834">
</span><span id="1-1835"><span class="k">if</span> <span class="ow">not</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span id="1-1836">    <span class="c1"># allow for runtime type resolution of ``ClassVar[_RegistryType]``</span>
</span><span id="1-1837">    <span class="n">_RegistryType</span> <span class="o">=</span> <span class="n">registry</span>  <span class="c1"># noqa</span>
</span><span id="1-1838">
</span><span id="1-1839">
</span><span id="1-1840"><span class="k">def</span> <span class="nf">as_declarative</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">Type</span><span class="p">[</span><span class="n">_T</span><span class="p">]],</span> <span class="n">Type</span><span class="p">[</span><span class="n">_T</span><span class="p">]]:</span>
</span><span id="1-1841"><span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
</span><span id="1-1842"><span class="sd">    Class decorator which will adapt a given class into a</span>
</span><span id="1-1843"><span class="sd">    :func:`_orm.declarative_base`.</span>
</span><span id="1-1844">
</span><span id="1-1845"><span class="sd">    This function makes use of the :meth:`_orm.registry.as_declarative_base`</span>
</span><span id="1-1846"><span class="sd">    method, by first creating a :class:`_orm.registry` automatically</span>
</span><span id="1-1847"><span class="sd">    and then invoking the decorator.</span>
</span><span id="1-1848">
</span><span id="1-1849"><span class="sd">    E.g.::</span>
</span><span id="1-1850">
</span><span id="1-1851"><span class="sd">        from sqlalchemy.orm import as_declarative</span>
</span><span id="1-1852">
</span><span id="1-1853"><span class="sd">        @as_declarative()</span>
</span><span id="1-1854"><span class="sd">        class Base:</span>
</span><span id="1-1855"><span class="sd">            @declared_attr</span>
</span><span id="1-1856"><span class="sd">            def __tablename__(cls):</span>
</span><span id="1-1857"><span class="sd">                return cls.__name__.lower()</span>
</span><span id="1-1858"><span class="sd">            id = Column(Integer, primary_key=True)</span>
</span><span id="1-1859">
</span><span id="1-1860"><span class="sd">        class MyMappedClass(Base):</span>
</span><span id="1-1861"><span class="sd">            # ...</span>
</span><span id="1-1862">
</span><span id="1-1863"><span class="sd">    .. seealso::</span>
</span><span id="1-1864">
</span><span id="1-1865"><span class="sd">        :meth:`_orm.registry.as_declarative_base`</span>
</span><span id="1-1866">
</span><span id="1-1867"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-1868">    <span class="n">metadata</span><span class="p">,</span> <span class="n">class_registry</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="1-1869">        <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
</span><span id="1-1870">        <span class="n">kw</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;class_registry&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
</span><span id="1-1871">    <span class="p">)</span>
</span><span id="1-1872">
</span><span id="1-1873">    <span class="k">return</span> <span class="n">registry</span><span class="p">(</span>
</span><span id="1-1874">        <span class="n">metadata</span><span class="o">=</span><span class="n">metadata</span><span class="p">,</span> <span class="n">class_registry</span><span class="o">=</span><span class="n">class_registry</span>
</span><span id="1-1875">    <span class="p">)</span><span class="o">.</span><span class="n">as_declarative_base</span><span class="p">(</span><span class="o">**</span><span class="n">kw</span><span class="p">)</span>
</span><span id="1-1876">
</span><span id="1-1877">
</span><span id="1-1878"><span class="nd">@inspection</span><span class="o">.</span><span class="n">_inspects</span><span class="p">(</span>
</span><span id="1-1879">    <span class="n">DeclarativeMeta</span><span class="p">,</span> <span class="n">DeclarativeBase</span><span class="p">,</span> <span class="n">DeclarativeAttributeIntercept</span>
</span><span id="1-1880"><span class="p">)</span>
</span><span id="1-1881"><span class="k">def</span> <span class="nf">_inspect_decl_meta</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
</span><span id="1-1882">    <span class="n">mp</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span> <span class="o">=</span> <span class="n">_inspect_mapped_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
</span><span id="1-1883">    <span class="k">if</span> <span class="n">mp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1884">        <span class="k">if</span> <span class="n">_DeferredMapperConfig</span><span class="o">.</span><span class="n">has_cls</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
</span><span id="1-1885">            <span class="n">_DeferredMapperConfig</span><span class="o">.</span><span class="n">raise_unmapped_for_cls</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
</span><span id="1-1886">    <span class="k">return</span> <span class="n">mp</span>
</span></pre></div>
        </article>
        
        <div class="navigation flex print:hidden">
  
  
</div>
        
      </div>
    </div>
  </main>
</div>
<footer class="sy-foot">
  <div class="sy-foot-inner sy-container mx-auto">
    
    <div class="sy-foot-reserved md:flex justify-between items-center">
      <div class="sy-foot-copyright"><p>2023, Jolt Org</p>
        
        <p>
          Made with
          
          <a href="https://www.sphinx-doc.org/">Sphinx</a> and
          
          <a href="https://shibuya.lepture.com">Shibuya theme</a>.
        </p>
      </div>
      <div class="sy-foot-socials">
          <a href="https://github.com/jolt-org/advanced-alchemy" aria-label="GitHub"><i class="i-icon github"></i></a>
      </div>
    </div>
  </div>
</footer></div>
      <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js?v=e43216b9"></script>
      <script src="../../../_static/doctools.js?v=888ff710"></script>
      <script src="../../../_static/sphinx_highlight.js?v=4825356b"></script>
      <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../_static/copybutton.js?v=f281be69"></script>
      <script src="../../../_static/design-tabs.js?v=36754332"></script>
      <script src="../../../_static/shibuya.js?v=3e5c8598"></script>
    
</body>
</html>