
  <!DOCTYPE html>
<html lang="en" data-accent-color="violet" data-content_root="">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <title>sqlalchemy.orm.decl_base - Docs</title>
    <link rel="shortcut icon" href="../../../_static/logo.png"/><link rel="index" title="Index" href="../../../genindex.html" /><link rel="search" title="Search" href="../../../search.html" />

  <script>
    function setColorMode(t){let e=document.documentElement;e.setAttribute("data-color-mode",t);let a=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,s=t;"auto"===t&&(s=a?"dark":"light"),"light"===s?(e.classList.remove("dark"),e.classList.add("light")):(e.classList.remove("light"),e.classList.add("dark"))}
    setColorMode(sessionStorage._theme||"auto");
  </script><link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=aecf457f" />
    <link rel="stylesheet" type="text/css" href="../../../_static/shibuya.css?v=db2d6636" />
    <link rel="stylesheet" type="text/css" href="../../../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
    <link media="print" rel="stylesheet" type="text/css" href="../../../_static/print.css?v=20ff2c19" />
    <link rel="stylesheet" type="text/css" href="../../../_static/css/custom.css?v=bf5addad" />
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
:root {
  --sy-f-text: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
  --sy-f-heading: "Inter", var(--sy-f-sys), var(--sy-f-cjk), sans-serif;
}
</style>
    <meta property="og:type" content="website"/><meta property="og:title" content="sqlalchemy.orm.decl_base"/>
<meta name="twitter:card" content="summary"/></head>
<body><div class="document"><div class="announcement">
    <div class="announcement-inner">
      <p>This documentation is currently under development.</p>
      <button class="announcement-close" aria-label="Close announcement">
        <i class="i-icon close"></i>
      </button>
    </div>
  </div><div class="sy-head">
  <div class="sy-head-blur"></div>
  <div class="sy-head-inner sy-container mx-auto">
    <a class="sy-head-brand mr-4" href="/">
      <img class="light-logo" src="../../../_static/logo.png" alt="advanced_alchemy" height="28" />
      <img class="dark-logo" src="../../../_static/logo.png" alt="advanced_alchemy" height="28" />
      <strong>advanced_alchemy</strong>
    </a>
    <div class="sy-head-links" id="NavLinks">
      <nav class="sy-head-nav">

<ul><li class="link">
          <a href="https://advanced-alchemy.jolt.rs"><span>Home</span><i class="i-icon external-link"></i></a>
        </li><li class="link">
          <a href="https://docs.advanced-alchemy.jolt.rs"><span>Docs</span><i class="i-icon external-link"></i></a>
        </li><li class="link">
          <a href="https://github.com/jolt-org/advanced-alchemy"><span>Code</span><i class="i-icon external-link"></i></a>
        </li></ul></nav>
      <div class="sy-head-extra flex items-center print:hidden">
<form class="searchbox flex items-center" action="../../../search.html" method="get">
  <input type="text" name="q" placeholder="Search" />
  <kbd>/</kbd>
</form>
        
        
        <div class="sy-head-social flex items-center">
            <a class="flex items-center" href="https://github.com/jolt-org/advanced-alchemy" aria-label="GitHub">
              <i class="i-icon github"></i>
            </a>
        </div>
      </div>
    </div>
    <div class="sy-head-actions flex items-center shrink-0 print:hidden">
      <button class="js-theme theme-switch flex items-center"
        data-aria-auto="Switch to light color mode"
        data-aria-light="Switch to dark color mode"
        data-aria-dark="Switch to auto color mode">
        <i class="i-icon theme-icon"></i>
      </button>
      <button class="md:hidden flex items-center js-menu" aria-label="Menu" type="button" aria-controls="NavLinks" aria-expanded="false">
        <div class="hamburger">
          <span class="hamburger_1"></span>
          <span class="hamburger_2 -translate-x-2"></span>
          <span class="hamburger_3 -translate-x-1"></span>
        </div>
      </button>
    </div>
  </div>
</div>
<div class="sy-page sy-container flex mx-auto">
  <aside id="lside" class="sy-lside md:w-72 md:shrink-0 print:hidden">
    <div class="sy-lside-inner md:sticky">
      <div class="sy-scrollbar p-6">
        <div class="globaltoc" data-expand-depth="0"><p class="caption" role="heading"><span class="caption-text">Advanced Alchemy Documentation</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../usage/index.html">Usage</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../usage/placeholder.html">Placeholder</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/index.html">API Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/base.html">base</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/exceptions.html">exceptions</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/filters.html">filters</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/operations.html">operations</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/repository.html">repositories</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/types.html">types</a></li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/alembic/index.html">alembic</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/alembic/commands.html">commands</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/alembic/templates/asyncio/index.html">asyncio</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../reference/alembic/templates/asyncio/alembic-ini.html">alembic.ini</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../reference/alembic/templates/asyncio/env.html">env</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../reference/alembic/templates/asyncio/script-py.html">script.py</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/alembic/templates/sync/index.html">sync</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../reference/alembic/templates/sync/alembic-ini.html">alembic.ini</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../reference/alembic/templates/sync/env.html">env</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../reference/alembic/templates/sync/script-py.html">script.py</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/config/index.html">config</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/config/asyncio.html">asyncio</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/config/common.html">common</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/config/engine.html">engine</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/config/sync.html">sync</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/config/types.html">types</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../../../reference/extensions/index.html">extensions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/extensions/litestar/index.html">litestar</a><ul>
<li class="toctree-l4"><a class="reference internal" href="../../../reference/extensions/litestar/alembic.html">alembic</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../reference/extensions/litestar/cli.html">cli</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../reference/extensions/litestar/dto.html">dto</a></li>
<li class="toctree-l4"><a class="reference internal" href="../../../reference/extensions/litestar/plugins/index.html">plugins</a><ul>
<li class="toctree-l5"><a class="reference internal" href="../../../reference/extensions/litestar/plugins/serialization.html">serialization</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../reference/extensions/litestar/plugins/init/plugin.html">plugin</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../reference/extensions/litestar/plugins/init/config/asyncio.html">asyncio</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../reference/extensions/litestar/plugins/init/config/common.html">common</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../reference/extensions/litestar/plugins/init/config/engine.html">engine</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../reference/extensions/litestar/plugins/init/config/sync.html">sync</a></li>
<li class="toctree-l5"><a class="reference internal" href="../../../reference/extensions/litestar/plugins/init/config/types.html">types</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/extensions/sanic.html">sanic</a></li>
<li class="toctree-l3"><a class="reference internal" href="../../../reference/extensions/starlette.html">starlette</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Development</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contribution-guide.html">Contribution guide</a></li>
</ul>

        </div>
      </div>
      
    </div>
  </aside>
  <div class="lside-overlay js-menu" role="button" aria-label="Close left sidebar" aria-controls="lside" aria-expanded="false"></div>
  <aside id="rside" class="sy-rside pb-3 w-64 shrink-0 order-last">
    <button class="rside-close js-menu xl:hidden" aria-label="Close Table of Contents" type="button" aria-controls="rside" aria-expanded="false">
      <i class="i-icon close"></i>
    </button>
    <div class="sy-scrollbar sy-rside-inner px-6 xl:top-16 xl:sticky xl:pl-0 pt-6 pb-4"><a class="js-repo-stats repo-stats flex items-center" href="https://github.com/jolt-org/advanced-alchemy"
  data-type="github" data-user="jolt-org" data-repo="advanced-alchemy">
  <span class="w-8 flex items-center justify-around shrink-0 text-3xl">
    <i class="i-icon github"></i>
  </span>
  <span class="flex-grow px-2">
    <span>jolt-org/advanced-alchemy</span>
    <span class="flex text-sm repo-stats-count">
      <span class="flex items-center pr-3">
        <i class="i-icon star"></i>
        <strong class="js-repo-stars ml-1">0</strong>
      </span>
      <span class="flex items-center">
        <i class="i-icon git-fork"></i>
        <strong class="js-repo-forks ml-1">0</strong>
      </span>
    </span>
  </span>
</a><div id="ethical-ad-placement" data-ea-publisher="readthedocs"></div>
    </div>
  </aside>
  <div class="rside-overlay js-menu" role="button" aria-label="Close Table of Contents" aria-controls="rside" aria-expanded="false"></div>
  <main class="sy-main w-full max-sm:max-w-full print:pt-6">
    <div class="sy-breadcrumbs" role="navigation">
  <div class="sy-breadcrumbs-inner flex items-center">
    <div class="md:hidden mr-3">
      <button class="js-menu" aria-label="Menu" type="button" aria-controls="lside" aria-expanded="false">
        <i class="i-icon menu"></i>
      </button>
    </div>
    <ol class="flex-1" itemscope itemtype="https://schema.org/BreadcrumbList">
      
      
      <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../../../index.html"><span itemprop="name">advanced_alchemy</span></a>
        <span>/</span>
        <meta itemprop="position" content="1" />
      </li>
      
      <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <a itemprop="item" href="../../index.html"><span itemprop="name">Module code</span></a>
        <span>/</span>
        <meta itemprop="position" content="2" />
      </li>
      
      <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
        <strong itemprop="name">sqlalchemy.orm.decl_base</strong>
        <meta itemprop="position" content="3" />
      </li>
      
      
    </ol>
    <div class="xl:hidden ml-1">
      <button class="js-menu" aria-label="Show table of contents" type="button" aria-controls="rside"
        aria-expanded="false">
        <i class="i-icon outdent"></i>
      </button>
    </div>
  </div>
</div>
    <div class="flex flex-col break-words justify-between">
      <div class="min-w-0 max-w-6xl px-6 pb-6 pt-8 xl:px-12">
        <article class="yue" role="main">
          <h1>Source code for sqlalchemy.orm.decl_base</h1><div class="highlight"><pre>
<span></span><span id="1-1"><span class="c1"># orm/decl_base.py</span>
</span><span id="1-2"><span class="c1"># Copyright (C) 2005-2024 the SQLAlchemy authors and contributors</span>
</span><span id="1-3"><span class="c1"># &lt;see AUTHORS file&gt;</span>
</span><span id="1-4"><span class="c1">#</span>
</span><span id="1-5"><span class="c1"># This module is part of SQLAlchemy and is released under</span>
</span><span id="1-6"><span class="c1"># the MIT License: https://www.opensource.org/licenses/mit-license.php</span>
</span><span id="1-7">
</span><span id="1-8"><span class="sd">&quot;&quot;&quot;Internal implementation for declarative.&quot;&quot;&quot;</span>
</span><span id="1-9">
</span><span id="1-10"><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">annotations</span>
</span><span id="1-11">
</span><span id="1-12"><span class="kn">import</span> <span class="nn">collections</span>
</span><span id="1-13"><span class="kn">import</span> <span class="nn">dataclasses</span>
</span><span id="1-14"><span class="kn">import</span> <span class="nn">re</span>
</span><span id="1-15"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Any</span>
</span><span id="1-16"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Callable</span>
</span><span id="1-17"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">cast</span>
</span><span id="1-18"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Dict</span>
</span><span id="1-19"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Iterable</span>
</span><span id="1-20"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span>
</span><span id="1-21"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Mapping</span>
</span><span id="1-22"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">NamedTuple</span>
</span><span id="1-23"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">NoReturn</span>
</span><span id="1-24"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Optional</span>
</span><span id="1-25"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Sequence</span>
</span><span id="1-26"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span>
</span><span id="1-27"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Type</span>
</span><span id="1-28"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TYPE_CHECKING</span>
</span><span id="1-29"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">TypeVar</span>
</span><span id="1-30"><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span>
</span><span id="1-31"><span class="kn">import</span> <span class="nn">weakref</span>
</span><span id="1-32">
</span><span id="1-33"><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">attributes</span>
</span><span id="1-34"><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">clsregistry</span>
</span><span id="1-35"><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">exc</span> <span class="k">as</span> <span class="n">orm_exc</span>
</span><span id="1-36"><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">instrumentation</span>
</span><span id="1-37"><span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">mapperlib</span>
</span><span id="1-38"><span class="kn">from</span> <span class="nn">._typing</span> <span class="kn">import</span> <span class="n">_O</span>
</span><span id="1-39"><span class="kn">from</span> <span class="nn">._typing</span> <span class="kn">import</span> <span class="n">attr_is_internal_proxy</span>
</span><span id="1-40"><span class="kn">from</span> <span class="nn">.attributes</span> <span class="kn">import</span> <span class="n">InstrumentedAttribute</span>
</span><span id="1-41"><span class="kn">from</span> <span class="nn">.attributes</span> <span class="kn">import</span> <span class="n">QueryableAttribute</span>
</span><span id="1-42"><span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="n">_is_mapped_class</span>
</span><span id="1-43"><span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="n">InspectionAttr</span>
</span><span id="1-44"><span class="kn">from</span> <span class="nn">.descriptor_props</span> <span class="kn">import</span> <span class="n">CompositeProperty</span>
</span><span id="1-45"><span class="kn">from</span> <span class="nn">.descriptor_props</span> <span class="kn">import</span> <span class="n">SynonymProperty</span>
</span><span id="1-46"><span class="kn">from</span> <span class="nn">.interfaces</span> <span class="kn">import</span> <span class="n">_AttributeOptions</span>
</span><span id="1-47"><span class="kn">from</span> <span class="nn">.interfaces</span> <span class="kn">import</span> <span class="n">_DCAttributeOptions</span>
</span><span id="1-48"><span class="kn">from</span> <span class="nn">.interfaces</span> <span class="kn">import</span> <span class="n">_IntrospectsAnnotations</span>
</span><span id="1-49"><span class="kn">from</span> <span class="nn">.interfaces</span> <span class="kn">import</span> <span class="n">_MappedAttribute</span>
</span><span id="1-50"><span class="kn">from</span> <span class="nn">.interfaces</span> <span class="kn">import</span> <span class="n">_MapsColumns</span>
</span><span id="1-51"><span class="kn">from</span> <span class="nn">.interfaces</span> <span class="kn">import</span> <span class="n">MapperProperty</span>
</span><span id="1-52"><span class="kn">from</span> <span class="nn">.mapper</span> <span class="kn">import</span> <span class="n">Mapper</span>
</span><span id="1-53"><span class="kn">from</span> <span class="nn">.properties</span> <span class="kn">import</span> <span class="n">ColumnProperty</span>
</span><span id="1-54"><span class="kn">from</span> <span class="nn">.properties</span> <span class="kn">import</span> <span class="n">MappedColumn</span>
</span><span id="1-55"><span class="kn">from</span> <span class="nn">.util</span> <span class="kn">import</span> <span class="n">_extract_mapped_subtype</span>
</span><span id="1-56"><span class="kn">from</span> <span class="nn">.util</span> <span class="kn">import</span> <span class="n">_is_mapped_annotation</span>
</span><span id="1-57"><span class="kn">from</span> <span class="nn">.util</span> <span class="kn">import</span> <span class="n">class_mapper</span>
</span><span id="1-58"><span class="kn">from</span> <span class="nn">.util</span> <span class="kn">import</span> <span class="n">de_stringify_annotation</span>
</span><span id="1-59"><span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">event</span>
</span><span id="1-60"><span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">exc</span>
</span><span id="1-61"><span class="kn">from</span> <span class="nn">..</span> <span class="kn">import</span> <span class="n">util</span>
</span><span id="1-62"><span class="kn">from</span> <span class="nn">..sql</span> <span class="kn">import</span> <span class="n">expression</span>
</span><span id="1-63"><span class="kn">from</span> <span class="nn">..sql.base</span> <span class="kn">import</span> <span class="n">_NoArg</span>
</span><span id="1-64"><span class="kn">from</span> <span class="nn">..sql.schema</span> <span class="kn">import</span> <span class="n">Column</span>
</span><span id="1-65"><span class="kn">from</span> <span class="nn">..sql.schema</span> <span class="kn">import</span> <span class="n">Table</span>
</span><span id="1-66"><span class="kn">from</span> <span class="nn">..util</span> <span class="kn">import</span> <span class="n">topological</span>
</span><span id="1-67"><span class="kn">from</span> <span class="nn">..util.typing</span> <span class="kn">import</span> <span class="n">_AnnotationScanType</span>
</span><span id="1-68"><span class="kn">from</span> <span class="nn">..util.typing</span> <span class="kn">import</span> <span class="n">is_fwd_ref</span>
</span><span id="1-69"><span class="kn">from</span> <span class="nn">..util.typing</span> <span class="kn">import</span> <span class="n">is_literal</span>
</span><span id="1-70"><span class="kn">from</span> <span class="nn">..util.typing</span> <span class="kn">import</span> <span class="n">Protocol</span>
</span><span id="1-71"><span class="kn">from</span> <span class="nn">..util.typing</span> <span class="kn">import</span> <span class="n">TypedDict</span>
</span><span id="1-72"><span class="kn">from</span> <span class="nn">..util.typing</span> <span class="kn">import</span> <span class="n">typing_get_args</span>
</span><span id="1-73">
</span><span id="1-74"><span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span id="1-75">    <span class="kn">from</span> <span class="nn">._typing</span> <span class="kn">import</span> <span class="n">_ClassDict</span>
</span><span id="1-76">    <span class="kn">from</span> <span class="nn">._typing</span> <span class="kn">import</span> <span class="n">_RegistryType</span>
</span><span id="1-77">    <span class="kn">from</span> <span class="nn">.base</span> <span class="kn">import</span> <span class="n">Mapped</span>
</span><span id="1-78">    <span class="kn">from</span> <span class="nn">.decl_api</span> <span class="kn">import</span> <span class="n">declared_attr</span>
</span><span id="1-79">    <span class="kn">from</span> <span class="nn">.instrumentation</span> <span class="kn">import</span> <span class="n">ClassManager</span>
</span><span id="1-80">    <span class="kn">from</span> <span class="nn">..sql.elements</span> <span class="kn">import</span> <span class="n">NamedColumn</span>
</span><span id="1-81">    <span class="kn">from</span> <span class="nn">..sql.schema</span> <span class="kn">import</span> <span class="n">MetaData</span>
</span><span id="1-82">    <span class="kn">from</span> <span class="nn">..sql.selectable</span> <span class="kn">import</span> <span class="n">FromClause</span>
</span><span id="1-83">
</span><span id="1-84"><span class="n">_T</span> <span class="o">=</span> <span class="n">TypeVar</span><span class="p">(</span><span class="s2">&quot;_T&quot;</span><span class="p">,</span> <span class="n">bound</span><span class="o">=</span><span class="n">Any</span><span class="p">)</span>
</span><span id="1-85">
</span><span id="1-86"><span class="n">_MapperKwArgs</span> <span class="o">=</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
</span><span id="1-87"><span class="n">_TableArgsType</span> <span class="o">=</span> <span class="n">Union</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]</span>
</span><span id="1-88">
</span><span id="1-89">
</span><span id="1-90"><span class="k">class</span> <span class="nc">MappedClassProtocol</span><span class="p">(</span><span class="n">Protocol</span><span class="p">[</span><span class="n">_O</span><span class="p">]):</span>
</span><span id="1-91"><span class="w">    </span><span class="sd">&quot;&quot;&quot;A protocol representing a SQLAlchemy mapped class.</span>
</span><span id="1-92">
</span><span id="1-93"><span class="sd">    The protocol is generic on the type of class, use</span>
</span><span id="1-94"><span class="sd">    ``MappedClassProtocol[Any]`` to allow any mapped class.</span>
</span><span id="1-95"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-96">
</span><span id="1-97">    <span class="vm">__name__</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="1-98">    <span class="n">__mapper__</span><span class="p">:</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">_O</span><span class="p">]</span>
</span><span id="1-99">    <span class="n">__table__</span><span class="p">:</span> <span class="n">FromClause</span>
</span><span id="1-100">
</span><span id="1-101">    <span class="k">def</span> <span class="fm">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_O</span><span class="p">:</span> <span class="o">...</span>
</span><span id="1-102">
</span><span id="1-103">
</span><span id="1-104"><span class="k">class</span> <span class="nc">_DeclMappedClassProtocol</span><span class="p">(</span><span class="n">MappedClassProtocol</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span> <span class="n">Protocol</span><span class="p">):</span>
</span><span id="1-105">    <span class="s2">&quot;Internal more detailed version of ``MappedClassProtocol``.&quot;</span>
</span><span id="1-106">    <span class="n">metadata</span><span class="p">:</span> <span class="n">MetaData</span>
</span><span id="1-107">    <span class="n">__tablename__</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="1-108">    <span class="n">__mapper_args__</span><span class="p">:</span> <span class="n">_MapperKwArgs</span>
</span><span id="1-109">    <span class="n">__table_args__</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_TableArgsType</span><span class="p">]</span>
</span><span id="1-110">
</span><span id="1-111">    <span class="n">_sa_apply_dc_transforms</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_DataclassArguments</span><span class="p">]</span>
</span><span id="1-112">
</span><span id="1-113">    <span class="k">def</span> <span class="nf">__declare_first__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
</span><span id="1-114">
</span><span id="1-115">    <span class="k">def</span> <span class="nf">__declare_last__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span> <span class="o">...</span>
</span><span id="1-116">
</span><span id="1-117">
</span><span id="1-118"><span class="k">class</span> <span class="nc">_DataclassArguments</span><span class="p">(</span><span class="n">TypedDict</span><span class="p">):</span>
</span><span id="1-119">    <span class="n">init</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span>
</span><span id="1-120">    <span class="nb">repr</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span>
</span><span id="1-121">    <span class="n">eq</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span>
</span><span id="1-122">    <span class="n">order</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span>
</span><span id="1-123">    <span class="n">unsafe_hash</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span>
</span><span id="1-124">    <span class="n">match_args</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span>
</span><span id="1-125">    <span class="n">kw_only</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]</span>
</span><span id="1-126">    <span class="n">dataclass_callable</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">_NoArg</span><span class="p">,</span> <span class="n">Callable</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span>
</span><span id="1-127">
</span><span id="1-128">
</span><span id="1-129"><span class="k">def</span> <span class="nf">_declared_mapping_info</span><span class="p">(</span>
</span><span id="1-130">    <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-131"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="n">_DeferredMapperConfig</span><span class="p">,</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]:</span>
</span><span id="1-132">    <span class="c1"># deferred mapping</span>
</span><span id="1-133">    <span class="k">if</span> <span class="n">_DeferredMapperConfig</span><span class="o">.</span><span class="n">has_cls</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
</span><span id="1-134">        <span class="k">return</span> <span class="n">_DeferredMapperConfig</span><span class="o">.</span><span class="n">config_for_cls</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
</span><span id="1-135">    <span class="c1"># regular mapping</span>
</span><span id="1-136">    <span class="k">elif</span> <span class="n">_is_mapped_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
</span><span id="1-137">        <span class="k">return</span> <span class="n">class_mapper</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">configure</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</span><span id="1-138">    <span class="k">else</span><span class="p">:</span>
</span><span id="1-139">        <span class="k">return</span> <span class="kc">None</span>
</span><span id="1-140">
</span><span id="1-141">
</span><span id="1-142"><span class="k">def</span> <span class="nf">_is_supercls_for_inherits</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="1-143"><span class="w">    </span><span class="sd">&quot;&quot;&quot;return True if this class will be used as a superclass to set in</span>
</span><span id="1-144"><span class="sd">    &#39;inherits&#39;.</span>
</span><span id="1-145">
</span><span id="1-146"><span class="sd">    This includes deferred mapper configs that aren&#39;t mapped yet, however does</span>
</span><span id="1-147"><span class="sd">    not include classes with _sa_decl_prepare_nocascade (e.g.</span>
</span><span id="1-148"><span class="sd">    ``AbstractConcreteBase``); these concrete-only classes are not set up as</span>
</span><span id="1-149"><span class="sd">    &quot;inherits&quot; until after mappers are configured using</span>
</span><span id="1-150"><span class="sd">    mapper._set_concrete_base()</span>
</span><span id="1-151">
</span><span id="1-152"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-153">    <span class="k">if</span> <span class="n">_DeferredMapperConfig</span><span class="o">.</span><span class="n">has_cls</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
</span><span id="1-154">        <span class="k">return</span> <span class="ow">not</span> <span class="n">_get_immediate_cls_attr</span><span class="p">(</span>
</span><span id="1-155">            <span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;_sa_decl_prepare_nocascade&quot;</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span>
</span><span id="1-156">        <span class="p">)</span>
</span><span id="1-157">    <span class="c1"># regular mapping</span>
</span><span id="1-158">    <span class="k">elif</span> <span class="n">_is_mapped_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">):</span>
</span><span id="1-159">        <span class="k">return</span> <span class="kc">True</span>
</span><span id="1-160">    <span class="k">else</span><span class="p">:</span>
</span><span id="1-161">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="1-162">
</span><span id="1-163">
</span><span id="1-164"><span class="k">def</span> <span class="nf">_resolve_for_abstract_or_classical</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]]:</span>
</span><span id="1-165">    <span class="k">if</span> <span class="bp">cls</span> <span class="ow">is</span> <span class="nb">object</span><span class="p">:</span>
</span><span id="1-166">        <span class="k">return</span> <span class="kc">None</span>
</span><span id="1-167">
</span><span id="1-168">    <span class="n">sup</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
</span><span id="1-169">
</span><span id="1-170">    <span class="k">if</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;__abstract__&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="1-171">        <span class="k">for</span> <span class="n">base_</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">:</span>
</span><span id="1-172">            <span class="n">sup</span> <span class="o">=</span> <span class="n">_resolve_for_abstract_or_classical</span><span class="p">(</span><span class="n">base_</span><span class="p">)</span>
</span><span id="1-173">            <span class="k">if</span> <span class="n">sup</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-174">                <span class="k">return</span> <span class="n">sup</span>
</span><span id="1-175">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-176">            <span class="k">return</span> <span class="kc">None</span>
</span><span id="1-177">    <span class="k">else</span><span class="p">:</span>
</span><span id="1-178">        <span class="n">clsmanager</span> <span class="o">=</span> <span class="n">_dive_for_cls_manager</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
</span><span id="1-179">
</span><span id="1-180">        <span class="k">if</span> <span class="n">clsmanager</span><span class="p">:</span>
</span><span id="1-181">            <span class="k">return</span> <span class="n">clsmanager</span><span class="o">.</span><span class="n">class_</span>
</span><span id="1-182">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-183">            <span class="k">return</span> <span class="bp">cls</span>
</span><span id="1-184">
</span><span id="1-185">
</span><span id="1-186"><span class="k">def</span> <span class="nf">_get_immediate_cls_attr</span><span class="p">(</span>
</span><span id="1-187">    <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">attrname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">strict</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-188"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span id="1-189"><span class="w">    </span><span class="sd">&quot;&quot;&quot;return an attribute of the class that is either present directly</span>
</span><span id="1-190"><span class="sd">    on the class, e.g. not on a superclass, or is from a superclass but</span>
</span><span id="1-191"><span class="sd">    this superclass is a non-mapped mixin, that is, not a descendant of</span>
</span><span id="1-192"><span class="sd">    the declarative base and is also not classically mapped.</span>
</span><span id="1-193">
</span><span id="1-194"><span class="sd">    This is used to detect attributes that indicate something about</span>
</span><span id="1-195"><span class="sd">    a mapped class independently from any mapped classes that it may</span>
</span><span id="1-196"><span class="sd">    inherit from.</span>
</span><span id="1-197">
</span><span id="1-198"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-199">
</span><span id="1-200">    <span class="c1"># the rules are different for this name than others,</span>
</span><span id="1-201">    <span class="c1"># make sure we&#39;ve moved it out.  transitional</span>
</span><span id="1-202">    <span class="k">assert</span> <span class="n">attrname</span> <span class="o">!=</span> <span class="s2">&quot;__abstract__&quot;</span>
</span><span id="1-203">
</span><span id="1-204">    <span class="k">if</span> <span class="ow">not</span> <span class="nb">issubclass</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="nb">object</span><span class="p">):</span>
</span><span id="1-205">        <span class="k">return</span> <span class="kc">None</span>
</span><span id="1-206">
</span><span id="1-207">    <span class="k">if</span> <span class="n">attrname</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
</span><span id="1-208">        <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">attrname</span><span class="p">)</span>
</span><span id="1-209">
</span><span id="1-210">    <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
</span><span id="1-211">        <span class="n">_is_classical_inherits</span> <span class="o">=</span> <span class="n">_dive_for_cls_manager</span><span class="p">(</span><span class="n">base</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="1-212">
</span><span id="1-213">        <span class="k">if</span> <span class="n">attrname</span> <span class="ow">in</span> <span class="n">base</span><span class="o">.</span><span class="vm">__dict__</span> <span class="ow">and</span> <span class="p">(</span>
</span><span id="1-214">            <span class="n">base</span> <span class="ow">is</span> <span class="bp">cls</span>
</span><span id="1-215">            <span class="ow">or</span> <span class="p">(</span>
</span><span id="1-216">                <span class="p">(</span><span class="n">base</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__bases__</span> <span class="k">if</span> <span class="n">strict</span> <span class="k">else</span> <span class="kc">True</span><span class="p">)</span>
</span><span id="1-217">                <span class="ow">and</span> <span class="ow">not</span> <span class="n">_is_classical_inherits</span>
</span><span id="1-218">            <span class="p">)</span>
</span><span id="1-219">        <span class="p">):</span>
</span><span id="1-220">            <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">attrname</span><span class="p">)</span>
</span><span id="1-221">    <span class="k">else</span><span class="p">:</span>
</span><span id="1-222">        <span class="k">return</span> <span class="kc">None</span>
</span><span id="1-223">
</span><span id="1-224">
</span><span id="1-225"><span class="k">def</span> <span class="nf">_dive_for_cls_manager</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ClassManager</span><span class="p">[</span><span class="n">_O</span><span class="p">]]:</span>
</span><span id="1-226">    <span class="c1"># because the class manager registration is pluggable,</span>
</span><span id="1-227">    <span class="c1"># we need to do the search for every class in the hierarchy,</span>
</span><span id="1-228">    <span class="c1"># rather than just a simple &quot;cls._sa_class_manager&quot;</span>
</span><span id="1-229">
</span><span id="1-230">    <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">:</span>
</span><span id="1-231">        <span class="n">manager</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">ClassManager</span><span class="p">[</span><span class="n">_O</span><span class="p">]]</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">opt_manager_of_class</span><span class="p">(</span>
</span><span id="1-232">            <span class="n">base</span>
</span><span id="1-233">        <span class="p">)</span>
</span><span id="1-234">        <span class="k">if</span> <span class="n">manager</span><span class="p">:</span>
</span><span id="1-235">            <span class="k">return</span> <span class="n">manager</span>
</span><span id="1-236">    <span class="k">return</span> <span class="kc">None</span>
</span><span id="1-237">
</span><span id="1-238">
</span><span id="1-239"><span class="k">def</span> <span class="nf">_as_declarative</span><span class="p">(</span>
</span><span id="1-240">    <span class="n">registry</span><span class="p">:</span> <span class="n">_RegistryType</span><span class="p">,</span> <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">dict_</span><span class="p">:</span> <span class="n">_ClassDict</span>
</span><span id="1-241"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_MapperConfig</span><span class="p">]:</span>
</span><span id="1-242">    <span class="c1"># declarative scans the class for attributes.  no table or mapper</span>
</span><span id="1-243">    <span class="c1"># args passed separately.</span>
</span><span id="1-244">    <span class="k">return</span> <span class="n">_MapperConfig</span><span class="o">.</span><span class="n">setup_mapping</span><span class="p">(</span><span class="n">registry</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">{})</span>
</span><span id="1-245">
</span><span id="1-246">
</span><span id="1-247"><span class="k">def</span> <span class="nf">_mapper</span><span class="p">(</span>
</span><span id="1-248">    <span class="n">registry</span><span class="p">:</span> <span class="n">_RegistryType</span><span class="p">,</span>
</span><span id="1-249">    <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span>
</span><span id="1-250">    <span class="n">table</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FromClause</span><span class="p">],</span>
</span><span id="1-251">    <span class="n">mapper_kw</span><span class="p">:</span> <span class="n">_MapperKwArgs</span><span class="p">,</span>
</span><span id="1-252"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">_O</span><span class="p">]:</span>
</span><span id="1-253">    <span class="n">_ImperativeMapperConfig</span><span class="p">(</span><span class="n">registry</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">mapper_kw</span><span class="p">)</span>
</span><span id="1-254">    <span class="k">return</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;MappedClassProtocol[_O]&quot;</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">__mapper__</span>
</span><span id="1-255">
</span><span id="1-256">
</span><span id="1-257"><span class="nd">@util</span><span class="o">.</span><span class="n">preload_module</span><span class="p">(</span><span class="s2">&quot;sqlalchemy.orm.decl_api&quot;</span><span class="p">)</span>
</span><span id="1-258"><span class="k">def</span> <span class="nf">_is_declarative_props</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="1-259">    <span class="n">_declared_attr_common</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">preloaded</span><span class="o">.</span><span class="n">orm_decl_api</span><span class="o">.</span><span class="n">_declared_attr_common</span>
</span><span id="1-260">
</span><span id="1-261">    <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="n">_declared_attr_common</span><span class="p">,</span> <span class="n">util</span><span class="o">.</span><span class="n">classproperty</span><span class="p">))</span>
</span><span id="1-262">
</span><span id="1-263">
</span><span id="1-264"><span class="k">def</span> <span class="nf">_check_declared_props_nocascade</span><span class="p">(</span>
</span><span id="1-265">    <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">]</span>
</span><span id="1-266"><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="1-267">    <span class="k">if</span> <span class="n">_is_declarative_props</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
</span><span id="1-268">        <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;_cascading&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="1-269">            <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span id="1-270">                <span class="s2">&quot;@declared_attr.cascading is not supported on the </span><span class="si">%s</span><span class="s2"> &quot;</span>
</span><span id="1-271">                <span class="s2">&quot;attribute on class </span><span class="si">%s</span><span class="s2">.  This attribute invokes for &quot;</span>
</span><span id="1-272">                <span class="s2">&quot;subclasses in any case.&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>
</span><span id="1-273">            <span class="p">)</span>
</span><span id="1-274">        <span class="k">return</span> <span class="kc">True</span>
</span><span id="1-275">    <span class="k">else</span><span class="p">:</span>
</span><span id="1-276">        <span class="k">return</span> <span class="kc">False</span>
</span><span id="1-277">
</span><span id="1-278">
</span><span id="1-279"><span class="k">class</span> <span class="nc">_MapperConfig</span><span class="p">:</span>
</span><span id="1-280">    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="1-281">        <span class="s2">&quot;cls&quot;</span><span class="p">,</span>
</span><span id="1-282">        <span class="s2">&quot;classname&quot;</span><span class="p">,</span>
</span><span id="1-283">        <span class="s2">&quot;properties&quot;</span><span class="p">,</span>
</span><span id="1-284">        <span class="s2">&quot;declared_attr_reg&quot;</span><span class="p">,</span>
</span><span id="1-285">        <span class="s2">&quot;__weakref__&quot;</span><span class="p">,</span>
</span><span id="1-286">    <span class="p">)</span>
</span><span id="1-287">
</span><span id="1-288">    <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
</span><span id="1-289">    <span class="n">classname</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="1-290">    <span class="n">properties</span><span class="p">:</span> <span class="n">util</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">[</span>
</span><span id="1-291">        <span class="nb">str</span><span class="p">,</span>
</span><span id="1-292">        <span class="n">Union</span><span class="p">[</span>
</span><span id="1-293">            <span class="n">Sequence</span><span class="p">[</span><span class="n">NamedColumn</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">NamedColumn</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">MapperProperty</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
</span><span id="1-294">        <span class="p">],</span>
</span><span id="1-295">    <span class="p">]</span>
</span><span id="1-296">    <span class="n">declared_attr_reg</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">declared_attr</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Any</span><span class="p">]</span>
</span><span id="1-297">
</span><span id="1-298">    <span class="nd">@classmethod</span>
</span><span id="1-299">    <span class="k">def</span> <span class="nf">setup_mapping</span><span class="p">(</span>
</span><span id="1-300">        <span class="bp">cls</span><span class="p">,</span>
</span><span id="1-301">        <span class="n">registry</span><span class="p">:</span> <span class="n">_RegistryType</span><span class="p">,</span>
</span><span id="1-302">        <span class="n">cls_</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span>
</span><span id="1-303">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_ClassDict</span><span class="p">,</span>
</span><span id="1-304">        <span class="n">table</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FromClause</span><span class="p">],</span>
</span><span id="1-305">        <span class="n">mapper_kw</span><span class="p">:</span> <span class="n">_MapperKwArgs</span><span class="p">,</span>
</span><span id="1-306">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_MapperConfig</span><span class="p">]:</span>
</span><span id="1-307">        <span class="n">manager</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">opt_manager_of_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
</span><span id="1-308">        <span class="k">if</span> <span class="n">manager</span> <span class="ow">and</span> <span class="n">manager</span><span class="o">.</span><span class="n">class_</span> <span class="ow">is</span> <span class="n">cls_</span><span class="p">:</span>
</span><span id="1-309">            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span id="1-310">                <span class="sa">f</span><span class="s2">&quot;Class </span><span class="si">{</span><span class="bp">cls</span><span class="si">!r}</span><span class="s2"> already has been instrumented declaratively&quot;</span>
</span><span id="1-311">            <span class="p">)</span>
</span><span id="1-312">
</span><span id="1-313">        <span class="k">if</span> <span class="n">cls_</span><span class="o">.</span><span class="vm">__dict__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;__abstract__&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="1-314">            <span class="k">return</span> <span class="kc">None</span>
</span><span id="1-315">
</span><span id="1-316">        <span class="n">defer_map</span> <span class="o">=</span> <span class="n">_get_immediate_cls_attr</span><span class="p">(</span>
</span><span id="1-317">            <span class="n">cls_</span><span class="p">,</span> <span class="s2">&quot;_sa_decl_prepare_nocascade&quot;</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span>
</span><span id="1-318">        <span class="p">)</span> <span class="ow">or</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cls_</span><span class="p">,</span> <span class="s2">&quot;_sa_decl_prepare&quot;</span><span class="p">)</span>
</span><span id="1-319">
</span><span id="1-320">        <span class="k">if</span> <span class="n">defer_map</span><span class="p">:</span>
</span><span id="1-321">            <span class="k">return</span> <span class="n">_DeferredMapperConfig</span><span class="p">(</span>
</span><span id="1-322">                <span class="n">registry</span><span class="p">,</span> <span class="n">cls_</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">mapper_kw</span>
</span><span id="1-323">            <span class="p">)</span>
</span><span id="1-324">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-325">            <span class="k">return</span> <span class="n">_ClassScanMapperConfig</span><span class="p">(</span>
</span><span id="1-326">                <span class="n">registry</span><span class="p">,</span> <span class="n">cls_</span><span class="p">,</span> <span class="n">dict_</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">mapper_kw</span>
</span><span id="1-327">            <span class="p">)</span>
</span><span id="1-328">
</span><span id="1-329">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="1-330">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-331">        <span class="n">registry</span><span class="p">:</span> <span class="n">_RegistryType</span><span class="p">,</span>
</span><span id="1-332">        <span class="n">cls_</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-333">        <span class="n">mapper_kw</span><span class="p">:</span> <span class="n">_MapperKwArgs</span><span class="p">,</span>
</span><span id="1-334">    <span class="p">):</span>
</span><span id="1-335">        <span class="bp">self</span><span class="o">.</span><span class="n">cls</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">assert_arg_type</span><span class="p">(</span><span class="n">cls_</span><span class="p">,</span> <span class="nb">type</span><span class="p">,</span> <span class="s2">&quot;cls_&quot;</span><span class="p">)</span>
</span><span id="1-336">        <span class="bp">self</span><span class="o">.</span><span class="n">classname</span> <span class="o">=</span> <span class="n">cls_</span><span class="o">.</span><span class="vm">__name__</span>
</span><span id="1-337">        <span class="bp">self</span><span class="o">.</span><span class="n">properties</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
</span><span id="1-338">        <span class="bp">self</span><span class="o">.</span><span class="n">declared_attr_reg</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="1-339">
</span><span id="1-340">        <span class="k">if</span> <span class="ow">not</span> <span class="n">mapper_kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;non_primary&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="1-341">            <span class="n">instrumentation</span><span class="o">.</span><span class="n">register_class</span><span class="p">(</span>
</span><span id="1-342">                <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span>
</span><span id="1-343">                <span class="n">finalize</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="1-344">                <span class="n">registry</span><span class="o">=</span><span class="n">registry</span><span class="p">,</span>
</span><span id="1-345">                <span class="n">declarative_scan</span><span class="o">=</span><span class="bp">self</span><span class="p">,</span>
</span><span id="1-346">                <span class="n">init_method</span><span class="o">=</span><span class="n">registry</span><span class="o">.</span><span class="n">constructor</span><span class="p">,</span>
</span><span id="1-347">            <span class="p">)</span>
</span><span id="1-348">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-349">            <span class="n">manager</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">opt_manager_of_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">)</span>
</span><span id="1-350">            <span class="k">if</span> <span class="ow">not</span> <span class="n">manager</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">manager</span><span class="o">.</span><span class="n">is_mapped</span><span class="p">:</span>
</span><span id="1-351">                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span id="1-352">                    <span class="s2">&quot;Class </span><span class="si">%s</span><span class="s2"> has no primary mapper configured.  Configure &quot;</span>
</span><span id="1-353">                    <span class="s2">&quot;a primary mapper first before setting up a non primary &quot;</span>
</span><span id="1-354">                    <span class="s2">&quot;Mapper.&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span>
</span><span id="1-355">                <span class="p">)</span>
</span><span id="1-356">
</span><span id="1-357">    <span class="k">def</span> <span class="nf">set_cls_attribute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrname</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">_T</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">_T</span><span class="p">:</span>
</span><span id="1-358">        <span class="n">manager</span> <span class="o">=</span> <span class="n">instrumentation</span><span class="o">.</span><span class="n">manager_of_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">)</span>
</span><span id="1-359">        <span class="n">manager</span><span class="o">.</span><span class="n">install_member</span><span class="p">(</span><span class="n">attrname</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span id="1-360">        <span class="k">return</span> <span class="n">value</span>
</span><span id="1-361">
</span><span id="1-362">    <span class="k">def</span> <span class="nf">map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapper_kw</span><span class="p">:</span> <span class="n">_MapperKwArgs</span> <span class="o">=</span> <span class="o">...</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span id="1-363">        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">()</span>
</span><span id="1-364">
</span><span id="1-365">    <span class="k">def</span> <span class="nf">_early_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapper_kw</span><span class="p">:</span> <span class="n">_MapperKwArgs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-366">        <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">mapper_kw</span><span class="p">)</span>
</span><span id="1-367">
</span><span id="1-368">
</span><span id="1-369"><span class="k">class</span> <span class="nc">_ImperativeMapperConfig</span><span class="p">(</span><span class="n">_MapperConfig</span><span class="p">):</span>
</span><span id="1-370">    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;local_table&quot;</span><span class="p">,</span> <span class="s2">&quot;inherits&quot;</span><span class="p">)</span>
</span><span id="1-371">
</span><span id="1-372">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="1-373">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-374">        <span class="n">registry</span><span class="p">:</span> <span class="n">_RegistryType</span><span class="p">,</span>
</span><span id="1-375">        <span class="n">cls_</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span>
</span><span id="1-376">        <span class="n">table</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FromClause</span><span class="p">],</span>
</span><span id="1-377">        <span class="n">mapper_kw</span><span class="p">:</span> <span class="n">_MapperKwArgs</span><span class="p">,</span>
</span><span id="1-378">    <span class="p">):</span>
</span><span id="1-379">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">registry</span><span class="p">,</span> <span class="n">cls_</span><span class="p">,</span> <span class="n">mapper_kw</span><span class="p">)</span>
</span><span id="1-380">
</span><span id="1-381">        <span class="bp">self</span><span class="o">.</span><span class="n">local_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_cls_attribute</span><span class="p">(</span><span class="s2">&quot;__table__&quot;</span><span class="p">,</span> <span class="n">table</span><span class="p">)</span>
</span><span id="1-382">
</span><span id="1-383">        <span class="k">with</span> <span class="n">mapperlib</span><span class="o">.</span><span class="n">_CONFIGURE_MUTEX</span><span class="p">:</span>
</span><span id="1-384">            <span class="k">if</span> <span class="ow">not</span> <span class="n">mapper_kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;non_primary&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="1-385">                <span class="n">clsregistry</span><span class="o">.</span><span class="n">add_class</span><span class="p">(</span>
</span><span id="1-386">                    <span class="bp">self</span><span class="o">.</span><span class="n">classname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="n">registry</span><span class="o">.</span><span class="n">_class_registry</span>
</span><span id="1-387">                <span class="p">)</span>
</span><span id="1-388">
</span><span id="1-389">            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_inheritance</span><span class="p">(</span><span class="n">mapper_kw</span><span class="p">)</span>
</span><span id="1-390">
</span><span id="1-391">            <span class="bp">self</span><span class="o">.</span><span class="n">_early_mapping</span><span class="p">(</span><span class="n">mapper_kw</span><span class="p">)</span>
</span><span id="1-392">
</span><span id="1-393">    <span class="k">def</span> <span class="nf">map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapper_kw</span><span class="p">:</span> <span class="n">_MapperKwArgs</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span id="1-394">        <span class="n">mapper_cls</span> <span class="o">=</span> <span class="n">Mapper</span>
</span><span id="1-395">
</span><span id="1-396">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_cls_attribute</span><span class="p">(</span>
</span><span id="1-397">            <span class="s2">&quot;__mapper__&quot;</span><span class="p">,</span>
</span><span id="1-398">            <span class="n">mapper_cls</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_table</span><span class="p">,</span> <span class="o">**</span><span class="n">mapper_kw</span><span class="p">),</span>
</span><span id="1-399">        <span class="p">)</span>
</span><span id="1-400">
</span><span id="1-401">    <span class="k">def</span> <span class="nf">_setup_inheritance</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapper_kw</span><span class="p">:</span> <span class="n">_MapperKwArgs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-402">        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span>
</span><span id="1-403">
</span><span id="1-404">        <span class="n">inherits</span> <span class="o">=</span> <span class="n">mapper_kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;inherits&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="1-405">
</span><span id="1-406">        <span class="k">if</span> <span class="n">inherits</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-407">            <span class="c1"># since we search for classical mappings now, search for</span>
</span><span id="1-408">            <span class="c1"># multiple mapped bases as well and raise an error.</span>
</span><span id="1-409">            <span class="n">inherits_search</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="1-410">            <span class="k">for</span> <span class="n">base_</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">:</span>
</span><span id="1-411">                <span class="n">c</span> <span class="o">=</span> <span class="n">_resolve_for_abstract_or_classical</span><span class="p">(</span><span class="n">base_</span><span class="p">)</span>
</span><span id="1-412">                <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-413">                    <span class="k">continue</span>
</span><span id="1-414">
</span><span id="1-415">                <span class="k">if</span> <span class="n">_is_supercls_for_inherits</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="ow">and</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">inherits_search</span><span class="p">:</span>
</span><span id="1-416">                    <span class="n">inherits_search</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span><span id="1-417">
</span><span id="1-418">            <span class="k">if</span> <span class="n">inherits_search</span><span class="p">:</span>
</span><span id="1-419">                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inherits_search</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="1-420">                    <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span id="1-421">                        <span class="s2">&quot;Class </span><span class="si">%s</span><span class="s2"> has multiple mapped bases: </span><span class="si">%r</span><span class="s2">&quot;</span>
</span><span id="1-422">                        <span class="o">%</span> <span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">inherits_search</span><span class="p">)</span>
</span><span id="1-423">                    <span class="p">)</span>
</span><span id="1-424">                <span class="n">inherits</span> <span class="o">=</span> <span class="n">inherits_search</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="1-425">        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inherits</span><span class="p">,</span> <span class="n">Mapper</span><span class="p">):</span>
</span><span id="1-426">            <span class="n">inherits</span> <span class="o">=</span> <span class="n">inherits</span><span class="o">.</span><span class="n">class_</span>
</span><span id="1-427">
</span><span id="1-428">        <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span> <span class="o">=</span> <span class="n">inherits</span>
</span><span id="1-429">
</span><span id="1-430">
</span><span id="1-431"><span class="k">class</span> <span class="nc">_CollectedAnnotation</span><span class="p">(</span><span class="n">NamedTuple</span><span class="p">):</span>
</span><span id="1-432">    <span class="n">raw_annotation</span><span class="p">:</span> <span class="n">_AnnotationScanType</span>
</span><span id="1-433">    <span class="n">mapped_container</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Mapped</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]</span>
</span><span id="1-434">    <span class="n">extracted_mapped_annotation</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="nb">str</span><span class="p">]</span>
</span><span id="1-435">    <span class="n">is_dataclass</span><span class="p">:</span> <span class="nb">bool</span>
</span><span id="1-436">    <span class="n">attr_value</span><span class="p">:</span> <span class="n">Any</span>
</span><span id="1-437">    <span class="n">originating_module</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="1-438">    <span class="n">originating_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
</span><span id="1-439">
</span><span id="1-440">
</span><span id="1-441"><span class="k">class</span> <span class="nc">_ClassScanMapperConfig</span><span class="p">(</span><span class="n">_MapperConfig</span><span class="p">):</span>
</span><span id="1-442">    <span class="vm">__slots__</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="1-443">        <span class="s2">&quot;registry&quot;</span><span class="p">,</span>
</span><span id="1-444">        <span class="s2">&quot;clsdict_view&quot;</span><span class="p">,</span>
</span><span id="1-445">        <span class="s2">&quot;collected_attributes&quot;</span><span class="p">,</span>
</span><span id="1-446">        <span class="s2">&quot;collected_annotations&quot;</span><span class="p">,</span>
</span><span id="1-447">        <span class="s2">&quot;local_table&quot;</span><span class="p">,</span>
</span><span id="1-448">        <span class="s2">&quot;persist_selectable&quot;</span><span class="p">,</span>
</span><span id="1-449">        <span class="s2">&quot;declared_columns&quot;</span><span class="p">,</span>
</span><span id="1-450">        <span class="s2">&quot;column_ordering&quot;</span><span class="p">,</span>
</span><span id="1-451">        <span class="s2">&quot;column_copies&quot;</span><span class="p">,</span>
</span><span id="1-452">        <span class="s2">&quot;table_args&quot;</span><span class="p">,</span>
</span><span id="1-453">        <span class="s2">&quot;tablename&quot;</span><span class="p">,</span>
</span><span id="1-454">        <span class="s2">&quot;mapper_args&quot;</span><span class="p">,</span>
</span><span id="1-455">        <span class="s2">&quot;mapper_args_fn&quot;</span><span class="p">,</span>
</span><span id="1-456">        <span class="s2">&quot;inherits&quot;</span><span class="p">,</span>
</span><span id="1-457">        <span class="s2">&quot;single&quot;</span><span class="p">,</span>
</span><span id="1-458">        <span class="s2">&quot;allow_dataclass_fields&quot;</span><span class="p">,</span>
</span><span id="1-459">        <span class="s2">&quot;dataclass_setup_arguments&quot;</span><span class="p">,</span>
</span><span id="1-460">        <span class="s2">&quot;is_dataclass_prior_to_mapping&quot;</span><span class="p">,</span>
</span><span id="1-461">        <span class="s2">&quot;allow_unmapped_annotations&quot;</span><span class="p">,</span>
</span><span id="1-462">    <span class="p">)</span>
</span><span id="1-463">
</span><span id="1-464">    <span class="n">is_deferred</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-465">    <span class="n">registry</span><span class="p">:</span> <span class="n">_RegistryType</span>
</span><span id="1-466">    <span class="n">clsdict_view</span><span class="p">:</span> <span class="n">_ClassDict</span>
</span><span id="1-467">    <span class="n">collected_annotations</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_CollectedAnnotation</span><span class="p">]</span>
</span><span id="1-468">    <span class="n">collected_attributes</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
</span><span id="1-469">    <span class="n">local_table</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FromClause</span><span class="p">]</span>
</span><span id="1-470">    <span class="n">persist_selectable</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FromClause</span><span class="p">]</span>
</span><span id="1-471">    <span class="n">declared_columns</span><span class="p">:</span> <span class="n">util</span><span class="o">.</span><span class="n">OrderedSet</span><span class="p">[</span><span class="n">Column</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
</span><span id="1-472">    <span class="n">column_ordering</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Column</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="nb">int</span><span class="p">]</span>
</span><span id="1-473">    <span class="n">column_copies</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span>
</span><span id="1-474">        <span class="n">Union</span><span class="p">[</span><span class="n">MappedColumn</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Column</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
</span><span id="1-475">        <span class="n">Union</span><span class="p">[</span><span class="n">MappedColumn</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">Column</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span>
</span><span id="1-476">    <span class="p">]</span>
</span><span id="1-477">    <span class="n">tablename</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>
</span><span id="1-478">    <span class="n">mapper_args</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
</span><span id="1-479">    <span class="n">table_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_TableArgsType</span><span class="p">]</span>
</span><span id="1-480">    <span class="n">mapper_args_fn</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Callable</span><span class="p">[[],</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]</span>
</span><span id="1-481">    <span class="n">inherits</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
</span><span id="1-482">    <span class="n">single</span><span class="p">:</span> <span class="nb">bool</span>
</span><span id="1-483">
</span><span id="1-484">    <span class="n">is_dataclass_prior_to_mapping</span><span class="p">:</span> <span class="nb">bool</span>
</span><span id="1-485">    <span class="n">allow_unmapped_annotations</span><span class="p">:</span> <span class="nb">bool</span>
</span><span id="1-486">
</span><span id="1-487">    <span class="n">dataclass_setup_arguments</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_DataclassArguments</span><span class="p">]</span>
</span><span id="1-488"><span class="w">    </span><span class="sd">&quot;&quot;&quot;if the class has SQLAlchemy native dataclass parameters, where</span>
</span><span id="1-489"><span class="sd">    we will turn the class into a dataclass within the declarative mapping</span>
</span><span id="1-490"><span class="sd">    process.</span>
</span><span id="1-491">
</span><span id="1-492"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-493">
</span><span id="1-494">    <span class="n">allow_dataclass_fields</span><span class="p">:</span> <span class="nb">bool</span>
</span><span id="1-495"><span class="w">    </span><span class="sd">&quot;&quot;&quot;if true, look for dataclass-processed Field objects on the target</span>
</span><span id="1-496"><span class="sd">    class as well as superclasses and extract ORM mapping directives from</span>
</span><span id="1-497"><span class="sd">    the &quot;metadata&quot; attribute of each Field.</span>
</span><span id="1-498">
</span><span id="1-499"><span class="sd">    if False, dataclass fields can still be used, however they won&#39;t be</span>
</span><span id="1-500"><span class="sd">    mapped.</span>
</span><span id="1-501">
</span><span id="1-502"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-503">
</span><span id="1-504">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
</span><span id="1-505">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-506">        <span class="n">registry</span><span class="p">:</span> <span class="n">_RegistryType</span><span class="p">,</span>
</span><span id="1-507">        <span class="n">cls_</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span>
</span><span id="1-508">        <span class="n">dict_</span><span class="p">:</span> <span class="n">_ClassDict</span><span class="p">,</span>
</span><span id="1-509">        <span class="n">table</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FromClause</span><span class="p">],</span>
</span><span id="1-510">        <span class="n">mapper_kw</span><span class="p">:</span> <span class="n">_MapperKwArgs</span><span class="p">,</span>
</span><span id="1-511">    <span class="p">):</span>
</span><span id="1-512">        <span class="c1"># grab class dict before the instrumentation manager has been added.</span>
</span><span id="1-513">        <span class="c1"># reduces cycles</span>
</span><span id="1-514">        <span class="bp">self</span><span class="o">.</span><span class="n">clsdict_view</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="1-515">            <span class="n">util</span><span class="o">.</span><span class="n">immutabledict</span><span class="p">(</span><span class="n">dict_</span><span class="p">)</span> <span class="k">if</span> <span class="n">dict_</span> <span class="k">else</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span>
</span><span id="1-516">        <span class="p">)</span>
</span><span id="1-517">        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">registry</span><span class="p">,</span> <span class="n">cls_</span><span class="p">,</span> <span class="n">mapper_kw</span><span class="p">)</span>
</span><span id="1-518">        <span class="bp">self</span><span class="o">.</span><span class="n">registry</span> <span class="o">=</span> <span class="n">registry</span>
</span><span id="1-519">        <span class="bp">self</span><span class="o">.</span><span class="n">persist_selectable</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-520">
</span><span id="1-521">        <span class="bp">self</span><span class="o">.</span><span class="n">collected_attributes</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="1-522">        <span class="bp">self</span><span class="o">.</span><span class="n">collected_annotations</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="1-523">        <span class="bp">self</span><span class="o">.</span><span class="n">declared_columns</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">OrderedSet</span><span class="p">()</span>
</span><span id="1-524">        <span class="bp">self</span><span class="o">.</span><span class="n">column_ordering</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="1-525">        <span class="bp">self</span><span class="o">.</span><span class="n">column_copies</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="1-526">        <span class="bp">self</span><span class="o">.</span><span class="n">single</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-527">        <span class="bp">self</span><span class="o">.</span><span class="n">dataclass_setup_arguments</span> <span class="o">=</span> <span class="n">dca</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
</span><span id="1-528">            <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="s2">&quot;_sa_apply_dc_transforms&quot;</span><span class="p">,</span> <span class="kc">None</span>
</span><span id="1-529">        <span class="p">)</span>
</span><span id="1-530">
</span><span id="1-531">        <span class="bp">self</span><span class="o">.</span><span class="n">allow_unmapped_annotations</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span>
</span><span id="1-532">            <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="s2">&quot;__allow_unmapped__&quot;</span><span class="p">,</span> <span class="kc">False</span>
</span><span id="1-533">        <span class="p">)</span> <span class="ow">or</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataclass_setup_arguments</span><span class="p">)</span>
</span><span id="1-534">
</span><span id="1-535">        <span class="bp">self</span><span class="o">.</span><span class="n">is_dataclass_prior_to_mapping</span> <span class="o">=</span> <span class="n">cld</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">is_dataclass</span><span class="p">(</span>
</span><span id="1-536">            <span class="n">cls_</span>
</span><span id="1-537">        <span class="p">)</span>
</span><span id="1-538">
</span><span id="1-539">        <span class="n">sdk</span> <span class="o">=</span> <span class="n">_get_immediate_cls_attr</span><span class="p">(</span><span class="n">cls_</span><span class="p">,</span> <span class="s2">&quot;__sa_dataclass_metadata_key__&quot;</span><span class="p">)</span>
</span><span id="1-540">
</span><span id="1-541">        <span class="c1"># we don&#39;t want to consume Field objects from a not-already-dataclass.</span>
</span><span id="1-542">        <span class="c1"># the Field objects won&#39;t have their &quot;name&quot; or &quot;type&quot; populated,</span>
</span><span id="1-543">        <span class="c1"># and while it seems like we could just set these on Field as we</span>
</span><span id="1-544">        <span class="c1"># read them, Field is documented as &quot;user read only&quot; and we need to</span>
</span><span id="1-545">        <span class="c1"># stay far away from any off-label use of dataclasses APIs.</span>
</span><span id="1-546">        <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">cld</span> <span class="ow">or</span> <span class="n">dca</span><span class="p">)</span> <span class="ow">and</span> <span class="n">sdk</span><span class="p">:</span>
</span><span id="1-547">            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span id="1-548">                <span class="s2">&quot;SQLAlchemy mapped dataclasses can&#39;t consume mapping &quot;</span>
</span><span id="1-549">                <span class="s2">&quot;information from dataclass.Field() objects if the immediate &quot;</span>
</span><span id="1-550">                <span class="s2">&quot;class is not already a dataclass.&quot;</span>
</span><span id="1-551">            <span class="p">)</span>
</span><span id="1-552">
</span><span id="1-553">        <span class="c1"># if already a dataclass, and __sa_dataclass_metadata_key__ present,</span>
</span><span id="1-554">        <span class="c1"># then also look inside of dataclass.Field() objects yielded by</span>
</span><span id="1-555">        <span class="c1"># dataclasses.get_fields(cls) when scanning for attributes</span>
</span><span id="1-556">        <span class="bp">self</span><span class="o">.</span><span class="n">allow_dataclass_fields</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">sdk</span> <span class="ow">and</span> <span class="n">cld</span><span class="p">)</span>
</span><span id="1-557">
</span><span id="1-558">        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_declared_events</span><span class="p">()</span>
</span><span id="1-559">
</span><span id="1-560">        <span class="bp">self</span><span class="o">.</span><span class="n">_scan_attributes</span><span class="p">()</span>
</span><span id="1-561">
</span><span id="1-562">        <span class="bp">self</span><span class="o">.</span><span class="n">_setup_dataclasses_transforms</span><span class="p">()</span>
</span><span id="1-563">
</span><span id="1-564">        <span class="k">with</span> <span class="n">mapperlib</span><span class="o">.</span><span class="n">_CONFIGURE_MUTEX</span><span class="p">:</span>
</span><span id="1-565">            <span class="n">clsregistry</span><span class="o">.</span><span class="n">add_class</span><span class="p">(</span>
</span><span id="1-566">                <span class="bp">self</span><span class="o">.</span><span class="n">classname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="n">registry</span><span class="o">.</span><span class="n">_class_registry</span>
</span><span id="1-567">            <span class="p">)</span>
</span><span id="1-568">
</span><span id="1-569">            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_inheriting_mapper</span><span class="p">(</span><span class="n">mapper_kw</span><span class="p">)</span>
</span><span id="1-570">
</span><span id="1-571">            <span class="bp">self</span><span class="o">.</span><span class="n">_extract_mappable_attributes</span><span class="p">()</span>
</span><span id="1-572">
</span><span id="1-573">            <span class="bp">self</span><span class="o">.</span><span class="n">_extract_declared_columns</span><span class="p">()</span>
</span><span id="1-574">
</span><span id="1-575">            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_table</span><span class="p">(</span><span class="n">table</span><span class="p">)</span>
</span><span id="1-576">
</span><span id="1-577">            <span class="bp">self</span><span class="o">.</span><span class="n">_setup_inheriting_columns</span><span class="p">(</span><span class="n">mapper_kw</span><span class="p">)</span>
</span><span id="1-578">
</span><span id="1-579">            <span class="bp">self</span><span class="o">.</span><span class="n">_early_mapping</span><span class="p">(</span><span class="n">mapper_kw</span><span class="p">)</span>
</span><span id="1-580">
</span><span id="1-581">    <span class="k">def</span> <span class="nf">_setup_declared_events</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-582">        <span class="k">if</span> <span class="n">_get_immediate_cls_attr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="s2">&quot;__declare_last__&quot;</span><span class="p">):</span>
</span><span id="1-583">
</span><span id="1-584">            <span class="nd">@event</span><span class="o">.</span><span class="n">listens_for</span><span class="p">(</span><span class="n">Mapper</span><span class="p">,</span> <span class="s2">&quot;after_configured&quot;</span><span class="p">)</span>
</span><span id="1-585">            <span class="k">def</span> <span class="nf">after_configured</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-586">                <span class="n">cast</span><span class="p">(</span>
</span><span id="1-587">                    <span class="s2">&quot;_DeclMappedClassProtocol[Any]&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span>
</span><span id="1-588">                <span class="p">)</span><span class="o">.</span><span class="n">__declare_last__</span><span class="p">()</span>
</span><span id="1-589">
</span><span id="1-590">        <span class="k">if</span> <span class="n">_get_immediate_cls_attr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="s2">&quot;__declare_first__&quot;</span><span class="p">):</span>
</span><span id="1-591">
</span><span id="1-592">            <span class="nd">@event</span><span class="o">.</span><span class="n">listens_for</span><span class="p">(</span><span class="n">Mapper</span><span class="p">,</span> <span class="s2">&quot;before_configured&quot;</span><span class="p">)</span>
</span><span id="1-593">            <span class="k">def</span> <span class="nf">before_configured</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-594">                <span class="n">cast</span><span class="p">(</span>
</span><span id="1-595">                    <span class="s2">&quot;_DeclMappedClassProtocol[Any]&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span>
</span><span id="1-596">                <span class="p">)</span><span class="o">.</span><span class="n">__declare_first__</span><span class="p">()</span>
</span><span id="1-597">
</span><span id="1-598">    <span class="k">def</span> <span class="nf">_cls_attr_override_checker</span><span class="p">(</span>
</span><span id="1-599">        <span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">]</span>
</span><span id="1-600">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="nb">bool</span><span class="p">]:</span>
</span><span id="1-601"><span class="w">        </span><span class="sd">&quot;&quot;&quot;Produce a function that checks if a class has overridden an</span>
</span><span id="1-602"><span class="sd">        attribute, taking SQLAlchemy-enabled dataclass fields into account.</span>
</span><span id="1-603">
</span><span id="1-604"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-605">
</span><span id="1-606">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_dataclass_fields</span><span class="p">:</span>
</span><span id="1-607">            <span class="n">sa_dataclass_metadata_key</span> <span class="o">=</span> <span class="n">_get_immediate_cls_attr</span><span class="p">(</span>
</span><span id="1-608">                <span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;__sa_dataclass_metadata_key__&quot;</span>
</span><span id="1-609">            <span class="p">)</span>
</span><span id="1-610">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-611">            <span class="n">sa_dataclass_metadata_key</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-612">
</span><span id="1-613">        <span class="k">if</span> <span class="ow">not</span> <span class="n">sa_dataclass_metadata_key</span><span class="p">:</span>
</span><span id="1-614">
</span><span id="1-615">            <span class="k">def</span> <span class="nf">attribute_is_overridden</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="1-616">                <span class="k">return</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">obj</span>
</span><span id="1-617">
</span><span id="1-618">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-619">            <span class="n">all_datacls_fields</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="1-620">                <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">sa_dataclass_metadata_key</span><span class="p">]</span>
</span><span id="1-621">                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">util</span><span class="o">.</span><span class="n">dataclass_fields</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
</span><span id="1-622">                <span class="k">if</span> <span class="n">sa_dataclass_metadata_key</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">metadata</span>
</span><span id="1-623">            <span class="p">}</span>
</span><span id="1-624">            <span class="n">local_datacls_fields</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="1-625">                <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="n">sa_dataclass_metadata_key</span><span class="p">]</span>
</span><span id="1-626">                <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">util</span><span class="o">.</span><span class="n">local_dataclass_fields</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
</span><span id="1-627">                <span class="k">if</span> <span class="n">sa_dataclass_metadata_key</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">metadata</span>
</span><span id="1-628">            <span class="p">}</span>
</span><span id="1-629">
</span><span id="1-630">            <span class="n">absent</span> <span class="o">=</span> <span class="nb">object</span><span class="p">()</span>
</span><span id="1-631">
</span><span id="1-632">            <span class="k">def</span> <span class="nf">attribute_is_overridden</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="1-633">                <span class="k">if</span> <span class="n">_is_declarative_props</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
</span><span id="1-634">                    <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">fget</span>
</span><span id="1-635">
</span><span id="1-636">                <span class="c1"># this function likely has some failure modes still if</span>
</span><span id="1-637">                <span class="c1"># someone is doing a deep mixing of the same attribute</span>
</span><span id="1-638">                <span class="c1"># name as plain Python attribute vs. dataclass field.</span>
</span><span id="1-639">
</span><span id="1-640">                <span class="n">ret</span> <span class="o">=</span> <span class="n">local_datacls_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">absent</span><span class="p">)</span>
</span><span id="1-641">                <span class="k">if</span> <span class="n">_is_declarative_props</span><span class="p">(</span><span class="n">ret</span><span class="p">):</span>
</span><span id="1-642">                    <span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">fget</span>
</span><span id="1-643">
</span><span id="1-644">                <span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="n">obj</span><span class="p">:</span>
</span><span id="1-645">                    <span class="k">return</span> <span class="kc">False</span>
</span><span id="1-646">                <span class="k">elif</span> <span class="n">ret</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">absent</span><span class="p">:</span>
</span><span id="1-647">                    <span class="k">return</span> <span class="kc">True</span>
</span><span id="1-648">
</span><span id="1-649">                <span class="n">all_field</span> <span class="o">=</span> <span class="n">all_datacls_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">absent</span><span class="p">)</span>
</span><span id="1-650">
</span><span id="1-651">                <span class="n">ret</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
</span><span id="1-652">
</span><span id="1-653">                <span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="n">obj</span><span class="p">:</span>
</span><span id="1-654">                    <span class="k">return</span> <span class="kc">False</span>
</span><span id="1-655">
</span><span id="1-656">                <span class="c1"># for dataclasses, this could be the</span>
</span><span id="1-657">                <span class="c1"># &#39;default&#39; of the field.  so filter more specifically</span>
</span><span id="1-658">                <span class="c1"># for an already-mapped InstrumentedAttribute</span>
</span><span id="1-659">                <span class="k">if</span> <span class="n">ret</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">absent</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
</span><span id="1-660">                    <span class="n">ret</span><span class="p">,</span> <span class="n">InstrumentedAttribute</span>
</span><span id="1-661">                <span class="p">):</span>
</span><span id="1-662">                    <span class="k">return</span> <span class="kc">True</span>
</span><span id="1-663">
</span><span id="1-664">                <span class="k">if</span> <span class="n">all_field</span> <span class="ow">is</span> <span class="n">obj</span><span class="p">:</span>
</span><span id="1-665">                    <span class="k">return</span> <span class="kc">False</span>
</span><span id="1-666">                <span class="k">elif</span> <span class="n">all_field</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">absent</span><span class="p">:</span>
</span><span id="1-667">                    <span class="k">return</span> <span class="kc">True</span>
</span><span id="1-668">
</span><span id="1-669">                <span class="c1"># can&#39;t find another attribute</span>
</span><span id="1-670">                <span class="k">return</span> <span class="kc">False</span>
</span><span id="1-671">
</span><span id="1-672">        <span class="k">return</span> <span class="n">attribute_is_overridden</span>
</span><span id="1-673">
</span><span id="1-674">    <span class="n">_include_dunders</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="1-675">        <span class="s2">&quot;__table__&quot;</span><span class="p">,</span>
</span><span id="1-676">        <span class="s2">&quot;__mapper_args__&quot;</span><span class="p">,</span>
</span><span id="1-677">        <span class="s2">&quot;__tablename__&quot;</span><span class="p">,</span>
</span><span id="1-678">        <span class="s2">&quot;__table_args__&quot;</span><span class="p">,</span>
</span><span id="1-679">    <span class="p">}</span>
</span><span id="1-680">
</span><span id="1-681">    <span class="n">_match_exclude_dunders</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^(?:_sa_|__)&quot;</span><span class="p">)</span>
</span><span id="1-682">
</span><span id="1-683">    <span class="k">def</span> <span class="nf">_cls_attr_resolver</span><span class="p">(</span>
</span><span id="1-684">        <span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
</span><span id="1-685">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Callable</span><span class="p">[[],</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]]:</span>
</span><span id="1-686"><span class="w">        </span><span class="sd">&quot;&quot;&quot;produce a function to iterate the &quot;attributes&quot; of a class</span>
</span><span id="1-687"><span class="sd">        which we want to consider for mapping, adjusting for SQLAlchemy fields</span>
</span><span id="1-688"><span class="sd">        embedded in dataclass fields.</span>
</span><span id="1-689">
</span><span id="1-690"><span class="sd">        &quot;&quot;&quot;</span>
</span><span id="1-691">        <span class="n">cls_annotations</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">get_annotations</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
</span><span id="1-692">
</span><span id="1-693">        <span class="n">cls_vars</span> <span class="o">=</span> <span class="nb">vars</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
</span><span id="1-694">
</span><span id="1-695">        <span class="n">_include_dunders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_include_dunders</span>
</span><span id="1-696">        <span class="n">_match_exclude_dunders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match_exclude_dunders</span>
</span><span id="1-697">
</span><span id="1-698">        <span class="n">names</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="1-699">            <span class="n">n</span>
</span><span id="1-700">            <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">util</span><span class="o">.</span><span class="n">merge_lists_w_ordering</span><span class="p">(</span>
</span><span id="1-701">                <span class="nb">list</span><span class="p">(</span><span class="n">cls_vars</span><span class="p">),</span> <span class="nb">list</span><span class="p">(</span><span class="n">cls_annotations</span><span class="p">)</span>
</span><span id="1-702">            <span class="p">)</span>
</span><span id="1-703">            <span class="k">if</span> <span class="ow">not</span> <span class="n">_match_exclude_dunders</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="ow">or</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">_include_dunders</span>
</span><span id="1-704">        <span class="p">]</span>
</span><span id="1-705">
</span><span id="1-706">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_dataclass_fields</span><span class="p">:</span>
</span><span id="1-707">            <span class="n">sa_dataclass_metadata_key</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="n">_get_immediate_cls_attr</span><span class="p">(</span>
</span><span id="1-708">                <span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;__sa_dataclass_metadata_key__&quot;</span>
</span><span id="1-709">            <span class="p">)</span>
</span><span id="1-710">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-711">            <span class="n">sa_dataclass_metadata_key</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-712">
</span><span id="1-713">        <span class="k">if</span> <span class="ow">not</span> <span class="n">sa_dataclass_metadata_key</span><span class="p">:</span>
</span><span id="1-714">
</span><span id="1-715">            <span class="k">def</span> <span class="nf">local_attributes_for_class</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="p">(</span>
</span><span id="1-716">                <span class="n">Iterable</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span>
</span><span id="1-717">            <span class="p">):</span>
</span><span id="1-718">                <span class="k">return</span> <span class="p">(</span>
</span><span id="1-719">                    <span class="p">(</span>
</span><span id="1-720">                        <span class="n">name</span><span class="p">,</span>
</span><span id="1-721">                        <span class="n">cls_vars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">),</span>
</span><span id="1-722">                        <span class="n">cls_annotations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">),</span>
</span><span id="1-723">                        <span class="kc">False</span><span class="p">,</span>
</span><span id="1-724">                    <span class="p">)</span>
</span><span id="1-725">                    <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span>
</span><span id="1-726">                <span class="p">)</span>
</span><span id="1-727">
</span><span id="1-728">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-729">            <span class="n">dataclass_fields</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="1-730">                <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">:</span> <span class="n">field</span> <span class="k">for</span> <span class="n">field</span> <span class="ow">in</span> <span class="n">util</span><span class="o">.</span><span class="n">local_dataclass_fields</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
</span><span id="1-731">            <span class="p">}</span>
</span><span id="1-732">
</span><span id="1-733">            <span class="n">fixed_sa_dataclass_metadata_key</span> <span class="o">=</span> <span class="n">sa_dataclass_metadata_key</span>
</span><span id="1-734">
</span><span id="1-735">            <span class="k">def</span> <span class="nf">local_attributes_for_class</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="p">(</span>
</span><span id="1-736">                <span class="n">Iterable</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span>
</span><span id="1-737">            <span class="p">):</span>
</span><span id="1-738">                <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
</span><span id="1-739">                    <span class="n">field</span> <span class="o">=</span> <span class="n">dataclass_fields</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="1-740">                    <span class="k">if</span> <span class="n">field</span> <span class="ow">and</span> <span class="n">sa_dataclass_metadata_key</span> <span class="ow">in</span> <span class="n">field</span><span class="o">.</span><span class="n">metadata</span><span class="p">:</span>
</span><span id="1-741">                        <span class="k">yield</span> <span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">_as_dc_declaredattr</span><span class="p">(</span>
</span><span id="1-742">                            <span class="n">field</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span> <span class="n">fixed_sa_dataclass_metadata_key</span>
</span><span id="1-743">                        <span class="p">),</span> <span class="n">cls_annotations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">field</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="kc">True</span>
</span><span id="1-744">                    <span class="k">else</span><span class="p">:</span>
</span><span id="1-745">                        <span class="k">yield</span> <span class="n">name</span><span class="p">,</span> <span class="n">cls_vars</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">cls_annotations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="1-746">                            <span class="n">name</span>
</span><span id="1-747">                        <span class="p">),</span> <span class="kc">False</span>
</span><span id="1-748">
</span><span id="1-749">        <span class="k">return</span> <span class="n">local_attributes_for_class</span>
</span><span id="1-750">
</span><span id="1-751">    <span class="k">def</span> <span class="nf">_scan_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-752">        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span>
</span><span id="1-753">
</span><span id="1-754">        <span class="n">cls_as_Decl</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;_DeclMappedClassProtocol[Any]&quot;</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>
</span><span id="1-755">
</span><span id="1-756">        <span class="n">clsdict_view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clsdict_view</span>
</span><span id="1-757">        <span class="n">collected_attributes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collected_attributes</span>
</span><span id="1-758">        <span class="n">column_copies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_copies</span>
</span><span id="1-759">        <span class="n">_include_dunders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_include_dunders</span>
</span><span id="1-760">        <span class="n">mapper_args_fn</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-761">        <span class="n">table_args</span> <span class="o">=</span> <span class="n">inherited_table_args</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-762">
</span><span id="1-763">        <span class="n">tablename</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-764">        <span class="n">fixed_table</span> <span class="o">=</span> <span class="s2">&quot;__table__&quot;</span> <span class="ow">in</span> <span class="n">clsdict_view</span>
</span><span id="1-765">
</span><span id="1-766">        <span class="n">attribute_is_overridden</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cls_attr_override_checker</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">)</span>
</span><span id="1-767">
</span><span id="1-768">        <span class="n">bases</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="1-769">
</span><span id="1-770">        <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__mro__</span><span class="p">:</span>
</span><span id="1-771">            <span class="c1"># collect bases and make sure standalone columns are copied</span>
</span><span id="1-772">            <span class="c1"># to be the column they will ultimately be on the class,</span>
</span><span id="1-773">            <span class="c1"># so that declared_attr functions use the right columns.</span>
</span><span id="1-774">            <span class="c1"># need to do this all the way up the hierarchy first</span>
</span><span id="1-775">            <span class="c1"># (see #8190)</span>
</span><span id="1-776">
</span><span id="1-777">            <span class="n">class_mapped</span> <span class="o">=</span> <span class="n">base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">cls</span> <span class="ow">and</span> <span class="n">_is_supercls_for_inherits</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
</span><span id="1-778">
</span><span id="1-779">            <span class="n">local_attributes_for_class</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cls_attr_resolver</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
</span><span id="1-780">
</span><span id="1-781">            <span class="k">if</span> <span class="ow">not</span> <span class="n">class_mapped</span> <span class="ow">and</span> <span class="n">base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">cls</span><span class="p">:</span>
</span><span id="1-782">                <span class="n">locally_collected_columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_produce_column_copies</span><span class="p">(</span>
</span><span id="1-783">                    <span class="n">local_attributes_for_class</span><span class="p">,</span>
</span><span id="1-784">                    <span class="n">attribute_is_overridden</span><span class="p">,</span>
</span><span id="1-785">                    <span class="n">fixed_table</span><span class="p">,</span>
</span><span id="1-786">                    <span class="n">base</span><span class="p">,</span>
</span><span id="1-787">                <span class="p">)</span>
</span><span id="1-788">            <span class="k">else</span><span class="p">:</span>
</span><span id="1-789">                <span class="n">locally_collected_columns</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="1-790">
</span><span id="1-791">            <span class="n">bases</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
</span><span id="1-792">                <span class="p">(</span>
</span><span id="1-793">                    <span class="n">base</span><span class="p">,</span>
</span><span id="1-794">                    <span class="n">class_mapped</span><span class="p">,</span>
</span><span id="1-795">                    <span class="n">local_attributes_for_class</span><span class="p">,</span>
</span><span id="1-796">                    <span class="n">locally_collected_columns</span><span class="p">,</span>
</span><span id="1-797">                <span class="p">)</span>
</span><span id="1-798">            <span class="p">)</span>
</span><span id="1-799">
</span><span id="1-800">        <span class="k">for</span> <span class="p">(</span>
</span><span id="1-801">            <span class="n">base</span><span class="p">,</span>
</span><span id="1-802">            <span class="n">class_mapped</span><span class="p">,</span>
</span><span id="1-803">            <span class="n">local_attributes_for_class</span><span class="p">,</span>
</span><span id="1-804">            <span class="n">locally_collected_columns</span><span class="p">,</span>
</span><span id="1-805">        <span class="p">)</span> <span class="ow">in</span> <span class="n">bases</span><span class="p">:</span>
</span><span id="1-806">            <span class="c1"># this transfer can also take place as we scan each name</span>
</span><span id="1-807">            <span class="c1"># for finer-grained control of how collected_attributes is</span>
</span><span id="1-808">            <span class="c1"># populated, as this is what impacts column ordering.</span>
</span><span id="1-809">            <span class="c1"># however it&#39;s simpler to get it out of the way here.</span>
</span><span id="1-810">            <span class="n">collected_attributes</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">locally_collected_columns</span><span class="p">)</span>
</span><span id="1-811">
</span><span id="1-812">            <span class="k">for</span> <span class="p">(</span>
</span><span id="1-813">                <span class="n">name</span><span class="p">,</span>
</span><span id="1-814">                <span class="n">obj</span><span class="p">,</span>
</span><span id="1-815">                <span class="n">annotation</span><span class="p">,</span>
</span><span id="1-816">                <span class="n">is_dataclass_field</span><span class="p">,</span>
</span><span id="1-817">            <span class="p">)</span> <span class="ow">in</span> <span class="n">local_attributes_for_class</span><span class="p">():</span>
</span><span id="1-818">                <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">_include_dunders</span><span class="p">:</span>
</span><span id="1-819">                    <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;__mapper_args__&quot;</span><span class="p">:</span>
</span><span id="1-820">                        <span class="n">check_decl</span> <span class="o">=</span> <span class="n">_check_declared_props_nocascade</span><span class="p">(</span>
</span><span id="1-821">                            <span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">cls</span>
</span><span id="1-822">                        <span class="p">)</span>
</span><span id="1-823">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">mapper_args_fn</span> <span class="ow">and</span> <span class="p">(</span>
</span><span id="1-824">                            <span class="ow">not</span> <span class="n">class_mapped</span> <span class="ow">or</span> <span class="n">check_decl</span>
</span><span id="1-825">                        <span class="p">):</span>
</span><span id="1-826">                            <span class="c1"># don&#39;t even invoke __mapper_args__ until</span>
</span><span id="1-827">                            <span class="c1"># after we&#39;ve determined everything about the</span>
</span><span id="1-828">                            <span class="c1"># mapped table.</span>
</span><span id="1-829">                            <span class="c1"># make a copy of it so a class-level dictionary</span>
</span><span id="1-830">                            <span class="c1"># is not overwritten when we update column-based</span>
</span><span id="1-831">                            <span class="c1"># arguments.</span>
</span><span id="1-832">                            <span class="k">def</span> <span class="nf">_mapper_args_fn</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
</span><span id="1-833">                                <span class="k">return</span> <span class="nb">dict</span><span class="p">(</span><span class="n">cls_as_Decl</span><span class="o">.</span><span class="n">__mapper_args__</span><span class="p">)</span>
</span><span id="1-834">
</span><span id="1-835">                            <span class="n">mapper_args_fn</span> <span class="o">=</span> <span class="n">_mapper_args_fn</span>
</span><span id="1-836">
</span><span id="1-837">                    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;__tablename__&quot;</span><span class="p">:</span>
</span><span id="1-838">                        <span class="n">check_decl</span> <span class="o">=</span> <span class="n">_check_declared_props_nocascade</span><span class="p">(</span>
</span><span id="1-839">                            <span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">cls</span>
</span><span id="1-840">                        <span class="p">)</span>
</span><span id="1-841">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">tablename</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">class_mapped</span> <span class="ow">or</span> <span class="n">check_decl</span><span class="p">):</span>
</span><span id="1-842">                            <span class="n">tablename</span> <span class="o">=</span> <span class="n">cls_as_Decl</span><span class="o">.</span><span class="n">__tablename__</span>
</span><span id="1-843">                    <span class="k">elif</span> <span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;__table_args__&quot;</span><span class="p">:</span>
</span><span id="1-844">                        <span class="n">check_decl</span> <span class="o">=</span> <span class="n">_check_declared_props_nocascade</span><span class="p">(</span>
</span><span id="1-845">                            <span class="n">obj</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">cls</span>
</span><span id="1-846">                        <span class="p">)</span>
</span><span id="1-847">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">table_args</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">class_mapped</span> <span class="ow">or</span> <span class="n">check_decl</span><span class="p">):</span>
</span><span id="1-848">                            <span class="n">table_args</span> <span class="o">=</span> <span class="n">cls_as_Decl</span><span class="o">.</span><span class="n">__table_args__</span>
</span><span id="1-849">                            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
</span><span id="1-850">                                <span class="n">table_args</span><span class="p">,</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">dict</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
</span><span id="1-851">                            <span class="p">):</span>
</span><span id="1-852">                                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span id="1-853">                                    <span class="s2">&quot;__table_args__ value must be a tuple, &quot;</span>
</span><span id="1-854">                                    <span class="s2">&quot;dict, or None&quot;</span>
</span><span id="1-855">                                <span class="p">)</span>
</span><span id="1-856">                            <span class="k">if</span> <span class="n">base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">cls</span><span class="p">:</span>
</span><span id="1-857">                                <span class="n">inherited_table_args</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="1-858">                    <span class="k">else</span><span class="p">:</span>
</span><span id="1-859">                        <span class="c1"># skip all other dunder names, which at the moment</span>
</span><span id="1-860">                        <span class="c1"># should only be __table__</span>
</span><span id="1-861">                        <span class="k">continue</span>
</span><span id="1-862">                <span class="k">elif</span> <span class="n">class_mapped</span><span class="p">:</span>
</span><span id="1-863">                    <span class="k">if</span> <span class="n">_is_declarative_props</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">obj</span><span class="o">.</span><span class="n">_quiet</span><span class="p">:</span>
</span><span id="1-864">                        <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span id="1-865">                            <span class="s2">&quot;Regular (i.e. not __special__) &quot;</span>
</span><span id="1-866">                            <span class="s2">&quot;attribute &#39;</span><span class="si">%s</span><span class="s2">.</span><span class="si">%s</span><span class="s2">&#39; uses @declared_attr, &quot;</span>
</span><span id="1-867">                            <span class="s2">&quot;but owning class </span><span class="si">%s</span><span class="s2"> is mapped - &quot;</span>
</span><span id="1-868">                            <span class="s2">&quot;not applying to subclass </span><span class="si">%s</span><span class="s2">.&quot;</span>
</span><span id="1-869">                            <span class="o">%</span> <span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>
</span><span id="1-870">                        <span class="p">)</span>
</span><span id="1-871">
</span><span id="1-872">                    <span class="k">continue</span>
</span><span id="1-873">                <span class="k">elif</span> <span class="n">base</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">cls</span><span class="p">:</span>
</span><span id="1-874">                    <span class="c1"># we&#39;re a mixin, abstract base, or something that is</span>
</span><span id="1-875">                    <span class="c1"># acting like that for now.</span>
</span><span id="1-876">
</span><span id="1-877">                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="n">Column</span><span class="p">,</span> <span class="n">MappedColumn</span><span class="p">)):</span>
</span><span id="1-878">                        <span class="c1"># already copied columns to the mapped class.</span>
</span><span id="1-879">                        <span class="k">continue</span>
</span><span id="1-880">                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">MapperProperty</span><span class="p">):</span>
</span><span id="1-881">                        <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span id="1-882">                            <span class="s2">&quot;Mapper properties (i.e. deferred,&quot;</span>
</span><span id="1-883">                            <span class="s2">&quot;column_property(), relationship(), etc.) must &quot;</span>
</span><span id="1-884">                            <span class="s2">&quot;be declared as @declared_attr callables &quot;</span>
</span><span id="1-885">                            <span class="s2">&quot;on declarative mixin classes.  For dataclass &quot;</span>
</span><span id="1-886">                            <span class="s2">&quot;field() objects, use a lambda:&quot;</span>
</span><span id="1-887">                        <span class="p">)</span>
</span><span id="1-888">                    <span class="k">elif</span> <span class="n">_is_declarative_props</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
</span><span id="1-889">                        <span class="c1"># tried to get overloads to tell this to</span>
</span><span id="1-890">                        <span class="c1"># pylance, no luck</span>
</span><span id="1-891">                        <span class="k">assert</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="1-892">
</span><span id="1-893">                        <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">_cascading</span><span class="p">:</span>
</span><span id="1-894">                            <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">clsdict_view</span><span class="p">:</span>
</span><span id="1-895">                                <span class="c1"># unfortunately, while we can use the user-</span>
</span><span id="1-896">                                <span class="c1"># defined attribute here to allow a clean</span>
</span><span id="1-897">                                <span class="c1"># override, if there&#39;s another</span>
</span><span id="1-898">                                <span class="c1"># subclass below then it still tries to use</span>
</span><span id="1-899">                                <span class="c1"># this.  not sure if there is enough</span>
</span><span id="1-900">                                <span class="c1"># information here to add this as a feature</span>
</span><span id="1-901">                                <span class="c1"># later on.</span>
</span><span id="1-902">                                <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span id="1-903">                                    <span class="s2">&quot;Attribute &#39;</span><span class="si">%s</span><span class="s2">&#39; on class </span><span class="si">%s</span><span class="s2"> cannot be &quot;</span>
</span><span id="1-904">                                    <span class="s2">&quot;processed due to &quot;</span>
</span><span id="1-905">                                    <span class="s2">&quot;@declared_attr.cascading; &quot;</span>
</span><span id="1-906">                                    <span class="s2">&quot;skipping&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>
</span><span id="1-907">                                <span class="p">)</span>
</span><span id="1-908">                            <span class="n">collected_attributes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">column_copies</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="1-909">                                <span class="n">ret</span>
</span><span id="1-910">                            <span class="p">)</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="fm">__get__</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>
</span><span id="1-911">                            <span class="nb">setattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">ret</span><span class="p">)</span>
</span><span id="1-912">                        <span class="k">else</span><span class="p">:</span>
</span><span id="1-913">                            <span class="k">if</span> <span class="n">is_dataclass_field</span><span class="p">:</span>
</span><span id="1-914">                                <span class="c1"># access attribute using normal class access</span>
</span><span id="1-915">                                <span class="c1"># first, to see if it&#39;s been mapped on a</span>
</span><span id="1-916">                                <span class="c1"># superclass.   note if the dataclasses.field()</span>
</span><span id="1-917">                                <span class="c1"># has &quot;default&quot;, this value can be anything.</span>
</span><span id="1-918">                                <span class="n">ret</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="1-919">
</span><span id="1-920">                                <span class="c1"># so, if it&#39;s anything that&#39;s not ORM</span>
</span><span id="1-921">                                <span class="c1"># mapped, assume we should invoke the</span>
</span><span id="1-922">                                <span class="c1"># declared_attr</span>
</span><span id="1-923">                                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">InspectionAttr</span><span class="p">):</span>
</span><span id="1-924">                                    <span class="n">ret</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">fget</span><span class="p">()</span>
</span><span id="1-925">                            <span class="k">else</span><span class="p">:</span>
</span><span id="1-926">                                <span class="c1"># access attribute using normal class access.</span>
</span><span id="1-927">                                <span class="c1"># if the declared attr already took place</span>
</span><span id="1-928">                                <span class="c1"># on a superclass that is mapped, then</span>
</span><span id="1-929">                                <span class="c1"># this is no longer a declared_attr, it will</span>
</span><span id="1-930">                                <span class="c1"># be the InstrumentedAttribute</span>
</span><span id="1-931">                                <span class="n">ret</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">)</span>
</span><span id="1-932">
</span><span id="1-933">                            <span class="c1"># correct for proxies created from hybrid_property</span>
</span><span id="1-934">                            <span class="c1"># or similar.  note there is no known case that</span>
</span><span id="1-935">                            <span class="c1"># produces nested proxies, so we are only</span>
</span><span id="1-936">                            <span class="c1"># looking one level deep right now.</span>
</span><span id="1-937">
</span><span id="1-938">                            <span class="k">if</span> <span class="p">(</span>
</span><span id="1-939">                                <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="n">InspectionAttr</span><span class="p">)</span>
</span><span id="1-940">                                <span class="ow">and</span> <span class="n">attr_is_internal_proxy</span><span class="p">(</span><span class="n">ret</span><span class="p">)</span>
</span><span id="1-941">                                <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
</span><span id="1-942">                                    <span class="n">ret</span><span class="o">.</span><span class="n">original_property</span><span class="p">,</span> <span class="n">MapperProperty</span>
</span><span id="1-943">                                <span class="p">)</span>
</span><span id="1-944">                            <span class="p">):</span>
</span><span id="1-945">                                <span class="n">ret</span> <span class="o">=</span> <span class="n">ret</span><span class="o">.</span><span class="n">descriptor</span>
</span><span id="1-946">
</span><span id="1-947">                            <span class="n">collected_attributes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">column_copies</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="1-948">                                <span class="n">ret</span>
</span><span id="1-949">                            <span class="p">)</span>
</span><span id="1-950">
</span><span id="1-951">                        <span class="k">if</span> <span class="p">(</span>
</span><span id="1-952">                            <span class="nb">isinstance</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="p">(</span><span class="n">Column</span><span class="p">,</span> <span class="n">MapperProperty</span><span class="p">))</span>
</span><span id="1-953">                            <span class="ow">and</span> <span class="n">ret</span><span class="o">.</span><span class="n">doc</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="1-954">                        <span class="p">):</span>
</span><span id="1-955">                            <span class="n">ret</span><span class="o">.</span><span class="n">doc</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="vm">__doc__</span>
</span><span id="1-956">
</span><span id="1-957">                        <span class="bp">self</span><span class="o">.</span><span class="n">_collect_annotation</span><span class="p">(</span>
</span><span id="1-958">                            <span class="n">name</span><span class="p">,</span>
</span><span id="1-959">                            <span class="n">obj</span><span class="o">.</span><span class="n">_collect_return_annotation</span><span class="p">(),</span>
</span><span id="1-960">                            <span class="n">base</span><span class="p">,</span>
</span><span id="1-961">                            <span class="kc">True</span><span class="p">,</span>
</span><span id="1-962">                            <span class="n">obj</span><span class="p">,</span>
</span><span id="1-963">                        <span class="p">)</span>
</span><span id="1-964">                    <span class="k">elif</span> <span class="n">_is_mapped_annotation</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">base</span><span class="p">):</span>
</span><span id="1-965">                        <span class="c1"># Mapped annotation without any object.</span>
</span><span id="1-966">                        <span class="c1"># product_column_copies should have handled this.</span>
</span><span id="1-967">                        <span class="c1"># if future support for other MapperProperty,</span>
</span><span id="1-968">                        <span class="c1"># then test if this name is already handled and</span>
</span><span id="1-969">                        <span class="c1"># otherwise proceed to generate.</span>
</span><span id="1-970">                        <span class="k">if</span> <span class="ow">not</span> <span class="n">fixed_table</span><span class="p">:</span>
</span><span id="1-971">                            <span class="k">assert</span> <span class="p">(</span>
</span><span id="1-972">                                <span class="n">name</span> <span class="ow">in</span> <span class="n">collected_attributes</span>
</span><span id="1-973">                                <span class="ow">or</span> <span class="n">attribute_is_overridden</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="1-974">                            <span class="p">)</span>
</span><span id="1-975">                        <span class="k">continue</span>
</span><span id="1-976">                    <span class="k">else</span><span class="p">:</span>
</span><span id="1-977">                        <span class="c1"># here, the attribute is some other kind of</span>
</span><span id="1-978">                        <span class="c1"># property that we assume is not part of the</span>
</span><span id="1-979">                        <span class="c1"># declarative mapping.  however, check for some</span>
</span><span id="1-980">                        <span class="c1"># more common mistakes</span>
</span><span id="1-981">                        <span class="bp">self</span><span class="o">.</span><span class="n">_warn_for_decl_attributes</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
</span><span id="1-982">                <span class="k">elif</span> <span class="n">is_dataclass_field</span> <span class="ow">and</span> <span class="p">(</span>
</span><span id="1-983">                    <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">clsdict_view</span> <span class="ow">or</span> <span class="n">clsdict_view</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">obj</span>
</span><span id="1-984">                <span class="p">):</span>
</span><span id="1-985">                    <span class="c1"># here, we are definitely looking at the target class</span>
</span><span id="1-986">                    <span class="c1"># and not a superclass.   this is currently a</span>
</span><span id="1-987">                    <span class="c1"># dataclass-only path.  if the name is only</span>
</span><span id="1-988">                    <span class="c1"># a dataclass field and isn&#39;t in local cls.__dict__,</span>
</span><span id="1-989">                    <span class="c1"># put the object there.</span>
</span><span id="1-990">                    <span class="c1"># assert that the dataclass-enabled resolver agrees</span>
</span><span id="1-991">                    <span class="c1"># with what we are seeing</span>
</span><span id="1-992">
</span><span id="1-993">                    <span class="k">assert</span> <span class="ow">not</span> <span class="n">attribute_is_overridden</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
</span><span id="1-994">
</span><span id="1-995">                    <span class="k">if</span> <span class="n">_is_declarative_props</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
</span><span id="1-996">                        <span class="n">obj</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">fget</span><span class="p">()</span>
</span><span id="1-997">
</span><span id="1-998">                    <span class="n">collected_attributes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
</span><span id="1-999">                    <span class="bp">self</span><span class="o">.</span><span class="n">_collect_annotation</span><span class="p">(</span>
</span><span id="1-1000">                        <span class="n">name</span><span class="p">,</span> <span class="n">annotation</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="n">obj</span>
</span><span id="1-1001">                    <span class="p">)</span>
</span><span id="1-1002">                <span class="k">else</span><span class="p">:</span>
</span><span id="1-1003">                    <span class="n">collected_annotation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_annotation</span><span class="p">(</span>
</span><span id="1-1004">                        <span class="n">name</span><span class="p">,</span> <span class="n">annotation</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="n">obj</span>
</span><span id="1-1005">                    <span class="p">)</span>
</span><span id="1-1006">                    <span class="n">is_mapped</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="1-1007">                        <span class="n">collected_annotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="1-1008">                        <span class="ow">and</span> <span class="n">collected_annotation</span><span class="o">.</span><span class="n">mapped_container</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="1-1009">                    <span class="p">)</span>
</span><span id="1-1010">                    <span class="n">generated_obj</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="1-1011">                        <span class="n">collected_annotation</span><span class="o">.</span><span class="n">attr_value</span>
</span><span id="1-1012">                        <span class="k">if</span> <span class="n">collected_annotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="1-1013">                        <span class="k">else</span> <span class="n">obj</span>
</span><span id="1-1014">                    <span class="p">)</span>
</span><span id="1-1015">                    <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">fixed_table</span> <span class="ow">and</span> <span class="n">is_mapped</span><span class="p">:</span>
</span><span id="1-1016">                        <span class="n">collected_attributes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="1-1017">                            <span class="n">generated_obj</span>
</span><span id="1-1018">                            <span class="k">if</span> <span class="n">generated_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="1-1019">                            <span class="k">else</span> <span class="n">MappedColumn</span><span class="p">()</span>
</span><span id="1-1020">                        <span class="p">)</span>
</span><span id="1-1021">                    <span class="k">elif</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">clsdict_view</span><span class="p">:</span>
</span><span id="1-1022">                        <span class="n">collected_attributes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
</span><span id="1-1023">                    <span class="c1"># else if the name is not in the cls.__dict__,</span>
</span><span id="1-1024">                    <span class="c1"># don&#39;t collect it as an attribute.</span>
</span><span id="1-1025">                    <span class="c1"># we will see the annotation only, which is meaningful</span>
</span><span id="1-1026">                    <span class="c1"># both for mapping and dataclasses setup</span>
</span><span id="1-1027">
</span><span id="1-1028">        <span class="k">if</span> <span class="n">inherited_table_args</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">tablename</span><span class="p">:</span>
</span><span id="1-1029">            <span class="n">table_args</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-1030">
</span><span id="1-1031">        <span class="bp">self</span><span class="o">.</span><span class="n">table_args</span> <span class="o">=</span> <span class="n">table_args</span>
</span><span id="1-1032">        <span class="bp">self</span><span class="o">.</span><span class="n">tablename</span> <span class="o">=</span> <span class="n">tablename</span>
</span><span id="1-1033">        <span class="bp">self</span><span class="o">.</span><span class="n">mapper_args_fn</span> <span class="o">=</span> <span class="n">mapper_args_fn</span>
</span><span id="1-1034">
</span><span id="1-1035">    <span class="k">def</span> <span class="nf">_setup_dataclasses_transforms</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1036">        <span class="n">dataclass_setup_arguments</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dataclass_setup_arguments</span>
</span><span id="1-1037">        <span class="k">if</span> <span class="ow">not</span> <span class="n">dataclass_setup_arguments</span><span class="p">:</span>
</span><span id="1-1038">            <span class="k">return</span>
</span><span id="1-1039">
</span><span id="1-1040">        <span class="c1"># can&#39;t use is_dataclass since it uses hasattr</span>
</span><span id="1-1041">        <span class="k">if</span> <span class="s2">&quot;__dataclass_fields__&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
</span><span id="1-1042">            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span id="1-1043">                <span class="sa">f</span><span class="s2">&quot;Class </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="si">}</span><span class="s2"> is already a dataclass; ensure that &quot;</span>
</span><span id="1-1044">                <span class="s2">&quot;base classes / decorator styles of establishing dataclasses &quot;</span>
</span><span id="1-1045">                <span class="s2">&quot;are not being mixed. &quot;</span>
</span><span id="1-1046">                <span class="s2">&quot;This can happen if a class that inherits from &quot;</span>
</span><span id="1-1047">                <span class="s2">&quot;&#39;MappedAsDataclass&#39;, even indirectly, is been mapped with &quot;</span>
</span><span id="1-1048">                <span class="s2">&quot;&#39;@registry.mapped_as_dataclass&#39;&quot;</span>
</span><span id="1-1049">            <span class="p">)</span>
</span><span id="1-1050">
</span><span id="1-1051">        <span class="n">warn_for_non_dc_attrs</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
</span><span id="1-1052">
</span><span id="1-1053">        <span class="k">def</span> <span class="nf">_allow_dataclass_field</span><span class="p">(</span>
</span><span id="1-1054">            <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">originating_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
</span><span id="1-1055">        <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="1-1056">            <span class="k">if</span> <span class="p">(</span>
</span><span id="1-1057">                <span class="n">originating_class</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span>
</span><span id="1-1058">                <span class="ow">and</span> <span class="s2">&quot;__dataclass_fields__&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">originating_class</span><span class="o">.</span><span class="vm">__dict__</span>
</span><span id="1-1059">            <span class="p">):</span>
</span><span id="1-1060">                <span class="n">warn_for_non_dc_attrs</span><span class="p">[</span><span class="n">originating_class</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span id="1-1061">
</span><span id="1-1062">            <span class="k">return</span> <span class="kc">True</span>
</span><span id="1-1063">
</span><span id="1-1064">        <span class="n">manager</span> <span class="o">=</span> <span class="n">instrumentation</span><span class="o">.</span><span class="n">manager_of_class</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">)</span>
</span><span id="1-1065">        <span class="k">assert</span> <span class="n">manager</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="1-1066">
</span><span id="1-1067">        <span class="n">field_list</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="1-1068">            <span class="n">_AttributeOptions</span><span class="o">.</span><span class="n">_get_arguments_for_make_dataclass</span><span class="p">(</span>
</span><span id="1-1069">                <span class="n">key</span><span class="p">,</span>
</span><span id="1-1070">                <span class="n">anno</span><span class="p">,</span>
</span><span id="1-1071">                <span class="n">mapped_container</span><span class="p">,</span>
</span><span id="1-1072">                <span class="bp">self</span><span class="o">.</span><span class="n">collected_attributes</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">),</span>
</span><span id="1-1073">            <span class="p">)</span>
</span><span id="1-1074">            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">anno</span><span class="p">,</span> <span class="n">mapped_container</span> <span class="ow">in</span> <span class="p">(</span>
</span><span id="1-1075">                <span class="p">(</span>
</span><span id="1-1076">                    <span class="n">key</span><span class="p">,</span>
</span><span id="1-1077">                    <span class="n">mapped_anno</span> <span class="k">if</span> <span class="n">mapped_anno</span> <span class="k">else</span> <span class="n">raw_anno</span><span class="p">,</span>
</span><span id="1-1078">                    <span class="n">mapped_container</span><span class="p">,</span>
</span><span id="1-1079">                <span class="p">)</span>
</span><span id="1-1080">                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="p">(</span>
</span><span id="1-1081">                    <span class="n">raw_anno</span><span class="p">,</span>
</span><span id="1-1082">                    <span class="n">mapped_container</span><span class="p">,</span>
</span><span id="1-1083">                    <span class="n">mapped_anno</span><span class="p">,</span>
</span><span id="1-1084">                    <span class="n">is_dc</span><span class="p">,</span>
</span><span id="1-1085">                    <span class="n">attr_value</span><span class="p">,</span>
</span><span id="1-1086">                    <span class="n">originating_module</span><span class="p">,</span>
</span><span id="1-1087">                    <span class="n">originating_class</span><span class="p">,</span>
</span><span id="1-1088">                <span class="p">)</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collected_annotations</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="1-1089">                <span class="k">if</span> <span class="n">_allow_dataclass_field</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">originating_class</span><span class="p">)</span>
</span><span id="1-1090">                <span class="ow">and</span> <span class="p">(</span>
</span><span id="1-1091">                    <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collected_attributes</span>
</span><span id="1-1092">                    <span class="c1"># issue #9226; check for attributes that we&#39;ve collected</span>
</span><span id="1-1093">                    <span class="c1"># which are already instrumented, which we would assume</span>
</span><span id="1-1094">                    <span class="c1"># mean we are in an ORM inheritance mapping and this</span>
</span><span id="1-1095">                    <span class="c1"># attribute is already mapped on the superclass.   Under</span>
</span><span id="1-1096">                    <span class="c1"># no circumstance should any QueryableAttribute be sent to</span>
</span><span id="1-1097">                    <span class="c1"># the dataclass() function; anything that&#39;s mapped should</span>
</span><span id="1-1098">                    <span class="c1"># be Field and that&#39;s it</span>
</span><span id="1-1099">                    <span class="ow">or</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span>
</span><span id="1-1100">                        <span class="bp">self</span><span class="o">.</span><span class="n">collected_attributes</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">QueryableAttribute</span>
</span><span id="1-1101">                    <span class="p">)</span>
</span><span id="1-1102">                <span class="p">)</span>
</span><span id="1-1103">            <span class="p">)</span>
</span><span id="1-1104">        <span class="p">]</span>
</span><span id="1-1105">
</span><span id="1-1106">        <span class="k">if</span> <span class="n">warn_for_non_dc_attrs</span><span class="p">:</span>
</span><span id="1-1107">            <span class="k">for</span> <span class="p">(</span>
</span><span id="1-1108">                <span class="n">originating_class</span><span class="p">,</span>
</span><span id="1-1109">                <span class="n">non_dc_attrs</span><span class="p">,</span>
</span><span id="1-1110">            <span class="p">)</span> <span class="ow">in</span> <span class="n">warn_for_non_dc_attrs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="1-1111">                <span class="n">util</span><span class="o">.</span><span class="n">warn_deprecated</span><span class="p">(</span>
</span><span id="1-1112">                    <span class="sa">f</span><span class="s2">&quot;When transforming </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="si">}</span><span class="s2"> to a dataclass, &quot;</span>
</span><span id="1-1113">                    <span class="sa">f</span><span class="s2">&quot;attribute(s) &quot;</span>
</span><span id="1-1114">                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">non_dc_attrs</span><span class="p">)</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span id="1-1115">                    <span class="sa">f</span><span class="s2">&quot;originates from superclass &quot;</span>
</span><span id="1-1116">                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">originating_class</span><span class="si">}</span><span class="s2">, which is not a dataclass.  This &quot;</span>
</span><span id="1-1117">                    <span class="sa">f</span><span class="s2">&quot;usage is deprecated and will raise an error in &quot;</span>
</span><span id="1-1118">                    <span class="sa">f</span><span class="s2">&quot;SQLAlchemy 2.1.  When declaring SQLAlchemy Declarative &quot;</span>
</span><span id="1-1119">                    <span class="sa">f</span><span class="s2">&quot;Dataclasses, ensure that all mixin classes and other &quot;</span>
</span><span id="1-1120">                    <span class="sa">f</span><span class="s2">&quot;superclasses which include attributes are also a &quot;</span>
</span><span id="1-1121">                    <span class="sa">f</span><span class="s2">&quot;subclass of MappedAsDataclass.&quot;</span><span class="p">,</span>
</span><span id="1-1122">                    <span class="s2">&quot;2.0&quot;</span><span class="p">,</span>
</span><span id="1-1123">                    <span class="n">code</span><span class="o">=</span><span class="s2">&quot;dcmx&quot;</span><span class="p">,</span>
</span><span id="1-1124">                <span class="p">)</span>
</span><span id="1-1125">
</span><span id="1-1126">        <span class="n">annotations</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="1-1127">        <span class="n">defaults</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="1-1128">        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">field_list</span><span class="p">:</span>
</span><span id="1-1129">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
</span><span id="1-1130">                <span class="n">name</span><span class="p">,</span> <span class="n">tp</span> <span class="o">=</span> <span class="n">item</span>
</span><span id="1-1131">            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
</span><span id="1-1132">                <span class="n">name</span><span class="p">,</span> <span class="n">tp</span><span class="p">,</span> <span class="n">spec</span> <span class="o">=</span> <span class="n">item</span>
</span><span id="1-1133">                <span class="n">defaults</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">spec</span>
</span><span id="1-1134">            <span class="k">else</span><span class="p">:</span>
</span><span id="1-1135">                <span class="k">assert</span> <span class="kc">False</span>
</span><span id="1-1136">            <span class="n">annotations</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">tp</span>
</span><span id="1-1137">
</span><span id="1-1138">        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">defaults</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="1-1139">            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
</span><span id="1-1140">
</span><span id="1-1141">        <span class="bp">self</span><span class="o">.</span><span class="n">_apply_dataclasses_to_any_class</span><span class="p">(</span>
</span><span id="1-1142">            <span class="n">dataclass_setup_arguments</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="n">annotations</span>
</span><span id="1-1143">        <span class="p">)</span>
</span><span id="1-1144">
</span><span id="1-1145">    <span class="nd">@classmethod</span>
</span><span id="1-1146">    <span class="k">def</span> <span class="nf">_update_annotations_for_non_mapped_class</span><span class="p">(</span>
</span><span id="1-1147">        <span class="bp">cls</span><span class="p">,</span> <span class="n">klass</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">]</span>
</span><span id="1-1148">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_AnnotationScanType</span><span class="p">]:</span>
</span><span id="1-1149">        <span class="n">cls_annotations</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">get_annotations</span><span class="p">(</span><span class="n">klass</span><span class="p">)</span>
</span><span id="1-1150">
</span><span id="1-1151">        <span class="n">new_anno</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="1-1152">        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">annotation</span> <span class="ow">in</span> <span class="n">cls_annotations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="1-1153">            <span class="k">if</span> <span class="n">_is_mapped_annotation</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="n">klass</span><span class="p">,</span> <span class="n">klass</span><span class="p">):</span>
</span><span id="1-1154">                <span class="n">extracted</span> <span class="o">=</span> <span class="n">_extract_mapped_subtype</span><span class="p">(</span>
</span><span id="1-1155">                    <span class="n">annotation</span><span class="p">,</span>
</span><span id="1-1156">                    <span class="n">klass</span><span class="p">,</span>
</span><span id="1-1157">                    <span class="n">klass</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
</span><span id="1-1158">                    <span class="n">name</span><span class="p">,</span>
</span><span id="1-1159">                    <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
</span><span id="1-1160">                    <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="1-1161">                    <span class="n">is_dataclass_field</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="1-1162">                    <span class="n">expect_mapped</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="1-1163">                <span class="p">)</span>
</span><span id="1-1164">                <span class="k">if</span> <span class="n">extracted</span><span class="p">:</span>
</span><span id="1-1165">                    <span class="n">inner</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">extracted</span>
</span><span id="1-1166">                    <span class="n">new_anno</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">inner</span>
</span><span id="1-1167">            <span class="k">else</span><span class="p">:</span>
</span><span id="1-1168">                <span class="n">new_anno</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">annotation</span>
</span><span id="1-1169">        <span class="k">return</span> <span class="n">new_anno</span>
</span><span id="1-1170">
</span><span id="1-1171">    <span class="nd">@classmethod</span>
</span><span id="1-1172">    <span class="k">def</span> <span class="nf">_apply_dataclasses_to_any_class</span><span class="p">(</span>
</span><span id="1-1173">        <span class="bp">cls</span><span class="p">,</span>
</span><span id="1-1174">        <span class="n">dataclass_setup_arguments</span><span class="p">:</span> <span class="n">_DataclassArguments</span><span class="p">,</span>
</span><span id="1-1175">        <span class="n">klass</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">_O</span><span class="p">],</span>
</span><span id="1-1176">        <span class="n">use_annotations</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">_AnnotationScanType</span><span class="p">],</span>
</span><span id="1-1177">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1178">        <span class="bp">cls</span><span class="o">.</span><span class="n">_assert_dc_arguments</span><span class="p">(</span><span class="n">dataclass_setup_arguments</span><span class="p">)</span>
</span><span id="1-1179">
</span><span id="1-1180">        <span class="n">dataclass_callable</span> <span class="o">=</span> <span class="n">dataclass_setup_arguments</span><span class="p">[</span><span class="s2">&quot;dataclass_callable&quot;</span><span class="p">]</span>
</span><span id="1-1181">        <span class="k">if</span> <span class="n">dataclass_callable</span> <span class="ow">is</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span><span class="p">:</span>
</span><span id="1-1182">            <span class="n">dataclass_callable</span> <span class="o">=</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">dataclass</span>
</span><span id="1-1183">
</span><span id="1-1184">        <span class="n">restored</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
</span><span id="1-1185">
</span><span id="1-1186">        <span class="k">if</span> <span class="n">use_annotations</span><span class="p">:</span>
</span><span id="1-1187">            <span class="c1"># apply constructed annotations that should look &quot;normal&quot; to a</span>
</span><span id="1-1188">            <span class="c1"># dataclasses callable, based on the fields present.  This</span>
</span><span id="1-1189">            <span class="c1"># means remove the Mapped[] container and ensure all Field</span>
</span><span id="1-1190">            <span class="c1"># entries have an annotation</span>
</span><span id="1-1191">            <span class="n">restored</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="s2">&quot;__annotations__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="1-1192">            <span class="n">klass</span><span class="o">.</span><span class="vm">__annotations__</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;Dict[str, Any]&quot;</span><span class="p">,</span> <span class="n">use_annotations</span><span class="p">)</span>
</span><span id="1-1193">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-1194">            <span class="n">restored</span> <span class="o">=</span> <span class="kc">None</span>
</span><span id="1-1195">
</span><span id="1-1196">        <span class="k">try</span><span class="p">:</span>
</span><span id="1-1197">            <span class="n">dataclass_callable</span><span class="p">(</span>
</span><span id="1-1198">                <span class="n">klass</span><span class="p">,</span>
</span><span id="1-1199">                <span class="o">**</span><span class="p">{</span>
</span><span id="1-1200">                    <span class="n">k</span><span class="p">:</span> <span class="n">v</span>
</span><span id="1-1201">                    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dataclass_setup_arguments</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
</span><span id="1-1202">                    <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span> <span class="ow">and</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;dataclass_callable&quot;</span>
</span><span id="1-1203">                <span class="p">},</span>
</span><span id="1-1204">            <span class="p">)</span>
</span><span id="1-1205">        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">)</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
</span><span id="1-1206">            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span id="1-1207">                <span class="sa">f</span><span class="s2">&quot;Python dataclasses error encountered when creating &quot;</span>
</span><span id="1-1208">                <span class="sa">f</span><span class="s2">&quot;dataclass for </span><span class="si">{</span><span class="n">klass</span><span class="o">.</span><span class="vm">__name__</span><span class="si">!r}</span><span class="s2">: &quot;</span>
</span><span id="1-1209">                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">ex</span><span class="si">!r}</span><span class="s2">. Please refer to Python dataclasses &quot;</span>
</span><span id="1-1210">                <span class="s2">&quot;documentation for additional information.&quot;</span><span class="p">,</span>
</span><span id="1-1211">                <span class="n">code</span><span class="o">=</span><span class="s2">&quot;dcte&quot;</span><span class="p">,</span>
</span><span id="1-1212">            <span class="p">)</span> <span class="kn">from</span> <span class="nn">ex</span>
</span><span id="1-1213">        <span class="k">finally</span><span class="p">:</span>
</span><span id="1-1214">            <span class="c1"># restore original annotations outside of the dataclasses</span>
</span><span id="1-1215">            <span class="c1"># process; for mixins and __abstract__ superclasses, SQLAlchemy</span>
</span><span id="1-1216">            <span class="c1"># Declarative will need to see the Mapped[] container inside the</span>
</span><span id="1-1217">            <span class="c1"># annotations in order to map subclasses</span>
</span><span id="1-1218">            <span class="k">if</span> <span class="n">use_annotations</span><span class="p">:</span>
</span><span id="1-1219">                <span class="k">if</span> <span class="n">restored</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1220">                    <span class="k">del</span> <span class="n">klass</span><span class="o">.</span><span class="vm">__annotations__</span>
</span><span id="1-1221">                <span class="k">else</span><span class="p">:</span>
</span><span id="1-1222">                    <span class="n">klass</span><span class="o">.</span><span class="vm">__annotations__</span> <span class="o">=</span> <span class="n">restored</span>
</span><span id="1-1223">
</span><span id="1-1224">    <span class="nd">@classmethod</span>
</span><span id="1-1225">    <span class="k">def</span> <span class="nf">_assert_dc_arguments</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">arguments</span><span class="p">:</span> <span class="n">_DataclassArguments</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1226">        <span class="n">allowed</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="1-1227">            <span class="s2">&quot;init&quot;</span><span class="p">,</span>
</span><span id="1-1228">            <span class="s2">&quot;repr&quot;</span><span class="p">,</span>
</span><span id="1-1229">            <span class="s2">&quot;order&quot;</span><span class="p">,</span>
</span><span id="1-1230">            <span class="s2">&quot;eq&quot;</span><span class="p">,</span>
</span><span id="1-1231">            <span class="s2">&quot;unsafe_hash&quot;</span><span class="p">,</span>
</span><span id="1-1232">            <span class="s2">&quot;kw_only&quot;</span><span class="p">,</span>
</span><span id="1-1233">            <span class="s2">&quot;match_args&quot;</span><span class="p">,</span>
</span><span id="1-1234">            <span class="s2">&quot;dataclass_callable&quot;</span><span class="p">,</span>
</span><span id="1-1235">        <span class="p">}</span>
</span><span id="1-1236">        <span class="n">disallowed_args</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">arguments</span><span class="p">)</span><span class="o">.</span><span class="n">difference</span><span class="p">(</span><span class="n">allowed</span><span class="p">)</span>
</span><span id="1-1237">        <span class="k">if</span> <span class="n">disallowed_args</span><span class="p">:</span>
</span><span id="1-1238">            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">arg</span><span class="si">!r}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">arg</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">disallowed_args</span><span class="p">))</span>
</span><span id="1-1239">            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span id="1-1240">                <span class="sa">f</span><span class="s2">&quot;Dataclass argument(s) </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2"> are not accepted&quot;</span>
</span><span id="1-1241">            <span class="p">)</span>
</span><span id="1-1242">
</span><span id="1-1243">    <span class="k">def</span> <span class="nf">_collect_annotation</span><span class="p">(</span>
</span><span id="1-1244">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1245">        <span class="n">name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
</span><span id="1-1246">        <span class="n">raw_annotation</span><span class="p">:</span> <span class="n">_AnnotationScanType</span><span class="p">,</span>
</span><span id="1-1247">        <span class="n">originating_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-1248">        <span class="n">expect_mapped</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">bool</span><span class="p">],</span>
</span><span id="1-1249">        <span class="n">attr_value</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span>
</span><span id="1-1250">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">_CollectedAnnotation</span><span class="p">]:</span>
</span><span id="1-1251">        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">collected_annotations</span><span class="p">:</span>
</span><span id="1-1252">            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">collected_annotations</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
</span><span id="1-1253">
</span><span id="1-1254">        <span class="k">if</span> <span class="n">raw_annotation</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1255">            <span class="k">return</span> <span class="kc">None</span>
</span><span id="1-1256">
</span><span id="1-1257">        <span class="n">is_dataclass</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_dataclass_prior_to_mapping</span>
</span><span id="1-1258">        <span class="n">allow_unmapped</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_unmapped_annotations</span>
</span><span id="1-1259">
</span><span id="1-1260">        <span class="k">if</span> <span class="n">expect_mapped</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1261">            <span class="n">is_dataclass_field</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr_value</span><span class="p">,</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">Field</span><span class="p">)</span>
</span><span id="1-1262">            <span class="n">expect_mapped</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="1-1263">                <span class="ow">not</span> <span class="n">is_dataclass_field</span>
</span><span id="1-1264">                <span class="ow">and</span> <span class="ow">not</span> <span class="n">allow_unmapped</span>
</span><span id="1-1265">                <span class="ow">and</span> <span class="p">(</span>
</span><span id="1-1266">                    <span class="n">attr_value</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="1-1267">                    <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">attr_value</span><span class="p">,</span> <span class="n">_MappedAttribute</span><span class="p">)</span>
</span><span id="1-1268">                <span class="p">)</span>
</span><span id="1-1269">            <span class="p">)</span>
</span><span id="1-1270">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-1271">            <span class="n">is_dataclass_field</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-1272">
</span><span id="1-1273">        <span class="n">is_dataclass_field</span> <span class="o">=</span> <span class="kc">False</span>
</span><span id="1-1274">        <span class="n">extracted</span> <span class="o">=</span> <span class="n">_extract_mapped_subtype</span><span class="p">(</span>
</span><span id="1-1275">            <span class="n">raw_annotation</span><span class="p">,</span>
</span><span id="1-1276">            <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span>
</span><span id="1-1277">            <span class="n">originating_class</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
</span><span id="1-1278">            <span class="n">name</span><span class="p">,</span>
</span><span id="1-1279">            <span class="nb">type</span><span class="p">(</span><span class="n">attr_value</span><span class="p">),</span>
</span><span id="1-1280">            <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
</span><span id="1-1281">            <span class="n">is_dataclass_field</span><span class="o">=</span><span class="n">is_dataclass_field</span><span class="p">,</span>
</span><span id="1-1282">            <span class="n">expect_mapped</span><span class="o">=</span><span class="n">expect_mapped</span>
</span><span id="1-1283">            <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_dataclass</span><span class="p">,</span>  <span class="c1"># self.allow_dataclass_fields,</span>
</span><span id="1-1284">        <span class="p">)</span>
</span><span id="1-1285">
</span><span id="1-1286">        <span class="k">if</span> <span class="n">extracted</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1287">            <span class="c1"># ClassVar can come out here</span>
</span><span id="1-1288">            <span class="k">return</span> <span class="kc">None</span>
</span><span id="1-1289">
</span><span id="1-1290">        <span class="n">extracted_mapped_annotation</span><span class="p">,</span> <span class="n">mapped_container</span> <span class="o">=</span> <span class="n">extracted</span>
</span><span id="1-1291">
</span><span id="1-1292">        <span class="k">if</span> <span class="n">attr_value</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">is_literal</span><span class="p">(</span><span class="n">extracted_mapped_annotation</span><span class="p">):</span>
</span><span id="1-1293">            <span class="k">for</span> <span class="n">elem</span> <span class="ow">in</span> <span class="n">typing_get_args</span><span class="p">(</span><span class="n">extracted_mapped_annotation</span><span class="p">):</span>
</span><span id="1-1294">                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="n">is_fwd_ref</span><span class="p">(</span>
</span><span id="1-1295">                    <span class="n">elem</span><span class="p">,</span> <span class="n">check_generic</span><span class="o">=</span><span class="kc">True</span>
</span><span id="1-1296">                <span class="p">):</span>
</span><span id="1-1297">                    <span class="n">elem</span> <span class="o">=</span> <span class="n">de_stringify_annotation</span><span class="p">(</span>
</span><span id="1-1298">                        <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span>
</span><span id="1-1299">                        <span class="n">elem</span><span class="p">,</span>
</span><span id="1-1300">                        <span class="n">originating_class</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
</span><span id="1-1301">                        <span class="n">include_generic</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
</span><span id="1-1302">                    <span class="p">)</span>
</span><span id="1-1303">                <span class="c1"># look in Annotated[...] for an ORM construct,</span>
</span><span id="1-1304">                <span class="c1"># such as Annotated[int, mapped_column(primary_key=True)]</span>
</span><span id="1-1305">                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elem</span><span class="p">,</span> <span class="n">_IntrospectsAnnotations</span><span class="p">):</span>
</span><span id="1-1306">                    <span class="n">attr_value</span> <span class="o">=</span> <span class="n">elem</span><span class="o">.</span><span class="n">found_in_pep593_annotated</span><span class="p">()</span>
</span><span id="1-1307">
</span><span id="1-1308">        <span class="bp">self</span><span class="o">.</span><span class="n">collected_annotations</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">ca</span> <span class="o">=</span> <span class="n">_CollectedAnnotation</span><span class="p">(</span>
</span><span id="1-1309">            <span class="n">raw_annotation</span><span class="p">,</span>
</span><span id="1-1310">            <span class="n">mapped_container</span><span class="p">,</span>
</span><span id="1-1311">            <span class="n">extracted_mapped_annotation</span><span class="p">,</span>
</span><span id="1-1312">            <span class="n">is_dataclass</span><span class="p">,</span>
</span><span id="1-1313">            <span class="n">attr_value</span><span class="p">,</span>
</span><span id="1-1314">            <span class="n">originating_class</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
</span><span id="1-1315">            <span class="n">originating_class</span><span class="p">,</span>
</span><span id="1-1316">        <span class="p">)</span>
</span><span id="1-1317">        <span class="k">return</span> <span class="n">ca</span>
</span><span id="1-1318">
</span><span id="1-1319">    <span class="k">def</span> <span class="nf">_warn_for_decl_attributes</span><span class="p">(</span>
</span><span id="1-1320">        <span class="bp">self</span><span class="p">,</span> <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">c</span><span class="p">:</span> <span class="n">Any</span>
</span><span id="1-1321">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1322">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">expression</span><span class="o">.</span><span class="n">ColumnElement</span><span class="p">):</span>
</span><span id="1-1323">            <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span id="1-1324">                <span class="sa">f</span><span class="s2">&quot;Attribute &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39; on class </span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s2"> appears to &quot;</span>
</span><span id="1-1325">                <span class="s2">&quot;be a non-schema SQLAlchemy expression &quot;</span>
</span><span id="1-1326">                <span class="s2">&quot;object; this won&#39;t be part of the declarative mapping. &quot;</span>
</span><span id="1-1327">                <span class="s2">&quot;To map arbitrary expressions, use ``column_property()`` &quot;</span>
</span><span id="1-1328">                <span class="s2">&quot;or a similar function such as ``deferred()``, &quot;</span>
</span><span id="1-1329">                <span class="s2">&quot;``query_expression()`` etc. &quot;</span>
</span><span id="1-1330">            <span class="p">)</span>
</span><span id="1-1331">
</span><span id="1-1332">    <span class="k">def</span> <span class="nf">_produce_column_copies</span><span class="p">(</span>
</span><span id="1-1333">        <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1334">        <span class="n">attributes_for_class</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[</span>
</span><span id="1-1335">            <span class="p">[],</span> <span class="n">Iterable</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="n">Any</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span>
</span><span id="1-1336">        <span class="p">],</span>
</span><span id="1-1337">        <span class="n">attribute_is_overridden</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="nb">bool</span><span class="p">],</span>
</span><span id="1-1338">        <span class="n">fixed_table</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
</span><span id="1-1339">        <span class="n">originating_class</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span>
</span><span id="1-1340">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="n">Column</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">MappedColumn</span><span class="p">[</span><span class="n">Any</span><span class="p">]]]:</span>
</span><span id="1-1341">        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span>
</span><span id="1-1342">        <span class="n">dict_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clsdict_view</span>
</span><span id="1-1343">        <span class="n">locally_collected_attributes</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="1-1344">        <span class="n">column_copies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_copies</span>
</span><span id="1-1345">        <span class="c1"># copy mixin columns to the mapped class</span>
</span><span id="1-1346">
</span><span id="1-1347">        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="p">,</span> <span class="n">annotation</span><span class="p">,</span> <span class="n">is_dataclass</span> <span class="ow">in</span> <span class="n">attributes_for_class</span><span class="p">():</span>
</span><span id="1-1348">            <span class="k">if</span> <span class="p">(</span>
</span><span id="1-1349">                <span class="ow">not</span> <span class="n">fixed_table</span>
</span><span id="1-1350">                <span class="ow">and</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="1-1351">                <span class="ow">and</span> <span class="n">_is_mapped_annotation</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="bp">cls</span><span class="p">,</span> <span class="n">originating_class</span><span class="p">)</span>
</span><span id="1-1352">            <span class="p">):</span>
</span><span id="1-1353">                <span class="c1"># obj is None means this is the annotation only path</span>
</span><span id="1-1354">
</span><span id="1-1355">                <span class="k">if</span> <span class="n">attribute_is_overridden</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
</span><span id="1-1356">                    <span class="c1"># perform same &quot;overridden&quot; check as we do for</span>
</span><span id="1-1357">                    <span class="c1"># Column/MappedColumn, this is how a mixin col is not</span>
</span><span id="1-1358">                    <span class="c1"># applied to an inherited subclass that does not have</span>
</span><span id="1-1359">                    <span class="c1"># the mixin.   the anno-only path added here for</span>
</span><span id="1-1360">                    <span class="c1"># #9564</span>
</span><span id="1-1361">                    <span class="k">continue</span>
</span><span id="1-1362">
</span><span id="1-1363">                <span class="n">collected_annotation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_annotation</span><span class="p">(</span>
</span><span id="1-1364">                    <span class="n">name</span><span class="p">,</span> <span class="n">annotation</span><span class="p">,</span> <span class="n">originating_class</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">obj</span>
</span><span id="1-1365">                <span class="p">)</span>
</span><span id="1-1366">                <span class="n">obj</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="1-1367">                    <span class="n">collected_annotation</span><span class="o">.</span><span class="n">attr_value</span>
</span><span id="1-1368">                    <span class="k">if</span> <span class="n">collected_annotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="1-1369">                    <span class="k">else</span> <span class="n">obj</span>
</span><span id="1-1370">                <span class="p">)</span>
</span><span id="1-1371">                <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1372">                    <span class="n">obj</span> <span class="o">=</span> <span class="n">MappedColumn</span><span class="p">()</span>
</span><span id="1-1373">
</span><span id="1-1374">                <span class="n">locally_collected_attributes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
</span><span id="1-1375">                <span class="nb">setattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="p">)</span>
</span><span id="1-1376">
</span><span id="1-1377">            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="n">Column</span><span class="p">,</span> <span class="n">MappedColumn</span><span class="p">)):</span>
</span><span id="1-1378">                <span class="k">if</span> <span class="n">attribute_is_overridden</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
</span><span id="1-1379">                    <span class="c1"># if column has been overridden</span>
</span><span id="1-1380">                    <span class="c1"># (like by the InstrumentedAttribute of the</span>
</span><span id="1-1381">                    <span class="c1"># superclass), skip.  don&#39;t collect the annotation</span>
</span><span id="1-1382">                    <span class="c1"># either (issue #8718)</span>
</span><span id="1-1383">                    <span class="k">continue</span>
</span><span id="1-1384">
</span><span id="1-1385">                <span class="n">collected_annotation</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_collect_annotation</span><span class="p">(</span>
</span><span id="1-1386">                    <span class="n">name</span><span class="p">,</span> <span class="n">annotation</span><span class="p">,</span> <span class="n">originating_class</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="n">obj</span>
</span><span id="1-1387">                <span class="p">)</span>
</span><span id="1-1388">                <span class="n">obj</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="1-1389">                    <span class="n">collected_annotation</span><span class="o">.</span><span class="n">attr_value</span>
</span><span id="1-1390">                    <span class="k">if</span> <span class="n">collected_annotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="1-1391">                    <span class="k">else</span> <span class="n">obj</span>
</span><span id="1-1392">                <span class="p">)</span>
</span><span id="1-1393">
</span><span id="1-1394">                <span class="k">if</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dict_</span> <span class="ow">and</span> <span class="ow">not</span> <span class="p">(</span>
</span><span id="1-1395">                    <span class="s2">&quot;__table__&quot;</span> <span class="ow">in</span> <span class="n">dict_</span>
</span><span id="1-1396">                    <span class="ow">and</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="n">name</span><span class="p">)</span>
</span><span id="1-1397">                    <span class="ow">in</span> <span class="n">dict_</span><span class="p">[</span><span class="s2">&quot;__table__&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">c</span>
</span><span id="1-1398">                <span class="p">):</span>
</span><span id="1-1399">                    <span class="k">if</span> <span class="n">obj</span><span class="o">.</span><span class="n">foreign_keys</span><span class="p">:</span>
</span><span id="1-1400">                        <span class="k">for</span> <span class="n">fk</span> <span class="ow">in</span> <span class="n">obj</span><span class="o">.</span><span class="n">foreign_keys</span><span class="p">:</span>
</span><span id="1-1401">                            <span class="k">if</span> <span class="p">(</span>
</span><span id="1-1402">                                <span class="n">fk</span><span class="o">.</span><span class="n">_table_column</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="1-1403">                                <span class="ow">and</span> <span class="n">fk</span><span class="o">.</span><span class="n">_table_column</span><span class="o">.</span><span class="n">table</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="1-1404">                            <span class="p">):</span>
</span><span id="1-1405">                                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span id="1-1406">                                    <span class="s2">&quot;Columns with foreign keys to &quot;</span>
</span><span id="1-1407">                                    <span class="s2">&quot;non-table-bound &quot;</span>
</span><span id="1-1408">                                    <span class="s2">&quot;columns must be declared as &quot;</span>
</span><span id="1-1409">                                    <span class="s2">&quot;@declared_attr callables &quot;</span>
</span><span id="1-1410">                                    <span class="s2">&quot;on declarative mixin classes.  &quot;</span>
</span><span id="1-1411">                                    <span class="s2">&quot;For dataclass &quot;</span>
</span><span id="1-1412">                                    <span class="s2">&quot;field() objects, use a lambda:.&quot;</span>
</span><span id="1-1413">                                <span class="p">)</span>
</span><span id="1-1414">
</span><span id="1-1415">                    <span class="n">column_copies</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy_</span> <span class="o">=</span> <span class="n">obj</span><span class="o">.</span><span class="n">_copy</span><span class="p">()</span>
</span><span id="1-1416">
</span><span id="1-1417">                    <span class="n">locally_collected_attributes</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy_</span>
</span><span id="1-1418">                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">copy_</span><span class="p">)</span>
</span><span id="1-1419">
</span><span id="1-1420">        <span class="k">return</span> <span class="n">locally_collected_attributes</span>
</span><span id="1-1421">
</span><span id="1-1422">    <span class="k">def</span> <span class="nf">_extract_mappable_attributes</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1423">        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span>
</span><span id="1-1424">        <span class="n">collected_attributes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collected_attributes</span>
</span><span id="1-1425">
</span><span id="1-1426">        <span class="n">our_stuff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span>
</span><span id="1-1427">
</span><span id="1-1428">        <span class="n">_include_dunders</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_include_dunders</span>
</span><span id="1-1429">
</span><span id="1-1430">        <span class="n">late_mapped</span> <span class="o">=</span> <span class="n">_get_immediate_cls_attr</span><span class="p">(</span>
</span><span id="1-1431">            <span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;_sa_decl_prepare_nocascade&quot;</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="kc">True</span>
</span><span id="1-1432">        <span class="p">)</span>
</span><span id="1-1433">
</span><span id="1-1434">        <span class="n">allow_unmapped_annotations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_unmapped_annotations</span>
</span><span id="1-1435">        <span class="n">expect_annotations_wo_mapped</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="1-1436">            <span class="n">allow_unmapped_annotations</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_dataclass_prior_to_mapping</span>
</span><span id="1-1437">        <span class="p">)</span>
</span><span id="1-1438">
</span><span id="1-1439">        <span class="n">look_for_dataclass_things</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dataclass_setup_arguments</span><span class="p">)</span>
</span><span id="1-1440">
</span><span id="1-1441">        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">collected_attributes</span><span class="p">):</span>
</span><span id="1-1442">            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">_include_dunders</span><span class="p">:</span>
</span><span id="1-1443">                <span class="k">continue</span>
</span><span id="1-1444">
</span><span id="1-1445">            <span class="n">value</span> <span class="o">=</span> <span class="n">collected_attributes</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
</span><span id="1-1446">
</span><span id="1-1447">            <span class="k">if</span> <span class="n">_is_declarative_props</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
</span><span id="1-1448">                <span class="c1"># @declared_attr in collected_attributes only occurs here for a</span>
</span><span id="1-1449">                <span class="c1"># @declared_attr that&#39;s directly on the mapped class;</span>
</span><span id="1-1450">                <span class="c1"># for a mixin, these have already been evaluated</span>
</span><span id="1-1451">                <span class="k">if</span> <span class="n">value</span><span class="o">.</span><span class="n">_cascading</span><span class="p">:</span>
</span><span id="1-1452">                    <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span id="1-1453">                        <span class="s2">&quot;Use of @declared_attr.cascading only applies to &quot;</span>
</span><span id="1-1454">                        <span class="s2">&quot;Declarative &#39;mixin&#39; and &#39;abstract&#39; classes.  &quot;</span>
</span><span id="1-1455">                        <span class="s2">&quot;Currently, this flag is ignored on mapped class &quot;</span>
</span><span id="1-1456">                        <span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span>
</span><span id="1-1457">                    <span class="p">)</span>
</span><span id="1-1458">
</span><span id="1-1459">                <span class="n">value</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span>
</span><span id="1-1460">
</span><span id="1-1461">            <span class="k">elif</span> <span class="p">(</span>
</span><span id="1-1462">                <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">QueryableAttribute</span><span class="p">)</span>
</span><span id="1-1463">                <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">class_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">cls</span>
</span><span id="1-1464">                <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">key</span> <span class="o">!=</span> <span class="n">k</span>
</span><span id="1-1465">            <span class="p">):</span>
</span><span id="1-1466">                <span class="c1"># detect a QueryableAttribute that&#39;s already mapped being</span>
</span><span id="1-1467">                <span class="c1"># assigned elsewhere in userland, turn into a synonym()</span>
</span><span id="1-1468">                <span class="n">value</span> <span class="o">=</span> <span class="n">SynonymProperty</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
</span><span id="1-1469">                <span class="nb">setattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span id="1-1470">
</span><span id="1-1471">            <span class="k">if</span> <span class="p">(</span>
</span><span id="1-1472">                <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span>
</span><span id="1-1473">                <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
</span><span id="1-1474">                <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="n">Column</span><span class="p">,</span> <span class="n">_MappedAttribute</span><span class="p">))</span>
</span><span id="1-1475">            <span class="p">):</span>
</span><span id="1-1476">                <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span id="1-1477">                    <span class="s2">&quot;Ignoring declarative-like tuple value of attribute &quot;</span>
</span><span id="1-1478">                    <span class="s2">&quot;&#39;</span><span class="si">%s</span><span class="s2">&#39;: possibly a copy-and-paste error with a comma &quot;</span>
</span><span id="1-1479">                    <span class="s2">&quot;accidentally placed at the end of the line?&quot;</span> <span class="o">%</span> <span class="n">k</span>
</span><span id="1-1480">                <span class="p">)</span>
</span><span id="1-1481">                <span class="k">continue</span>
</span><span id="1-1482">            <span class="k">elif</span> <span class="n">look_for_dataclass_things</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span>
</span><span id="1-1483">                <span class="n">value</span><span class="p">,</span> <span class="n">dataclasses</span><span class="o">.</span><span class="n">Field</span>
</span><span id="1-1484">            <span class="p">):</span>
</span><span id="1-1485">                <span class="c1"># we collected a dataclass Field; dataclasses would have</span>
</span><span id="1-1486">                <span class="c1"># set up the correct state on the class</span>
</span><span id="1-1487">                <span class="k">continue</span>
</span><span id="1-1488">            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">Column</span><span class="p">,</span> <span class="n">_DCAttributeOptions</span><span class="p">)):</span>
</span><span id="1-1489">                <span class="c1"># using @declared_attr for some object that</span>
</span><span id="1-1490">                <span class="c1"># isn&#39;t Column/MapperProperty/_DCAttributeOptions; remove</span>
</span><span id="1-1491">                <span class="c1"># from the clsdict_view</span>
</span><span id="1-1492">                <span class="c1"># and place the evaluated value onto the class.</span>
</span><span id="1-1493">                <span class="n">collected_attributes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
</span><span id="1-1494">                <span class="bp">self</span><span class="o">.</span><span class="n">_warn_for_decl_attributes</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span id="1-1495">                <span class="k">if</span> <span class="ow">not</span> <span class="n">late_mapped</span><span class="p">:</span>
</span><span id="1-1496">                    <span class="nb">setattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span id="1-1497">                <span class="k">continue</span>
</span><span id="1-1498">            <span class="c1"># we expect to see the name &#39;metadata&#39; in some valid cases;</span>
</span><span id="1-1499">            <span class="c1"># however at this point we see it&#39;s assigned to something trying</span>
</span><span id="1-1500">            <span class="c1"># to be mapped, so raise for that.</span>
</span><span id="1-1501">            <span class="c1"># TODO: should &quot;registry&quot; here be also?   might be too late</span>
</span><span id="1-1502">            <span class="c1"># to change that now (2.0 betas)</span>
</span><span id="1-1503">            <span class="k">elif</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;metadata&quot;</span><span class="p">,):</span>
</span><span id="1-1504">                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span id="1-1505">                    <span class="sa">f</span><span class="s2">&quot;Attribute name &#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&#39; is reserved when using the &quot;</span>
</span><span id="1-1506">                    <span class="s2">&quot;Declarative API.&quot;</span>
</span><span id="1-1507">                <span class="p">)</span>
</span><span id="1-1508">            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Column</span><span class="p">):</span>
</span><span id="1-1509">                <span class="n">_undefer_column_name</span><span class="p">(</span>
</span><span id="1-1510">                    <span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_copies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>  <span class="c1"># type: ignore</span>
</span><span id="1-1511">                <span class="p">)</span>
</span><span id="1-1512">            <span class="k">else</span><span class="p">:</span>
</span><span id="1-1513">                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">_IntrospectsAnnotations</span><span class="p">):</span>
</span><span id="1-1514">                    <span class="p">(</span>
</span><span id="1-1515">                        <span class="n">annotation</span><span class="p">,</span>
</span><span id="1-1516">                        <span class="n">mapped_container</span><span class="p">,</span>
</span><span id="1-1517">                        <span class="n">extracted_mapped_annotation</span><span class="p">,</span>
</span><span id="1-1518">                        <span class="n">is_dataclass</span><span class="p">,</span>
</span><span id="1-1519">                        <span class="n">attr_value</span><span class="p">,</span>
</span><span id="1-1520">                        <span class="n">originating_module</span><span class="p">,</span>
</span><span id="1-1521">                        <span class="n">originating_class</span><span class="p">,</span>
</span><span id="1-1522">                    <span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">collected_annotations</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
</span><span id="1-1523">                        <span class="n">k</span><span class="p">,</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="1-1524">                    <span class="p">)</span>
</span><span id="1-1525">
</span><span id="1-1526">                    <span class="c1"># issue #8692 - don&#39;t do any annotation interpretation if</span>
</span><span id="1-1527">                    <span class="c1"># an annotation were present and a container such as</span>
</span><span id="1-1528">                    <span class="c1"># Mapped[] etc. were not used.  If annotation is None,</span>
</span><span id="1-1529">                    <span class="c1"># do declarative_scan so that the property can raise</span>
</span><span id="1-1530">                    <span class="c1"># for required</span>
</span><span id="1-1531">                    <span class="k">if</span> <span class="p">(</span>
</span><span id="1-1532">                        <span class="n">mapped_container</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="1-1533">                        <span class="ow">or</span> <span class="n">annotation</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="1-1534">                        <span class="c1"># issue #10516: need to do declarative_scan even with</span>
</span><span id="1-1535">                        <span class="c1"># a non-Mapped annotation if we are doing</span>
</span><span id="1-1536">                        <span class="c1"># __allow_unmapped__, for things like col.name</span>
</span><span id="1-1537">                        <span class="c1"># assignment</span>
</span><span id="1-1538">                        <span class="ow">or</span> <span class="n">allow_unmapped_annotations</span>
</span><span id="1-1539">                    <span class="p">):</span>
</span><span id="1-1540">                        <span class="k">try</span><span class="p">:</span>
</span><span id="1-1541">                            <span class="n">value</span><span class="o">.</span><span class="n">declarative_scan</span><span class="p">(</span>
</span><span id="1-1542">                                <span class="bp">self</span><span class="p">,</span>
</span><span id="1-1543">                                <span class="bp">self</span><span class="o">.</span><span class="n">registry</span><span class="p">,</span>
</span><span id="1-1544">                                <span class="bp">cls</span><span class="p">,</span>
</span><span id="1-1545">                                <span class="n">originating_module</span><span class="p">,</span>
</span><span id="1-1546">                                <span class="n">k</span><span class="p">,</span>
</span><span id="1-1547">                                <span class="n">mapped_container</span><span class="p">,</span>
</span><span id="1-1548">                                <span class="n">annotation</span><span class="p">,</span>
</span><span id="1-1549">                                <span class="n">extracted_mapped_annotation</span><span class="p">,</span>
</span><span id="1-1550">                                <span class="n">is_dataclass</span><span class="p">,</span>
</span><span id="1-1551">                            <span class="p">)</span>
</span><span id="1-1552">                        <span class="k">except</span> <span class="ne">NameError</span> <span class="k">as</span> <span class="n">ne</span><span class="p">:</span>
</span><span id="1-1553">                            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span id="1-1554">                                <span class="sa">f</span><span class="s2">&quot;Could not resolve all types within mapped &quot;</span>
</span><span id="1-1555">                                <span class="sa">f</span><span class="s1">&#39;annotation: &quot;</span><span class="si">{</span><span class="n">annotation</span><span class="si">}</span><span class="s1">&quot;.  Ensure all &#39;</span>
</span><span id="1-1556">                                <span class="sa">f</span><span class="s2">&quot;types are written correctly and are &quot;</span>
</span><span id="1-1557">                                <span class="sa">f</span><span class="s2">&quot;imported within the module in use.&quot;</span>
</span><span id="1-1558">                            <span class="p">)</span> <span class="kn">from</span> <span class="nn">ne</span>
</span><span id="1-1559">                    <span class="k">else</span><span class="p">:</span>
</span><span id="1-1560">                        <span class="c1"># assert that we were expecting annotations</span>
</span><span id="1-1561">                        <span class="c1"># without Mapped[] were going to be passed.</span>
</span><span id="1-1562">                        <span class="c1"># otherwise an error should have been raised</span>
</span><span id="1-1563">                        <span class="c1"># by util._extract_mapped_subtype before we got here.</span>
</span><span id="1-1564">                        <span class="k">assert</span> <span class="n">expect_annotations_wo_mapped</span>
</span><span id="1-1565">
</span><span id="1-1566">                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">_DCAttributeOptions</span><span class="p">):</span>
</span><span id="1-1567">                    <span class="k">if</span> <span class="p">(</span>
</span><span id="1-1568">                        <span class="n">value</span><span class="o">.</span><span class="n">_has_dataclass_arguments</span>
</span><span id="1-1569">                        <span class="ow">and</span> <span class="ow">not</span> <span class="n">look_for_dataclass_things</span>
</span><span id="1-1570">                    <span class="p">):</span>
</span><span id="1-1571">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">MapperProperty</span><span class="p">):</span>
</span><span id="1-1572">                            <span class="n">argnames</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="1-1573">                                <span class="s2">&quot;init&quot;</span><span class="p">,</span>
</span><span id="1-1574">                                <span class="s2">&quot;default_factory&quot;</span><span class="p">,</span>
</span><span id="1-1575">                                <span class="s2">&quot;repr&quot;</span><span class="p">,</span>
</span><span id="1-1576">                                <span class="s2">&quot;default&quot;</span><span class="p">,</span>
</span><span id="1-1577">                            <span class="p">]</span>
</span><span id="1-1578">                        <span class="k">else</span><span class="p">:</span>
</span><span id="1-1579">                            <span class="n">argnames</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;init&quot;</span><span class="p">,</span> <span class="s2">&quot;default_factory&quot;</span><span class="p">,</span> <span class="s2">&quot;repr&quot;</span><span class="p">]</span>
</span><span id="1-1580">
</span><span id="1-1581">                        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="1-1582">                            <span class="n">a</span>
</span><span id="1-1583">                            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">argnames</span>
</span><span id="1-1584">                            <span class="k">if</span> <span class="nb">getattr</span><span class="p">(</span>
</span><span id="1-1585">                                <span class="n">value</span><span class="o">.</span><span class="n">_attribute_options</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;dataclasses_</span><span class="si">{</span><span class="n">a</span><span class="si">}</span><span class="s2">&quot;</span>
</span><span id="1-1586">                            <span class="p">)</span>
</span><span id="1-1587">                            <span class="ow">is</span> <span class="ow">not</span> <span class="n">_NoArg</span><span class="o">.</span><span class="n">NO_ARG</span>
</span><span id="1-1588">                        <span class="p">}</span>
</span><span id="1-1589">
</span><span id="1-1590">                        <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span id="1-1591">                            <span class="sa">f</span><span class="s2">&quot;Attribute &#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&#39; on class </span><span class="si">{</span><span class="bp">cls</span><span class="si">}</span><span class="s2"> includes &quot;</span>
</span><span id="1-1592">                            <span class="sa">f</span><span class="s2">&quot;dataclasses argument(s): &quot;</span>
</span><span id="1-1593">                            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">args</span><span class="p">))</span><span class="si">}</span><span class="s2"> but &quot;</span>
</span><span id="1-1594">                            <span class="sa">f</span><span class="s2">&quot;class does not specify &quot;</span>
</span><span id="1-1595">                            <span class="s2">&quot;SQLAlchemy native dataclass configuration.&quot;</span>
</span><span id="1-1596">                        <span class="p">)</span>
</span><span id="1-1597">
</span><span id="1-1598">                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">MapperProperty</span><span class="p">,</span> <span class="n">_MapsColumns</span><span class="p">)):</span>
</span><span id="1-1599">                        <span class="c1"># filter for _DCAttributeOptions objects that aren&#39;t</span>
</span><span id="1-1600">                        <span class="c1"># MapperProperty / mapped_column().  Currently this</span>
</span><span id="1-1601">                        <span class="c1"># includes AssociationProxy.   pop it from the things</span>
</span><span id="1-1602">                        <span class="c1"># we&#39;re going to map and set it up as a descriptor</span>
</span><span id="1-1603">                        <span class="c1"># on the class.</span>
</span><span id="1-1604">                        <span class="n">collected_attributes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
</span><span id="1-1605">
</span><span id="1-1606">                        <span class="c1"># Assoc Prox (or other descriptor object that may</span>
</span><span id="1-1607">                        <span class="c1"># use _DCAttributeOptions) is usually here, except if</span>
</span><span id="1-1608">                        <span class="c1"># 1. we&#39;re a</span>
</span><span id="1-1609">                        <span class="c1"># dataclass, dataclasses would have removed the</span>
</span><span id="1-1610">                        <span class="c1"># attr here or 2. assoc proxy is coming from a</span>
</span><span id="1-1611">                        <span class="c1"># superclass, we want it to be direct here so it</span>
</span><span id="1-1612">                        <span class="c1"># tracks state or 3. assoc prox comes from</span>
</span><span id="1-1613">                        <span class="c1"># declared_attr, uncommon case</span>
</span><span id="1-1614">                        <span class="nb">setattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span id="1-1615">                        <span class="k">continue</span>
</span><span id="1-1616">
</span><span id="1-1617">            <span class="n">our_stuff</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
</span><span id="1-1618">
</span><span id="1-1619">    <span class="k">def</span> <span class="nf">_extract_declared_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1620">        <span class="n">our_stuff</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span>
</span><span id="1-1621">
</span><span id="1-1622">        <span class="c1"># extract columns from the class dict</span>
</span><span id="1-1623">        <span class="n">declared_columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">declared_columns</span>
</span><span id="1-1624">        <span class="n">column_ordering</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_ordering</span>
</span><span id="1-1625">        <span class="n">name_to_prop_key</span> <span class="o">=</span> <span class="n">collections</span><span class="o">.</span><span class="n">defaultdict</span><span class="p">(</span><span class="nb">set</span><span class="p">)</span>
</span><span id="1-1626">
</span><span id="1-1627">        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">our_stuff</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
</span><span id="1-1628">            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">_MapsColumns</span><span class="p">):</span>
</span><span id="1-1629">                <span class="n">mp_to_assign</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">mapper_property_to_assign</span>
</span><span id="1-1630">                <span class="k">if</span> <span class="n">mp_to_assign</span><span class="p">:</span>
</span><span id="1-1631">                    <span class="n">our_stuff</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">mp_to_assign</span>
</span><span id="1-1632">                <span class="k">else</span><span class="p">:</span>
</span><span id="1-1633">                    <span class="c1"># if no mapper property to assign, this currently means</span>
</span><span id="1-1634">                    <span class="c1"># this is a MappedColumn that will produce a Column for us</span>
</span><span id="1-1635">                    <span class="k">del</span> <span class="n">our_stuff</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span><span id="1-1636">
</span><span id="1-1637">                <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">sort_order</span> <span class="ow">in</span> <span class="n">c</span><span class="o">.</span><span class="n">columns_to_assign</span><span class="p">:</span>
</span><span id="1-1638">                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">CompositeProperty</span><span class="p">):</span>
</span><span id="1-1639">                        <span class="n">name_to_prop_key</span><span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span id="1-1640">                    <span class="n">declared_columns</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
</span><span id="1-1641">
</span><span id="1-1642">                    <span class="c1"># we would assert this, however we want the below</span>
</span><span id="1-1643">                    <span class="c1"># warning to take effect instead.  See #9630</span>
</span><span id="1-1644">                    <span class="c1"># assert col not in column_ordering</span>
</span><span id="1-1645">
</span><span id="1-1646">                    <span class="n">column_ordering</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">sort_order</span>
</span><span id="1-1647">
</span><span id="1-1648">                    <span class="c1"># if this is a MappedColumn and the attribute key we</span>
</span><span id="1-1649">                    <span class="c1"># have is not what the column has for its key, map the</span>
</span><span id="1-1650">                    <span class="c1"># Column explicitly under the attribute key name.</span>
</span><span id="1-1651">                    <span class="c1"># otherwise, Mapper will map it under the column key.</span>
</span><span id="1-1652">                    <span class="k">if</span> <span class="n">mp_to_assign</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">key</span> <span class="o">!=</span> <span class="n">col</span><span class="o">.</span><span class="n">key</span><span class="p">:</span>
</span><span id="1-1653">                        <span class="n">our_stuff</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">col</span>
</span><span id="1-1654">            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">Column</span><span class="p">):</span>
</span><span id="1-1655">                <span class="c1"># undefer previously occurred here, and now occurs earlier.</span>
</span><span id="1-1656">                <span class="c1"># ensure every column we get here has been named</span>
</span><span id="1-1657">                <span class="k">assert</span> <span class="n">c</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="1-1658">                <span class="n">name_to_prop_key</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
</span><span id="1-1659">                <span class="n">declared_columns</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span><span id="1-1660">                <span class="c1"># if the column is the same name as the key,</span>
</span><span id="1-1661">                <span class="c1"># remove it from the explicit properties dict.</span>
</span><span id="1-1662">                <span class="c1"># the normal rules for assigning column-based properties</span>
</span><span id="1-1663">                <span class="c1"># will take over, including precedence of columns</span>
</span><span id="1-1664">                <span class="c1"># in multi-column ColumnProperties.</span>
</span><span id="1-1665">                <span class="k">if</span> <span class="n">key</span> <span class="o">==</span> <span class="n">c</span><span class="o">.</span><span class="n">key</span><span class="p">:</span>
</span><span id="1-1666">                    <span class="k">del</span> <span class="n">our_stuff</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span><span id="1-1667">
</span><span id="1-1668">        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">keys</span> <span class="ow">in</span> <span class="n">name_to_prop_key</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
</span><span id="1-1669">            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="1-1670">                <span class="n">util</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
</span><span id="1-1671">                    <span class="s2">&quot;On class </span><span class="si">%r</span><span class="s2">, Column object </span><span class="si">%r</span><span class="s2"> named &quot;</span>
</span><span id="1-1672">                    <span class="s2">&quot;directly multiple times, &quot;</span>
</span><span id="1-1673">                    <span class="s2">&quot;only one will be used: </span><span class="si">%s</span><span class="s2">. &quot;</span>
</span><span id="1-1674">                    <span class="s2">&quot;Consider using orm.synonym instead&quot;</span>
</span><span id="1-1675">                    <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">classname</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">keys</span><span class="p">))))</span>
</span><span id="1-1676">                <span class="p">)</span>
</span><span id="1-1677">
</span><span id="1-1678">    <span class="k">def</span> <span class="nf">_setup_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">FromClause</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1679">        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span>
</span><span id="1-1680">        <span class="n">cls_as_Decl</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;MappedClassProtocol[Any]&quot;</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>
</span><span id="1-1681">
</span><span id="1-1682">        <span class="n">tablename</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">tablename</span>
</span><span id="1-1683">        <span class="n">table_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_args</span>
</span><span id="1-1684">        <span class="n">clsdict_view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clsdict_view</span>
</span><span id="1-1685">        <span class="n">declared_columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">declared_columns</span>
</span><span id="1-1686">        <span class="n">column_ordering</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_ordering</span>
</span><span id="1-1687">
</span><span id="1-1688">        <span class="n">manager</span> <span class="o">=</span> <span class="n">attributes</span><span class="o">.</span><span class="n">manager_of_class</span><span class="p">(</span><span class="bp">cls</span><span class="p">)</span>
</span><span id="1-1689">
</span><span id="1-1690">        <span class="k">if</span> <span class="s2">&quot;__table__&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">clsdict_view</span> <span class="ow">and</span> <span class="n">table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1691">            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;__table_cls__&quot;</span><span class="p">):</span>
</span><span id="1-1692">                <span class="n">table_cls</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span>
</span><span id="1-1693">                    <span class="n">Type</span><span class="p">[</span><span class="n">Table</span><span class="p">],</span>
</span><span id="1-1694">                    <span class="n">util</span><span class="o">.</span><span class="n">unbound_method_to_callable</span><span class="p">(</span><span class="bp">cls</span><span class="o">.</span><span class="n">__table_cls__</span><span class="p">),</span>  <span class="c1"># type: ignore  # noqa: E501</span>
</span><span id="1-1695">                <span class="p">)</span>
</span><span id="1-1696">            <span class="k">else</span><span class="p">:</span>
</span><span id="1-1697">                <span class="n">table_cls</span> <span class="o">=</span> <span class="n">Table</span>
</span><span id="1-1698">
</span><span id="1-1699">            <span class="k">if</span> <span class="n">tablename</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1700">                <span class="n">args</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="p">()</span>
</span><span id="1-1701">                <span class="n">table_kw</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="1-1702">
</span><span id="1-1703">                <span class="k">if</span> <span class="n">table_args</span><span class="p">:</span>
</span><span id="1-1704">                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">table_args</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="1-1705">                        <span class="n">table_kw</span> <span class="o">=</span> <span class="n">table_args</span>
</span><span id="1-1706">                    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">table_args</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span>
</span><span id="1-1707">                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">table_args</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
</span><span id="1-1708">                            <span class="n">args</span><span class="p">,</span> <span class="n">table_kw</span> <span class="o">=</span> <span class="n">table_args</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">table_args</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</span><span id="1-1709">                        <span class="k">else</span><span class="p">:</span>
</span><span id="1-1710">                            <span class="n">args</span> <span class="o">=</span> <span class="n">table_args</span>
</span><span id="1-1711">
</span><span id="1-1712">                <span class="n">autoload_with</span> <span class="o">=</span> <span class="n">clsdict_view</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;__autoload_with__&quot;</span><span class="p">)</span>
</span><span id="1-1713">                <span class="k">if</span> <span class="n">autoload_with</span><span class="p">:</span>
</span><span id="1-1714">                    <span class="n">table_kw</span><span class="p">[</span><span class="s2">&quot;autoload_with&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">autoload_with</span>
</span><span id="1-1715">
</span><span id="1-1716">                <span class="n">autoload</span> <span class="o">=</span> <span class="n">clsdict_view</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;__autoload__&quot;</span><span class="p">)</span>
</span><span id="1-1717">                <span class="k">if</span> <span class="n">autoload</span><span class="p">:</span>
</span><span id="1-1718">                    <span class="n">table_kw</span><span class="p">[</span><span class="s2">&quot;autoload&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="1-1719">
</span><span id="1-1720">                <span class="n">sorted_columns</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span>
</span><span id="1-1721">                    <span class="n">declared_columns</span><span class="p">,</span>
</span><span id="1-1722">                    <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">c</span><span class="p">:</span> <span class="n">column_ordering</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span>
</span><span id="1-1723">                <span class="p">)</span>
</span><span id="1-1724">                <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_cls_attribute</span><span class="p">(</span>
</span><span id="1-1725">                    <span class="s2">&quot;__table__&quot;</span><span class="p">,</span>
</span><span id="1-1726">                    <span class="n">table_cls</span><span class="p">(</span>
</span><span id="1-1727">                        <span class="n">tablename</span><span class="p">,</span>
</span><span id="1-1728">                        <span class="bp">self</span><span class="o">.</span><span class="n">_metadata_for_cls</span><span class="p">(</span><span class="n">manager</span><span class="p">),</span>
</span><span id="1-1729">                        <span class="o">*</span><span class="n">sorted_columns</span><span class="p">,</span>
</span><span id="1-1730">                        <span class="o">*</span><span class="n">args</span><span class="p">,</span>
</span><span id="1-1731">                        <span class="o">**</span><span class="n">table_kw</span><span class="p">,</span>
</span><span id="1-1732">                    <span class="p">),</span>
</span><span id="1-1733">                <span class="p">)</span>
</span><span id="1-1734">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-1735">            <span class="k">if</span> <span class="n">table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1736">                <span class="n">table</span> <span class="o">=</span> <span class="n">cls_as_Decl</span><span class="o">.</span><span class="n">__table__</span>
</span><span id="1-1737">            <span class="k">if</span> <span class="n">declared_columns</span><span class="p">:</span>
</span><span id="1-1738">                <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">declared_columns</span><span class="p">:</span>
</span><span id="1-1739">                    <span class="k">if</span> <span class="ow">not</span> <span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">contains_column</span><span class="p">(</span><span class="n">c</span><span class="p">):</span>
</span><span id="1-1740">                        <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span id="1-1741">                            <span class="s2">&quot;Can&#39;t add additional column </span><span class="si">%r</span><span class="s2"> when &quot;</span>
</span><span id="1-1742">                            <span class="s2">&quot;specifying __table__&quot;</span> <span class="o">%</span> <span class="n">c</span><span class="o">.</span><span class="n">key</span>
</span><span id="1-1743">                        <span class="p">)</span>
</span><span id="1-1744">
</span><span id="1-1745">        <span class="bp">self</span><span class="o">.</span><span class="n">local_table</span> <span class="o">=</span> <span class="n">table</span>
</span><span id="1-1746">
</span><span id="1-1747">    <span class="k">def</span> <span class="nf">_metadata_for_cls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">manager</span><span class="p">:</span> <span class="n">ClassManager</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">MetaData</span><span class="p">:</span>
</span><span id="1-1748">        <span class="n">meta</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">MetaData</span><span class="p">]</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="s2">&quot;metadata&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="1-1749">        <span class="k">if</span> <span class="n">meta</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1750">            <span class="k">return</span> <span class="n">meta</span>
</span><span id="1-1751">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-1752">            <span class="k">return</span> <span class="n">manager</span><span class="o">.</span><span class="n">registry</span><span class="o">.</span><span class="n">metadata</span>
</span><span id="1-1753">
</span><span id="1-1754">    <span class="k">def</span> <span class="nf">_setup_inheriting_mapper</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapper_kw</span><span class="p">:</span> <span class="n">_MapperKwArgs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1755">        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span>
</span><span id="1-1756">
</span><span id="1-1757">        <span class="n">inherits</span> <span class="o">=</span> <span class="n">mapper_kw</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;inherits&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="1-1758">
</span><span id="1-1759">        <span class="k">if</span> <span class="n">inherits</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1760">            <span class="c1"># since we search for classical mappings now, search for</span>
</span><span id="1-1761">            <span class="c1"># multiple mapped bases as well and raise an error.</span>
</span><span id="1-1762">            <span class="n">inherits_search</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="1-1763">            <span class="k">for</span> <span class="n">base_</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__bases__</span><span class="p">:</span>
</span><span id="1-1764">                <span class="n">c</span> <span class="o">=</span> <span class="n">_resolve_for_abstract_or_classical</span><span class="p">(</span><span class="n">base_</span><span class="p">)</span>
</span><span id="1-1765">                <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1766">                    <span class="k">continue</span>
</span><span id="1-1767">
</span><span id="1-1768">                <span class="k">if</span> <span class="n">_is_supercls_for_inherits</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="ow">and</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">inherits_search</span><span class="p">:</span>
</span><span id="1-1769">                    <span class="n">inherits_search</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
</span><span id="1-1770">
</span><span id="1-1771">            <span class="k">if</span> <span class="n">inherits_search</span><span class="p">:</span>
</span><span id="1-1772">                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">inherits_search</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
</span><span id="1-1773">                    <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span id="1-1774">                        <span class="s2">&quot;Class </span><span class="si">%s</span><span class="s2"> has multiple mapped bases: </span><span class="si">%r</span><span class="s2">&quot;</span>
</span><span id="1-1775">                        <span class="o">%</span> <span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">inherits_search</span><span class="p">)</span>
</span><span id="1-1776">                    <span class="p">)</span>
</span><span id="1-1777">                <span class="n">inherits</span> <span class="o">=</span> <span class="n">inherits_search</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</span><span id="1-1778">        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inherits</span><span class="p">,</span> <span class="n">Mapper</span><span class="p">):</span>
</span><span id="1-1779">            <span class="n">inherits</span> <span class="o">=</span> <span class="n">inherits</span><span class="o">.</span><span class="n">class_</span>
</span><span id="1-1780">
</span><span id="1-1781">        <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span> <span class="o">=</span> <span class="n">inherits</span>
</span><span id="1-1782">
</span><span id="1-1783">        <span class="n">clsdict_view</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">clsdict_view</span>
</span><span id="1-1784">        <span class="k">if</span> <span class="s2">&quot;__table__&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">clsdict_view</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">tablename</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1785">            <span class="bp">self</span><span class="o">.</span><span class="n">single</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="1-1786">
</span><span id="1-1787">    <span class="k">def</span> <span class="nf">_setup_inheriting_columns</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapper_kw</span><span class="p">:</span> <span class="n">_MapperKwArgs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1788">        <span class="n">table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_table</span>
</span><span id="1-1789">        <span class="bp">cls</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cls</span>
</span><span id="1-1790">        <span class="n">table_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_args</span>
</span><span id="1-1791">        <span class="n">declared_columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">declared_columns</span>
</span><span id="1-1792">
</span><span id="1-1793">        <span class="k">if</span> <span class="p">(</span>
</span><span id="1-1794">            <span class="n">table</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="1-1795">            <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span> <span class="ow">is</span> <span class="kc">None</span>
</span><span id="1-1796">            <span class="ow">and</span> <span class="ow">not</span> <span class="n">_get_immediate_cls_attr</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="s2">&quot;__no_table__&quot;</span><span class="p">)</span>
</span><span id="1-1797">        <span class="p">):</span>
</span><span id="1-1798">            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span id="1-1799">                <span class="s2">&quot;Class </span><span class="si">%r</span><span class="s2"> does not have a __table__ or __tablename__ &quot;</span>
</span><span id="1-1800">                <span class="s2">&quot;specified and does not inherit from an existing &quot;</span>
</span><span id="1-1801">                <span class="s2">&quot;table-mapped class.&quot;</span> <span class="o">%</span> <span class="bp">cls</span>
</span><span id="1-1802">            <span class="p">)</span>
</span><span id="1-1803">        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="p">:</span>
</span><span id="1-1804">            <span class="n">inherited_mapper_or_config</span> <span class="o">=</span> <span class="n">_declared_mapping_info</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="p">)</span>
</span><span id="1-1805">            <span class="k">assert</span> <span class="n">inherited_mapper_or_config</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="1-1806">            <span class="n">inherited_table</span> <span class="o">=</span> <span class="n">inherited_mapper_or_config</span><span class="o">.</span><span class="n">local_table</span>
</span><span id="1-1807">            <span class="n">inherited_persist_selectable</span> <span class="o">=</span> <span class="p">(</span>
</span><span id="1-1808">                <span class="n">inherited_mapper_or_config</span><span class="o">.</span><span class="n">persist_selectable</span>
</span><span id="1-1809">            <span class="p">)</span>
</span><span id="1-1810">
</span><span id="1-1811">            <span class="k">if</span> <span class="n">table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1812">                <span class="c1"># single table inheritance.</span>
</span><span id="1-1813">                <span class="c1"># ensure no table args</span>
</span><span id="1-1814">                <span class="k">if</span> <span class="n">table_args</span><span class="p">:</span>
</span><span id="1-1815">                    <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span id="1-1816">                        <span class="s2">&quot;Can&#39;t place __table_args__ on an inherited class &quot;</span>
</span><span id="1-1817">                        <span class="s2">&quot;with no table.&quot;</span>
</span><span id="1-1818">                    <span class="p">)</span>
</span><span id="1-1819">
</span><span id="1-1820">                <span class="c1"># add any columns declared here to the inherited table.</span>
</span><span id="1-1821">                <span class="k">if</span> <span class="n">declared_columns</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inherited_table</span><span class="p">,</span> <span class="n">Table</span><span class="p">):</span>
</span><span id="1-1822">                    <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span id="1-1823">                        <span class="sa">f</span><span class="s2">&quot;Can&#39;t declare columns on single-table-inherited &quot;</span>
</span><span id="1-1824">                        <span class="sa">f</span><span class="s2">&quot;subclass </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="si">}</span><span class="s2">; superclass </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span id="1-1825">                        <span class="s2">&quot;is not mapped to a Table&quot;</span>
</span><span id="1-1826">                    <span class="p">)</span>
</span><span id="1-1827">
</span><span id="1-1828">                <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">declared_columns</span><span class="p">:</span>
</span><span id="1-1829">                    <span class="k">assert</span> <span class="n">inherited_table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="1-1830">                    <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">inherited_table</span><span class="o">.</span><span class="n">c</span><span class="p">:</span>
</span><span id="1-1831">                        <span class="k">if</span> <span class="n">inherited_table</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="ow">is</span> <span class="n">col</span><span class="p">:</span>
</span><span id="1-1832">                            <span class="k">continue</span>
</span><span id="1-1833">                        <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span id="1-1834">                            <span class="sa">f</span><span class="s2">&quot;Column &#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&#39; on class </span><span class="si">{</span><span class="bp">cls</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2"> &quot;</span>
</span><span id="1-1835">                            <span class="sa">f</span><span class="s2">&quot;conflicts with existing column &quot;</span>
</span><span id="1-1836">                            <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">inherited_table</span><span class="o">.</span><span class="n">c</span><span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;.  If using &quot;</span>
</span><span id="1-1837">                            <span class="sa">f</span><span class="s2">&quot;Declarative, consider using the &quot;</span>
</span><span id="1-1838">                            <span class="s2">&quot;use_existing_column parameter of mapped_column() &quot;</span>
</span><span id="1-1839">                            <span class="s2">&quot;to resolve conflicts.&quot;</span>
</span><span id="1-1840">                        <span class="p">)</span>
</span><span id="1-1841">                    <span class="k">if</span> <span class="n">col</span><span class="o">.</span><span class="n">primary_key</span><span class="p">:</span>
</span><span id="1-1842">                        <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">ArgumentError</span><span class="p">(</span>
</span><span id="1-1843">                            <span class="s2">&quot;Can&#39;t place primary key columns on an inherited &quot;</span>
</span><span id="1-1844">                            <span class="s2">&quot;class with no table.&quot;</span>
</span><span id="1-1845">                        <span class="p">)</span>
</span><span id="1-1846">
</span><span id="1-1847">                    <span class="k">if</span> <span class="n">TYPE_CHECKING</span><span class="p">:</span>
</span><span id="1-1848">                        <span class="k">assert</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inherited_table</span><span class="p">,</span> <span class="n">Table</span><span class="p">)</span>
</span><span id="1-1849">
</span><span id="1-1850">                    <span class="n">inherited_table</span><span class="o">.</span><span class="n">append_column</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
</span><span id="1-1851">                    <span class="k">if</span> <span class="p">(</span>
</span><span id="1-1852">                        <span class="n">inherited_persist_selectable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
</span><span id="1-1853">                        <span class="ow">and</span> <span class="n">inherited_persist_selectable</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">inherited_table</span>
</span><span id="1-1854">                    <span class="p">):</span>
</span><span id="1-1855">                        <span class="n">inherited_persist_selectable</span><span class="o">.</span><span class="n">_refresh_for_new_column</span><span class="p">(</span>
</span><span id="1-1856">                            <span class="n">col</span>
</span><span id="1-1857">                        <span class="p">)</span>
</span><span id="1-1858">
</span><span id="1-1859">    <span class="k">def</span> <span class="nf">_prepare_mapper_arguments</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapper_kw</span><span class="p">:</span> <span class="n">_MapperKwArgs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1860">        <span class="n">properties</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">properties</span>
</span><span id="1-1861">
</span><span id="1-1862">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapper_args_fn</span><span class="p">:</span>
</span><span id="1-1863">            <span class="n">mapper_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mapper_args_fn</span><span class="p">()</span>
</span><span id="1-1864">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-1865">            <span class="n">mapper_args</span> <span class="o">=</span> <span class="p">{}</span>
</span><span id="1-1866">
</span><span id="1-1867">        <span class="k">if</span> <span class="n">mapper_kw</span><span class="p">:</span>
</span><span id="1-1868">            <span class="n">mapper_args</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">mapper_kw</span><span class="p">)</span>
</span><span id="1-1869">
</span><span id="1-1870">        <span class="k">if</span> <span class="s2">&quot;properties&quot;</span> <span class="ow">in</span> <span class="n">mapper_args</span><span class="p">:</span>
</span><span id="1-1871">            <span class="n">properties</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">properties</span><span class="p">)</span>
</span><span id="1-1872">            <span class="n">properties</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">mapper_args</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">])</span>
</span><span id="1-1873">
</span><span id="1-1874">        <span class="c1"># make sure that column copies are used rather</span>
</span><span id="1-1875">        <span class="c1"># than the original columns from any mixins</span>
</span><span id="1-1876">        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;version_id_col&quot;</span><span class="p">,</span> <span class="s2">&quot;polymorphic_on&quot;</span><span class="p">):</span>
</span><span id="1-1877">            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">mapper_args</span><span class="p">:</span>
</span><span id="1-1878">                <span class="n">v</span> <span class="o">=</span> <span class="n">mapper_args</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
</span><span id="1-1879">                <span class="n">mapper_args</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">column_copies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
</span><span id="1-1880">
</span><span id="1-1881">        <span class="k">if</span> <span class="s2">&quot;primary_key&quot;</span> <span class="ow">in</span> <span class="n">mapper_args</span><span class="p">:</span>
</span><span id="1-1882">            <span class="n">mapper_args</span><span class="p">[</span><span class="s2">&quot;primary_key&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="1-1883">                <span class="bp">self</span><span class="o">.</span><span class="n">column_copies</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
</span><span id="1-1884">                <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">util</span><span class="o">.</span><span class="n">to_list</span><span class="p">(</span><span class="n">mapper_args</span><span class="p">[</span><span class="s2">&quot;primary_key&quot;</span><span class="p">])</span>
</span><span id="1-1885">            <span class="p">]</span>
</span><span id="1-1886">
</span><span id="1-1887">        <span class="k">if</span> <span class="s2">&quot;inherits&quot;</span> <span class="ow">in</span> <span class="n">mapper_args</span><span class="p">:</span>
</span><span id="1-1888">            <span class="n">inherits_arg</span> <span class="o">=</span> <span class="n">mapper_args</span><span class="p">[</span><span class="s2">&quot;inherits&quot;</span><span class="p">]</span>
</span><span id="1-1889">            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">inherits_arg</span><span class="p">,</span> <span class="n">Mapper</span><span class="p">):</span>
</span><span id="1-1890">                <span class="n">inherits_arg</span> <span class="o">=</span> <span class="n">inherits_arg</span><span class="o">.</span><span class="n">class_</span>
</span><span id="1-1891">
</span><span id="1-1892">            <span class="k">if</span> <span class="n">inherits_arg</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="p">:</span>
</span><span id="1-1893">                <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span id="1-1894">                    <span class="s2">&quot;mapper inherits argument given for non-inheriting &quot;</span>
</span><span id="1-1895">                    <span class="s2">&quot;class </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">mapper_args</span><span class="p">[</span><span class="s2">&quot;inherits&quot;</span><span class="p">])</span>
</span><span id="1-1896">                <span class="p">)</span>
</span><span id="1-1897">
</span><span id="1-1898">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="p">:</span>
</span><span id="1-1899">            <span class="n">mapper_args</span><span class="p">[</span><span class="s2">&quot;inherits&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span>
</span><span id="1-1900">
</span><span id="1-1901">        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">inherits</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">mapper_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;concrete&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
</span><span id="1-1902">            <span class="c1"># note the superclass is expected to have a Mapper assigned and</span>
</span><span id="1-1903">            <span class="c1"># not be a deferred config, as this is called within map()</span>
</span><span id="1-1904">            <span class="n">inherited_mapper</span> <span class="o">=</span> <span class="n">class_mapper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inherits</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
</span><span id="1-1905">            <span class="n">inherited_table</span> <span class="o">=</span> <span class="n">inherited_mapper</span><span class="o">.</span><span class="n">local_table</span>
</span><span id="1-1906">
</span><span id="1-1907">            <span class="c1"># single or joined inheritance</span>
</span><span id="1-1908">            <span class="c1"># exclude any cols on the inherited table which are</span>
</span><span id="1-1909">            <span class="c1"># not mapped on the parent class, to avoid</span>
</span><span id="1-1910">            <span class="c1"># mapping columns specific to sibling/nephew classes</span>
</span><span id="1-1911">            <span class="k">if</span> <span class="s2">&quot;exclude_properties&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">mapper_args</span><span class="p">:</span>
</span><span id="1-1912">                <span class="n">mapper_args</span><span class="p">[</span><span class="s2">&quot;exclude_properties&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exclude_properties</span> <span class="o">=</span> <span class="p">{</span>
</span><span id="1-1913">                    <span class="n">c</span><span class="o">.</span><span class="n">key</span>
</span><span id="1-1914">                    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">inherited_table</span><span class="o">.</span><span class="n">c</span>
</span><span id="1-1915">                    <span class="k">if</span> <span class="n">c</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">inherited_mapper</span><span class="o">.</span><span class="n">_columntoproperty</span>
</span><span id="1-1916">                <span class="p">}</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">inherited_mapper</span><span class="o">.</span><span class="n">exclude_properties</span> <span class="ow">or</span> <span class="p">())</span>
</span><span id="1-1917">                <span class="n">exclude_properties</span><span class="o">.</span><span class="n">difference_update</span><span class="p">(</span>
</span><span id="1-1918">                    <span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">key</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">declared_columns</span><span class="p">]</span>
</span><span id="1-1919">                <span class="p">)</span>
</span><span id="1-1920">
</span><span id="1-1921">            <span class="c1"># look through columns in the current mapper that</span>
</span><span id="1-1922">            <span class="c1"># are keyed to a propname different than the colname</span>
</span><span id="1-1923">            <span class="c1"># (if names were the same, we&#39;d have popped it out above,</span>
</span><span id="1-1924">            <span class="c1"># in which case the mapper makes this combination).</span>
</span><span id="1-1925">            <span class="c1"># See if the superclass has a similar column property.</span>
</span><span id="1-1926">            <span class="c1"># If so, join them together.</span>
</span><span id="1-1927">            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">col</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">properties</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
</span><span id="1-1928">                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">expression</span><span class="o">.</span><span class="n">ColumnElement</span><span class="p">):</span>
</span><span id="1-1929">                    <span class="k">continue</span>
</span><span id="1-1930">                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">inherited_mapper</span><span class="o">.</span><span class="n">_props</span><span class="p">:</span>
</span><span id="1-1931">                    <span class="n">p</span> <span class="o">=</span> <span class="n">inherited_mapper</span><span class="o">.</span><span class="n">_props</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
</span><span id="1-1932">                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ColumnProperty</span><span class="p">):</span>
</span><span id="1-1933">                        <span class="c1"># note here we place the subclass column</span>
</span><span id="1-1934">                        <span class="c1"># first.  See [ticket:1892] for background.</span>
</span><span id="1-1935">                        <span class="n">properties</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">+</span> <span class="n">p</span><span class="o">.</span><span class="n">columns</span>
</span><span id="1-1936">        <span class="n">result_mapper_args</span> <span class="o">=</span> <span class="n">mapper_args</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
</span><span id="1-1937">        <span class="n">result_mapper_args</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">properties</span>
</span><span id="1-1938">        <span class="bp">self</span><span class="o">.</span><span class="n">mapper_args</span> <span class="o">=</span> <span class="n">result_mapper_args</span>
</span><span id="1-1939">
</span><span id="1-1940">    <span class="k">def</span> <span class="nf">map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapper_kw</span><span class="p">:</span> <span class="n">_MapperKwArgs</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span id="1-1941">        <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_mapper_arguments</span><span class="p">(</span><span class="n">mapper_kw</span><span class="p">)</span>
</span><span id="1-1942">        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="s2">&quot;__mapper_cls__&quot;</span><span class="p">):</span>
</span><span id="1-1943">            <span class="n">mapper_cls</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span>
</span><span id="1-1944">                <span class="s2">&quot;Type[Mapper[Any]]&quot;</span><span class="p">,</span>
</span><span id="1-1945">                <span class="n">util</span><span class="o">.</span><span class="n">unbound_method_to_callable</span><span class="p">(</span>
</span><span id="1-1946">                    <span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="o">.</span><span class="n">__mapper_cls__</span>  <span class="c1"># type: ignore</span>
</span><span id="1-1947">                <span class="p">),</span>
</span><span id="1-1948">            <span class="p">)</span>
</span><span id="1-1949">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-1950">            <span class="n">mapper_cls</span> <span class="o">=</span> <span class="n">Mapper</span>
</span><span id="1-1951">
</span><span id="1-1952">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">set_cls_attribute</span><span class="p">(</span>
</span><span id="1-1953">            <span class="s2">&quot;__mapper__&quot;</span><span class="p">,</span>
</span><span id="1-1954">            <span class="n">mapper_cls</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cls</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_table</span><span class="p">,</span> <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">mapper_args</span><span class="p">),</span>
</span><span id="1-1955">        <span class="p">)</span>
</span><span id="1-1956">
</span><span id="1-1957">
</span><span id="1-1958"><span class="nd">@util</span><span class="o">.</span><span class="n">preload_module</span><span class="p">(</span><span class="s2">&quot;sqlalchemy.orm.decl_api&quot;</span><span class="p">)</span>
</span><span id="1-1959"><span class="k">def</span> <span class="nf">_as_dc_declaredattr</span><span class="p">(</span>
</span><span id="1-1960">    <span class="n">field_metadata</span><span class="p">:</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">sa_dataclass_metadata_key</span><span class="p">:</span> <span class="nb">str</span>
</span><span id="1-1961"><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
</span><span id="1-1962">    <span class="c1"># wrap lambdas inside dataclass fields inside an ad-hoc declared_attr.</span>
</span><span id="1-1963">    <span class="c1"># we can&#39;t write it because field.metadata is immutable :( so we have</span>
</span><span id="1-1964">    <span class="c1"># to go through extra trouble to compare these</span>
</span><span id="1-1965">    <span class="n">decl_api</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">preloaded</span><span class="o">.</span><span class="n">orm_decl_api</span>
</span><span id="1-1966">    <span class="n">obj</span> <span class="o">=</span> <span class="n">field_metadata</span><span class="p">[</span><span class="n">sa_dataclass_metadata_key</span><span class="p">]</span>
</span><span id="1-1967">    <span class="k">if</span> <span class="nb">callable</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">decl_api</span><span class="o">.</span><span class="n">declared_attr</span><span class="p">):</span>
</span><span id="1-1968">        <span class="k">return</span> <span class="n">decl_api</span><span class="o">.</span><span class="n">declared_attr</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
</span><span id="1-1969">    <span class="k">else</span><span class="p">:</span>
</span><span id="1-1970">        <span class="k">return</span> <span class="n">obj</span>
</span><span id="1-1971">
</span><span id="1-1972">
</span><span id="1-1973"><span class="k">class</span> <span class="nc">_DeferredMapperConfig</span><span class="p">(</span><span class="n">_ClassScanMapperConfig</span><span class="p">):</span>
</span><span id="1-1974">    <span class="n">_cls</span><span class="p">:</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]]</span>
</span><span id="1-1975">
</span><span id="1-1976">    <span class="n">is_deferred</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="1-1977">
</span><span id="1-1978">    <span class="n">_configs</span><span class="p">:</span> <span class="n">util</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">[</span>
</span><span id="1-1979">        <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]],</span> <span class="n">_DeferredMapperConfig</span>
</span><span id="1-1980">    <span class="p">]</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">OrderedDict</span><span class="p">()</span>
</span><span id="1-1981">
</span><span id="1-1982">    <span class="k">def</span> <span class="nf">_early_mapping</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapper_kw</span><span class="p">:</span> <span class="n">_MapperKwArgs</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1983">        <span class="k">pass</span>
</span><span id="1-1984">
</span><span id="1-1985">    <span class="c1"># mypy disallows plain property override of variable</span>
</span><span id="1-1986">    <span class="nd">@property</span>  <span class="c1"># type: ignore</span>
</span><span id="1-1987">    <span class="k">def</span> <span class="nf">cls</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span id="1-1988">        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_cls</span><span class="p">()</span>  <span class="c1"># type: ignore</span>
</span><span id="1-1989">
</span><span id="1-1990">    <span class="nd">@cls</span><span class="o">.</span><span class="n">setter</span>
</span><span id="1-1991">    <span class="k">def</span> <span class="nf">cls</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">class_</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1992">        <span class="bp">self</span><span class="o">.</span><span class="n">_cls</span> <span class="o">=</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">class_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_remove_config_cls</span><span class="p">)</span>
</span><span id="1-1993">        <span class="bp">self</span><span class="o">.</span><span class="n">_configs</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_cls</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span>
</span><span id="1-1994">
</span><span id="1-1995">    <span class="nd">@classmethod</span>
</span><span id="1-1996">    <span class="k">def</span> <span class="nf">_remove_config_cls</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">ref</span><span class="p">:</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">[</span><span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-1997">        <span class="bp">cls</span><span class="o">.</span><span class="n">_configs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">ref</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="1-1998">
</span><span id="1-1999">    <span class="nd">@classmethod</span>
</span><span id="1-2000">    <span class="k">def</span> <span class="nf">has_cls</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">class_</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
</span><span id="1-2001">        <span class="c1"># 2.6 fails on weakref if class_ is an old style class</span>
</span><span id="1-2002">        <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">class_</span><span class="p">,</span> <span class="nb">type</span><span class="p">)</span> <span class="ow">and</span> <span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">class_</span><span class="p">)</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_configs</span>
</span><span id="1-2003">
</span><span id="1-2004">    <span class="nd">@classmethod</span>
</span><span id="1-2005">    <span class="k">def</span> <span class="nf">raise_unmapped_for_cls</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">class_</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">NoReturn</span><span class="p">:</span>
</span><span id="1-2006">        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">class_</span><span class="p">,</span> <span class="s2">&quot;_sa_raise_deferred_config&quot;</span><span class="p">):</span>
</span><span id="1-2007">            <span class="n">class_</span><span class="o">.</span><span class="n">_sa_raise_deferred_config</span><span class="p">()</span>
</span><span id="1-2008">
</span><span id="1-2009">        <span class="k">raise</span> <span class="n">orm_exc</span><span class="o">.</span><span class="n">UnmappedClassError</span><span class="p">(</span>
</span><span id="1-2010">            <span class="n">class_</span><span class="p">,</span>
</span><span id="1-2011">            <span class="n">msg</span><span class="o">=</span><span class="p">(</span>
</span><span id="1-2012">                <span class="sa">f</span><span class="s2">&quot;Class </span><span class="si">{</span><span class="n">orm_exc</span><span class="o">.</span><span class="n">_safe_cls_name</span><span class="p">(</span><span class="n">class_</span><span class="p">)</span><span class="si">}</span><span class="s2"> has a deferred &quot;</span>
</span><span id="1-2013">                <span class="s2">&quot;mapping on it.  It is not yet usable as a mapped class.&quot;</span>
</span><span id="1-2014">            <span class="p">),</span>
</span><span id="1-2015">        <span class="p">)</span>
</span><span id="1-2016">
</span><span id="1-2017">    <span class="nd">@classmethod</span>
</span><span id="1-2018">    <span class="k">def</span> <span class="nf">config_for_cls</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">class_</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">_DeferredMapperConfig</span><span class="p">:</span>
</span><span id="1-2019">        <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_configs</span><span class="p">[</span><span class="n">weakref</span><span class="o">.</span><span class="n">ref</span><span class="p">(</span><span class="n">class_</span><span class="p">)]</span>
</span><span id="1-2020">
</span><span id="1-2021">    <span class="nd">@classmethod</span>
</span><span id="1-2022">    <span class="k">def</span> <span class="nf">classes_for_base</span><span class="p">(</span>
</span><span id="1-2023">        <span class="bp">cls</span><span class="p">,</span> <span class="n">base_cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">sort</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
</span><span id="1-2024">    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">_DeferredMapperConfig</span><span class="p">]:</span>
</span><span id="1-2025">        <span class="n">classes_for_base</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="1-2026">            <span class="n">m</span>
</span><span id="1-2027">            <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">cls_</span> <span class="ow">in</span> <span class="p">[(</span><span class="n">m</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">cls</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_configs</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
</span><span id="1-2028">            <span class="k">if</span> <span class="n">cls_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="nb">issubclass</span><span class="p">(</span><span class="n">cls_</span><span class="p">,</span> <span class="n">base_cls</span><span class="p">)</span>
</span><span id="1-2029">        <span class="p">]</span>
</span><span id="1-2030">
</span><span id="1-2031">        <span class="k">if</span> <span class="ow">not</span> <span class="n">sort</span><span class="p">:</span>
</span><span id="1-2032">            <span class="k">return</span> <span class="n">classes_for_base</span>
</span><span id="1-2033">
</span><span id="1-2034">        <span class="n">all_m_by_cls</span> <span class="o">=</span> <span class="p">{</span><span class="n">m</span><span class="o">.</span><span class="n">cls</span><span class="p">:</span> <span class="n">m</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="n">classes_for_base</span><span class="p">}</span>
</span><span id="1-2035">
</span><span id="1-2036">        <span class="n">tuples</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">_DeferredMapperConfig</span><span class="p">,</span> <span class="n">_DeferredMapperConfig</span><span class="p">]]</span> <span class="o">=</span> <span class="p">[]</span>
</span><span id="1-2037">        <span class="k">for</span> <span class="n">m_cls</span> <span class="ow">in</span> <span class="n">all_m_by_cls</span><span class="p">:</span>
</span><span id="1-2038">            <span class="n">tuples</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
</span><span id="1-2039">                <span class="p">(</span><span class="n">all_m_by_cls</span><span class="p">[</span><span class="n">base_cls</span><span class="p">],</span> <span class="n">all_m_by_cls</span><span class="p">[</span><span class="n">m_cls</span><span class="p">])</span>
</span><span id="1-2040">                <span class="k">for</span> <span class="n">base_cls</span> <span class="ow">in</span> <span class="n">m_cls</span><span class="o">.</span><span class="vm">__bases__</span>
</span><span id="1-2041">                <span class="k">if</span> <span class="n">base_cls</span> <span class="ow">in</span> <span class="n">all_m_by_cls</span>
</span><span id="1-2042">            <span class="p">)</span>
</span><span id="1-2043">        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="n">topological</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">tuples</span><span class="p">,</span> <span class="n">classes_for_base</span><span class="p">))</span>
</span><span id="1-2044">
</span><span id="1-2045">    <span class="k">def</span> <span class="nf">map</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mapper_kw</span><span class="p">:</span> <span class="n">_MapperKwArgs</span> <span class="o">=</span> <span class="n">util</span><span class="o">.</span><span class="n">EMPTY_DICT</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapper</span><span class="p">[</span><span class="n">Any</span><span class="p">]:</span>
</span><span id="1-2046">        <span class="bp">self</span><span class="o">.</span><span class="n">_configs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_cls</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
</span><span id="1-2047">        <span class="k">return</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="n">mapper_kw</span><span class="p">)</span>
</span><span id="1-2048">
</span><span id="1-2049">
</span><span id="1-2050"><span class="k">def</span> <span class="nf">_add_attribute</span><span class="p">(</span>
</span><span id="1-2051">    <span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">MapperProperty</span><span class="p">[</span><span class="n">Any</span><span class="p">]</span>
</span><span id="1-2052"><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-2053"><span class="w">    </span><span class="sd">&quot;&quot;&quot;add an attribute to an existing declarative class.</span>
</span><span id="1-2054">
</span><span id="1-2055"><span class="sd">    This runs through the logic to determine MapperProperty,</span>
</span><span id="1-2056"><span class="sd">    adds it to the Mapper, adds a column to the mapped Table, etc.</span>
</span><span id="1-2057">
</span><span id="1-2058"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-2059">
</span><span id="1-2060">    <span class="k">if</span> <span class="s2">&quot;__mapper__&quot;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">:</span>
</span><span id="1-2061">        <span class="n">mapped_cls</span> <span class="o">=</span> <span class="n">cast</span><span class="p">(</span><span class="s2">&quot;MappedClassProtocol[Any]&quot;</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span>
</span><span id="1-2062">
</span><span id="1-2063">        <span class="k">def</span> <span class="nf">_table_or_raise</span><span class="p">(</span><span class="n">mc</span><span class="p">:</span> <span class="n">MappedClassProtocol</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Table</span><span class="p">:</span>
</span><span id="1-2064">            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">mc</span><span class="o">.</span><span class="n">__table__</span><span class="p">,</span> <span class="n">Table</span><span class="p">):</span>
</span><span id="1-2065">                <span class="k">return</span> <span class="n">mc</span><span class="o">.</span><span class="n">__table__</span>
</span><span id="1-2066">            <span class="k">raise</span> <span class="n">exc</span><span class="o">.</span><span class="n">InvalidRequestError</span><span class="p">(</span>
</span><span id="1-2067">                <span class="sa">f</span><span class="s2">&quot;Cannot add a new attribute to mapped class </span><span class="si">{</span><span class="n">mc</span><span class="o">.</span><span class="vm">__name__</span><span class="si">!r}</span><span class="s2"> &quot;</span>
</span><span id="1-2068">                <span class="s2">&quot;because it&#39;s not mapped against a table.&quot;</span>
</span><span id="1-2069">            <span class="p">)</span>
</span><span id="1-2070">
</span><span id="1-2071">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">Column</span><span class="p">):</span>
</span><span id="1-2072">            <span class="n">_undefer_column_name</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span id="1-2073">            <span class="n">_table_or_raise</span><span class="p">(</span><span class="n">mapped_cls</span><span class="p">)</span><span class="o">.</span><span class="n">append_column</span><span class="p">(</span>
</span><span id="1-2074">                <span class="n">value</span><span class="p">,</span> <span class="n">replace_existing</span><span class="o">=</span><span class="kc">True</span>
</span><span id="1-2075">            <span class="p">)</span>
</span><span id="1-2076">            <span class="n">mapped_cls</span><span class="o">.</span><span class="n">__mapper__</span><span class="o">.</span><span class="n">add_property</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span id="1-2077">        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">_MapsColumns</span><span class="p">):</span>
</span><span id="1-2078">            <span class="n">mp</span> <span class="o">=</span> <span class="n">value</span><span class="o">.</span><span class="n">mapper_property_to_assign</span>
</span><span id="1-2079">            <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">columns_to_assign</span><span class="p">:</span>
</span><span id="1-2080">                <span class="n">_undefer_column_name</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>
</span><span id="1-2081">                <span class="n">_table_or_raise</span><span class="p">(</span><span class="n">mapped_cls</span><span class="p">)</span><span class="o">.</span><span class="n">append_column</span><span class="p">(</span>
</span><span id="1-2082">                    <span class="n">col</span><span class="p">,</span> <span class="n">replace_existing</span><span class="o">=</span><span class="kc">True</span>
</span><span id="1-2083">                <span class="p">)</span>
</span><span id="1-2084">                <span class="k">if</span> <span class="ow">not</span> <span class="n">mp</span><span class="p">:</span>
</span><span id="1-2085">                    <span class="n">mapped_cls</span><span class="o">.</span><span class="n">__mapper__</span><span class="o">.</span><span class="n">add_property</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>
</span><span id="1-2086">            <span class="k">if</span> <span class="n">mp</span><span class="p">:</span>
</span><span id="1-2087">                <span class="n">mapped_cls</span><span class="o">.</span><span class="n">__mapper__</span><span class="o">.</span><span class="n">add_property</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">mp</span><span class="p">)</span>
</span><span id="1-2088">        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">MapperProperty</span><span class="p">):</span>
</span><span id="1-2089">            <span class="n">mapped_cls</span><span class="o">.</span><span class="n">__mapper__</span><span class="o">.</span><span class="n">add_property</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span id="1-2090">        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">QueryableAttribute</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value</span><span class="o">.</span><span class="n">key</span> <span class="o">!=</span> <span class="n">key</span><span class="p">:</span>
</span><span id="1-2091">            <span class="c1"># detect a QueryableAttribute that&#39;s already mapped being</span>
</span><span id="1-2092">            <span class="c1"># assigned elsewhere in userland, turn into a synonym()</span>
</span><span id="1-2093">            <span class="n">value</span> <span class="o">=</span> <span class="n">SynonymProperty</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
</span><span id="1-2094">            <span class="n">mapped_cls</span><span class="o">.</span><span class="n">__mapper__</span><span class="o">.</span><span class="n">add_property</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span id="1-2095">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-2096">            <span class="nb">type</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span id="1-2097">            <span class="n">mapped_cls</span><span class="o">.</span><span class="n">__mapper__</span><span class="o">.</span><span class="n">_expire_memoizations</span><span class="p">()</span>
</span><span id="1-2098">    <span class="k">else</span><span class="p">:</span>
</span><span id="1-2099">        <span class="nb">type</span><span class="o">.</span><span class="fm">__setattr__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
</span><span id="1-2100">
</span><span id="1-2101">
</span><span id="1-2102"><span class="k">def</span> <span class="nf">_del_attribute</span><span class="p">(</span><span class="bp">cls</span><span class="p">:</span> <span class="n">Type</span><span class="p">[</span><span class="n">Any</span><span class="p">],</span> <span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-2103">    <span class="k">if</span> <span class="p">(</span>
</span><span id="1-2104">        <span class="s2">&quot;__mapper__&quot;</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span>
</span><span id="1-2105">        <span class="ow">and</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span>
</span><span id="1-2106">        <span class="ow">and</span> <span class="ow">not</span> <span class="n">cast</span><span class="p">(</span>
</span><span id="1-2107">            <span class="s2">&quot;MappedClassProtocol[Any]&quot;</span><span class="p">,</span> <span class="bp">cls</span>
</span><span id="1-2108">        <span class="p">)</span><span class="o">.</span><span class="n">__mapper__</span><span class="o">.</span><span class="n">_dispose_called</span>
</span><span id="1-2109">    <span class="p">):</span>
</span><span id="1-2110">        <span class="n">value</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="vm">__dict__</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
</span><span id="1-2111">        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span>
</span><span id="1-2112">            <span class="n">value</span><span class="p">,</span> <span class="p">(</span><span class="n">Column</span><span class="p">,</span> <span class="n">_MapsColumns</span><span class="p">,</span> <span class="n">MapperProperty</span><span class="p">,</span> <span class="n">QueryableAttribute</span><span class="p">)</span>
</span><span id="1-2113">        <span class="p">):</span>
</span><span id="1-2114">            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span>
</span><span id="1-2115">                <span class="s2">&quot;Can&#39;t un-map individual mapped attributes on a mapped class.&quot;</span>
</span><span id="1-2116">            <span class="p">)</span>
</span><span id="1-2117">        <span class="k">else</span><span class="p">:</span>
</span><span id="1-2118">            <span class="nb">type</span><span class="o">.</span><span class="fm">__delattr__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
</span><span id="1-2119">            <span class="n">cast</span><span class="p">(</span>
</span><span id="1-2120">                <span class="s2">&quot;MappedClassProtocol[Any]&quot;</span><span class="p">,</span> <span class="bp">cls</span>
</span><span id="1-2121">            <span class="p">)</span><span class="o">.</span><span class="n">__mapper__</span><span class="o">.</span><span class="n">_expire_memoizations</span><span class="p">()</span>
</span><span id="1-2122">    <span class="k">else</span><span class="p">:</span>
</span><span id="1-2123">        <span class="nb">type</span><span class="o">.</span><span class="fm">__delattr__</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
</span><span id="1-2124">
</span><span id="1-2125">
</span><span id="1-2126"><span class="k">def</span> <span class="nf">_declarative_constructor</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-2127"><span class="w">    </span><span class="sd">&quot;&quot;&quot;A simple constructor that allows initialization from kwargs.</span>
</span><span id="1-2128">
</span><span id="1-2129"><span class="sd">    Sets attributes on the constructed instance using the names and</span>
</span><span id="1-2130"><span class="sd">    values in ``kwargs``.</span>
</span><span id="1-2131">
</span><span id="1-2132"><span class="sd">    Only keys that are present as</span>
</span><span id="1-2133"><span class="sd">    attributes of the instance&#39;s class are allowed. These could be,</span>
</span><span id="1-2134"><span class="sd">    for example, any mapped columns or relationships.</span>
</span><span id="1-2135"><span class="sd">    &quot;&quot;&quot;</span>
</span><span id="1-2136">    <span class="n">cls_</span> <span class="o">=</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
</span><span id="1-2137">    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
</span><span id="1-2138">        <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">cls_</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
</span><span id="1-2139">            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
</span><span id="1-2140">                <span class="s2">&quot;</span><span class="si">%r</span><span class="s2"> is an invalid keyword argument for </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">cls_</span><span class="o">.</span><span class="vm">__name__</span><span class="p">)</span>
</span><span id="1-2141">            <span class="p">)</span>
</span><span id="1-2142">        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
</span><span id="1-2143">
</span><span id="1-2144">
</span><span id="1-2145"><span class="n">_declarative_constructor</span><span class="o">.</span><span class="vm">__name__</span> <span class="o">=</span> <span class="s2">&quot;__init__&quot;</span>
</span><span id="1-2146">
</span><span id="1-2147">
</span><span id="1-2148"><span class="k">def</span> <span class="nf">_undefer_column_name</span><span class="p">(</span><span class="n">key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">column</span><span class="p">:</span> <span class="n">Column</span><span class="p">[</span><span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-2149">    <span class="k">if</span> <span class="n">column</span><span class="o">.</span><span class="n">key</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-2150">        <span class="n">column</span><span class="o">.</span><span class="n">key</span> <span class="o">=</span> <span class="n">key</span>
</span><span id="1-2151">    <span class="k">if</span> <span class="n">column</span><span class="o">.</span><span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
</span><span id="1-2152">        <span class="n">column</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">key</span>
</span></pre></div>
        </article>
        
        <div class="navigation flex print:hidden">
  
  
</div>
        
      </div>
    </div>
  </main>
</div>
<footer class="sy-foot">
  <div class="sy-foot-inner sy-container mx-auto">
    
    <div class="sy-foot-reserved md:flex justify-between items-center">
      <div class="sy-foot-copyright"><p>2023, Jolt Org</p>
        
        <p>
          Made with
          
          <a href="https://www.sphinx-doc.org/">Sphinx</a> and
          
          <a href="https://shibuya.lepture.com">Shibuya theme</a>.
        </p>
      </div>
      <div class="sy-foot-socials">
          <a href="https://github.com/jolt-org/advanced-alchemy" aria-label="GitHub"><i class="i-icon github"></i></a>
      </div>
    </div>
  </div>
</footer></div>
      <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js?v=e43216b9"></script>
      <script src="../../../_static/doctools.js?v=888ff710"></script>
      <script src="../../../_static/sphinx_highlight.js?v=4825356b"></script>
      <script src="../../../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../../../_static/copybutton.js?v=f281be69"></script>
      <script src="../../../_static/design-tabs.js?v=36754332"></script>
      <script src="../../../_static/shibuya.js?v=ccb09f80"></script>
    
</body>
</html>